angular.module("starter").factory("Customer",function($sbhttp,$pwaRequest,$rootScope,$session,$timeout,$injector,Loader,Modal,Dialog,Url,SB){var factory={events:[],customer:null,modal:null,login_modal:null,can_access_locked_features:!1,display_account_form:!1,login_modal_hidden_subscriber:null,is_logged_in:!1,facebook_login_enabled:!1,loginScope:null};return factory.populate=function(customer){factory.customer=customer,factory.is_logged_in=customer.is_logged_in,factory.id=customer.id,factory.can_access_locked_features=customer.can_access_locked_features,factory.can_connect_with_facebook=customer.can_connect_with_facebook,factory.is_logged_in&&$rootScope.$broadcast(SB.EVENTS.AUTH.loginSuccess),factory.saveCredentials(customer.token)},factory.setFacebookLogin=function(facebook){factory.facebook_login_enabled=!(null===facebook.id||""===facebook.id)},factory.onStatusChange=function(id,urls){factory.events[id]=urls},factory.hideModal=function(){factory.login_modal.hide()},factory.loginModal=function(scope,loginCallback,logoutCallback,registerCallback){if($rootScope.isNotAvailableOffline())return!1;var localScope=scope;return void 0===scope&&(localScope=$rootScope),factory.loginScope=localScope,localScope.card_design=!1,localScope.$on("modal.shown",function(){var loginSuccessSubscriber=localScope.$on(SB.EVENTS.AUTH.loginSuccess,function(){"function"==typeof loginCallback&&loginCallback(),$timeout(function(){factory.login_modal.hide()},600)}),logoutSuccessSubscriber=localScope.$on(SB.EVENTS.AUTH.logoutSuccess,function(){"function"==typeof logoutCallback&&logoutCallback(),$timeout(function(){factory.login_modal.hide()},600)}),registerSubscriber=localScope.$on(SB.EVENTS.AUTH.registerSuccess,function(){"function"==typeof registerCallback&&registerCallback(),$timeout(function(){factory.login_modal.hide()},600)});factory.login_modal_hidden_subscriber=localScope.$on("modal.hidden",function(){factory.login_modal_hidden_subscriber(),loginSuccessSubscriber(),logoutSuccessSubscriber(),registerSubscriber()})}),Modal.fromTemplateUrl("templates/customer/account/l1/login.html",{scope:angular.extend(localScope,{_pcustomer_close:function(){factory.login_modal.hide()},_pcustomer_login:function(data){factory.login(data)},_pcustomer_logout:function(){factory.logout()},_pcustomer_login_fb:function(){factory.facebookConnect()},_pcustomer_check_update:function(){$rootScope.checkForUpdate()},_pcustomer_register_or_save:function(data){factory.save(data)},_pcustomer_get_avatar:function(){factory.getAvatarUrl()},_pcustomer_forgotten_password:function(email){factory.forgotPassword(email)},_pcustomer_remove_card:function(){factory.removeCard()},_facebook_enabled:factory.facebook_login_enabled}),animation:"slide-in-up"}).then(function(modal){return factory.login_modal=modal,factory.login_modal.show(),modal})},factory.login=function(data){var localData=angular.extend({},data,{device_uid:$session.getDeviceUid()});Loader.show();var promise=$pwaRequest.post("customer/mobile_account_login/post",{data:localData,cache:!1});return promise.then(function(result){return factory.populate(result.customer),result},function(error){Dialog.alert("Error",error.message,"OK",-1)}).then(function(result){return Loader.hide(),result}),promise},factory.facebookConnect=function(){if(Math.ceil(Date.now()/1e3)>153342e4&&console.error("Facebook API v2.7 will shutdown 5 October 2018, please upgrade to latest API Version."),!$rootScope.isNotAvailableInOverview()){$injector.get("FacebookConnect").login()}},factory.loginWithFacebook=function(token){var data={device_id:device.uuid,token:token},promise=$pwaRequest.post("customer/mobile_account_login/loginwithfacebook",{data:data,cache:!1});return promise.then(function(result){return factory.populate(result.customer),result},function(error){return Dialog.alert("Error",error.message,"OK",-1),error}),promise},factory.register=function(data){var localData=angular.extend({},data,{device_uid:$session.getDeviceUid()});Loader.show();var promise=$pwaRequest.post("customer/mobile_account_register/post",{data:localData,cache:!1});return promise.then(function(result){return factory.populate(result.customer),result},function(error){return Dialog.alert("Error",error.message,"OK",-1),error}).then(function(result){return Loader.hide(),result}),promise},factory.forgotPassword=function(email){try{Loader.show(),factory.forgottenpassword(email).then(function(data){data&&angular.isDefined(data.message)&&(Dialog.alert("",data.message,"OK",-1),data.success&&$rootScope.$broadcast("displayLogin"))},function(data){data&&angular.isDefined(data.message)&&Dialog.alert("Error",data.message,"OK",-1)}).then(function(){Loader.hide()})}catch(e){Loader.hide()}},factory.getAvatarUrl=function(customerId,options){var myOptions=angular.isObject(options)?options:{};return Url.get("/customer/mobile_account/avatar",angular.extend({},myOptions,{customer:customerId}))+($rootScope.isOffline?"":"?"+ +new Date)},factory.save=function(data){if(!factory.isLoggedIn())return factory.register(data);Loader.show();var promise=$pwaRequest.post("customer/mobile_account_edit/post",{data:data,cache:!1});return promise.then(function(result){return factory.populate(result.customer),result},function(error){return Dialog.alert("Error",error.message,"OK",-1),error}).then(function(result){return Loader.hide(),result}),promise},factory.forgottenpassword=function(email){Loader.show();var promise=$pwaRequest.post("customer/mobile_account_forgottenpassword/post",{data:{email:email},cache:!1});return promise.then(function(data){return Loader.hide(),data}),promise},factory.logout=function(){Loader.show();var promise=$pwaRequest.get("customer/mobile_account_login/logout",{cache:!1});return promise.then(function(result){return factory.clearCredentials(),result}).then(function(result){return Loader.hide(),result}),promise},factory.removeCard=function(){Loader.show();var promise=$pwaRequest.post("mcommerce/mobile_sales_stripe/removecard",{data:{customer_id:factory.id},cache:!1});return promise.then(function(){Loader.hide()}),promise},factory.find=function(){return $pwaRequest.get("customer/mobile_account_edit/find")},factory.isLoggedIn=function(){return factory.is_logged_in},factory.saveCredentials=function(token){$session.setId(token)},factory.clearCredentials=function(){factory.customer=null,factory.can_access_locked_features=!1,factory.is_logged_in=!1,$rootScope.$broadcast(SB.EVENTS.AUTH.logoutSuccess),$session.clear()},factory});