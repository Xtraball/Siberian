angular.module("starter").controller("CustomerController",function($cordovaCamera,$ionicActionSheet,Loader,$ionicPopup,$ionicScrollDelegate,$rootScope,$scope,$timeout,$translate,Application,Customer,Dialog,FacebookConnect,HomepageLayout){angular.extend($scope,{customer:Customer.customer,card:{},is_logged_in:Customer.isLoggedIn(),app_name:Application.app_name,display_login_form:!$scope.is_logged_in&&!Customer.display_account_form,display_account_form:$scope.is_logged_in||Customer.display_account_form,can_connect_with_facebook:!!Customer.can_connect_with_facebook,page_title:$translate.instant("My account"),show_avatar:!0,avatar_loaded:!1,privacy_policy:Application.privacy_policy}),$scope.login=function(){Customer.loginModal($scope)},$scope.loginWithFacebook=function(){$rootScope.isNotAvailableInOverview()||FacebookConnect.login()},$scope.hideAvatar=function(){$scope.show_avatar=!1},$scope.avatarLoaded=function(){$scope.avatar_loaded=!0,$scope.show_avatar=!0},$scope.editAvatar=function(){var buttons=[{text:$translate.instant("Edit")}];if(null!==$scope.customer.avatar){var text="Cancel "+($scope.customer.delete_avatar?"delete":"edit");buttons.push({text:$translate.instant(text)})}else $scope.customer.is_custom_image&&buttons.push({text:$translate.instant("Delete")});var hideSheet=$ionicActionSheet.show({buttons:buttons,cancelText:$translate.instant("Cancel"),cancel:function(){hideSheet()},buttonClicked:function(index){return 0==index&&$timeout($scope.takePicture,600),1==index&&(null!=$scope.customer.avatar?($scope.customer.avatar=null,$scope.customer.delete_avatar=!1,$scope.avatar_url=Customer.getAvatarUrl($scope.customer.id)):($scope.customer.avatar=!1,$scope.customer.delete_avatar=!0,$scope.avatar_url=Customer.getAvatarUrl($scope.customer.id,{ignore_stored:!0}))),!0}})},$scope.takePicture=function(field){var gotImage=function(image_url){$scope.cropModal={original:image_url,result:null},$scope.popupShowing=!1,$ionicPopup.show({template:'<div style="position: absolute" class="cropper"><img-crop ng-if="popupShowing" image="cropModal.original" result-image="cropModal.result" area-type="square" result-image-size="256" result-image-format="image/jpeg" result-image-quality="0.9"></img-crop></div>',cssClass:"avatar-crop",scope:$scope,buttons:[{text:$translate.instant("Cancel"),type:"button-default",onTap:function(e){return!1}},{text:$translate.instant("OK"),type:"button-positive",onTap:function(e){return!0}}]}).then(function(result){result&&($scope.cropModalCtrl=null,$scope.avatar_url=$scope.cropModal.result,$scope.customer.avatar=$scope.cropModal.result,$scope.customer.delete_avatar=!1)}),$scope.popupShowing=!0},gotError=function(err){};if(Application.is_webview){var input=angular.element("<input type='file' accept='image/*'>"),selectedFile=function(evt){var file=evt.currentTarget.files[0],reader=new FileReader;reader.onload=function(evt){gotImage(evt.target.result),input.off("change",selectedFile)},reader.onerror=gotError,reader.readAsDataURL(file)};input.on("change",selectedFile),input[0].click()}else var source_type=Camera.PictureSourceType.CAMERA,hideSheet=$ionicActionSheet.show({buttons:[{text:$translate.instant("Take a picture")},{text:$translate.instant("Import from Library")}],cancelText:$translate.instant("Cancel"),cancel:function(){hideSheet()},buttonClicked:function(index){0==index&&(source_type=Camera.PictureSourceType.CAMERA),1==index&&(source_type=Camera.PictureSourceType.PHOTOLIBRARY);var options={quality:90,destinationType:Camera.DestinationType.DATA_URL,sourceType:source_type,encodingType:Camera.EncodingType.JPEG,targetWidth:256,targetHeight:256,correctOrientation:!0,popoverOptions:CameraPopoverOptions,saveToPhotoAlbum:!1};return $cordovaCamera.getPicture(options).then(function(imageData){gotImage("data:image/jpeg;base64,"+imageData)},gotError),!0}})},$scope.loadContent=function(){if($scope.is_logged_in)return $scope.displayAccountForm(),Loader.show(),$scope.customer=Customer.customer,$scope.customer.metadatas=_.isObject($scope.customer.metadatas)?$scope.customer.metadatas:{},$scope.avatar_url=Customer.getAvatarUrl($scope.customer.id),HomepageLayout.getActiveOptions().then(function(options){$scope.optional_fields={ranking:!!_.find(options,{use_ranking:"1"}),nickname:!!_.find(options,{use_nickname:"1"})},$scope.custom_fields=[],_.forEach(options,function(opt){var fields=_.get(opt,"custom_fields");_.isArray(fields)&&fields.length>0&&($scope.custom_fields.push(_.pick(opt,["name","code","custom_fields"])),_.forEach(fields,function(field){var mpath=opt.code+"."+field.key;_.set($scope.customer.metadatas,mpath,_.get($scope.customer.metadatas,mpath,field.default||null))}))}),Loader.hide()})},$scope.save=function(){$scope.is_loading=!0,Loader.show(),Customer.save($scope.customer).then(function(data){return angular.isDefined(data.message)&&Dialog.alert("",data.message,"OK",-1).then(function(){Customer.login_modal.hide()}),data},function(data){return data&&angular.isDefined(data.message)&&Dialog.alert("Error",data.message,"OK",-1),data}).then(function(){$scope.is_loading=!1,Loader.hide()})},$scope.logout=function(){Customer.logout().then(function(data){FacebookConnect.logout(),data.success&&Customer.hideModal()})},$scope.displayLoginForm=function(){$scope.display_forgot_password_form=!1,$scope.display_account_form=!1,$scope.display_privacy_policy=!1,$scope.display_login_form=!0},$rootScope.$on("displayLogin",function(){$scope.displayLoginForm()}),$scope.displayForgotPasswordForm=function(){$scope.display_login_form=!1,$scope.display_account_form=!1,$scope.display_privacy_policy=!1,$scope.display_forgot_password_form=!0},$scope.displayAccountForm=function(){$scope.display_login_form=!1,$scope.display_forgot_password_form=!1,$scope.display_privacy_policy=!1,$scope.display_account_form=!0},$scope.displayPrivacyPolicy=function(from){$scope.displayed_from=from||"",$scope.display_login_form=!1,$scope.display_forgot_password_form=!1,$scope.display_account_form=!1,$scope.display_privacy_policy=!0},$scope.scrollTop=function(){$ionicScrollDelegate.scrollTop(!1)},$scope.unloadcard=function(){Dialog.confirm("Confirmation","Do you confirm you want to remove your card?").then(function(result){result&&($scope.is_loading=!0,Loader.show(),Customer.removeCard().then(function(data){$scope.card={},$scope.customer.stripe={}},function(data){data&&angular.isDefined(data.message)&&Dialog.alert("Error",data.message,"OK",-1)}).then(function(){$scope.is_loading=!1,Loader.hide()}))})},$scope.loadContent()});