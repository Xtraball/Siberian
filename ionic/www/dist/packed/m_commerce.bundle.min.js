angular.module("starter").controller("MCommerceCartViewController",function($scope,$state,Loader,$stateParams,$translate,$timeout,Dialog,McommerceCart,Customer){$scope.is_loading=!0,$scope.points_data={use_points:!1,nb_points_used:null},McommerceCart.value_id=$stateParams.value_id,$scope.value_id=$stateParams.value_id,$scope.page_title=$translate.instant("Cart"),$scope.loadContent=function(){Loader.show("Updating price"),$scope.is_loading=!0,McommerceCart.compute().then(function(computation){$scope.computation=computation}).then(function(){$scope.computation=angular.isObject($scope.computation)?$scope.computation:{},McommerceCart.find().then(function(data){0===data.cart.tip&&(data.cart.tip=""),angular.isObject($scope.cart)&&(!angular.isString(data.cart.discount_code)||data.cart.discount_code.trim().length<1)&&(data.cart.discount_code=$scope.cart.discount_code),$scope.cart=data.cart,$scope.cart.discount_message=$scope.computation.message,$scope.cart.discount=$scope.computation.discount,$scope.nb_stores=data.nb_stores,$scope.cart.lines.length>0&&($scope.right_button={action:$scope.proceed,label:$translate.instant("Proceed")})}).then(function(){Customer.find().then(function(data){$scope.cart.customer_fidelity_points=data.metadatas&&data.metadatas.fidelity_points?data.metadatas.fidelity_points.points:null,$scope.points_data.use_points||($scope.points_data.nb_points_used=$scope.cart.customer_fidelity_points),$scope.updateEstimatedDiscount()}).then(function(){Loader.hide(),$scope.is_loading=!1})})})},$scope.updateEstimatedDiscount=function(){$scope.points_data.nb_points_used>0&&($scope.cart.estimated_fidelity_discount=Math.round($scope.points_data.nb_points_used*$scope.cart.fidelity_rate*100)/100+" "+$scope.cart.currency_code)},$scope.useFidelityChange=function(){$scope.points_data.use_points&&($scope.cart.discount_code=null,$scope.updateTipAndDiscount())},$scope._update=_.debounce(function(){Loader.show("Updating price"),$scope.is_loading=!0,McommerceCart.adddiscount($scope.cart.discount_code,!0).then(function(){McommerceCart.addTip($scope.cart).then(function(data){data.success&&angular.isDefined(data.message)&&Dialog.alert("",data.message,"OK")},function(data){data&&angular.isDefined(data.message)&&Dialog.alert("",data.message,"OK")}).then(function(){$scope.loadContent(),Loader.hide(),$scope.is_loading=!1})},function(data){data&&angular.isDefined(data.message)&&Dialog.alert("",data.message,"OK")}).then(function(){Loader.hide(),$scope.is_loading=!1})},900),$scope.updateTipAndDiscount=function(){$scope._update()},$scope.proceed=function(){Loader.show();var gotToNext=function(){$scope.cart.valid?$scope.nb_stores>1?$scope.goToStoreChoice():$scope.goToOverview():$scope.cartIdInvalid()};$scope.cart&&$scope.cart.discount_code?McommerceCart.adddiscount($scope.cart.discount_code,!0).then(function(data){data&&data.success?gotToNext():data&&data.message?Dialog.alert("",data.message,"OK"):Dialog.alert("","Unexpected Error","OK")},function(resp){var data=resp.data;data&&angular.isDefined(data.message)&&Dialog.alert("",data.message,"OK")}).then(function(){Loader.hide()}):$scope.points_data.use_points?$scope.points_data.nb_points_used>0&&($scope.points_data.nb_points_used<=$scope.cart.customer_fidelity_points?McommerceCart.useFidelityPoints($scope.points_data.nb_points_used).then(function(data){gotToNext()},function(data){Dialog.alert("",data.message,"OK")}).then(function(){Loader.hide()}):Dialog.alert("","You don't have enough points","OK")):McommerceCart.removeAllDiscount().then(function(data){gotToNext()},function(data){Dialog.alert("",data.message,"OK")}).then(function(){Loader.hide()})},$scope.cartIdInvalid=function(){Dialog.alert("",$scope.cart.valid_message,"OK")},$scope.goToStoreChoice=function(){$state.go("mcommerce-sales-store",{value_id:$scope.value_id})},$scope.goToOverview=function(){$scope.is_loading||$state.go("mcommerce-sales-customer",{value_id:$scope.value_id})},$scope.goToCategories=function(){$state.go("mcommerce-category-list",{value_id:$scope.value_id})},$scope.removeLine=function(line){Loader.show("Updating price"),$scope.is_loading=!0,McommerceCart.deleteLine(line.id).then(function(data){if(data.success){if(angular.isDefined(data.message))return void Dialog.alert("",data.message,"OK");$scope.loadContent()}},function(data){data&&angular.isDefined(data.message)&&Dialog.alert("",data.message,"OK")})},$scope.changeQuantity=function(qty,params){Loader.show("Updating price"),$scope.is_loading=!0;var localLine=angular.copy(params.line);return localLine.qty=angular.copy(qty),McommerceCart.modifyLine(localLine).then(function(data){return $scope.cart.formattedSubtotalExclTax=data.cart.formattedSubtotalExclTax,$scope.cart.formattedDeliveryCost=data.cart.formattedDeliveryCost,$scope.cart.formattedTotalExclTax=data.cart.formattedTotalExclTax,$scope.cart.formattedTotalTax=data.cart.formattedTotalTax,$scope.cart.formattedTotal=data.cart.formattedTotal,$scope.cart.deliveryCost=data.cart.deliveryCost,$scope.cart.valid=data.cart.valid,data},function(data){data&&angular.isDefined(data.message)&&($scope.message=new Message,$scope.message.isError(!0).setText(data.message).show())}).then(function(data){var scopeLineIndex=_.findIndex($scope.cart.lines,function(line){return line.id==data.line.id});return $timeout(function(){$scope.cart.lines[scopeLineIndex]=data.line,$scope.cart.lines[scopeLineIndex].qty=data.line.qty,Loader.hide(),$scope.is_loading=!1},500),data}).catch(function(){Loader.hide(),$scope.is_loading=!1})},$scope.loadContent()}),angular.module("starter").controller("MCommerceListController",function(Loader,$location,$scope,$state,$stateParams,McommerceCategory,Customer){$scope.is_loading=!0,Loader.show(),$scope.factory=McommerceCategory,$scope.collection=[],$scope.collection_is_empty=!0,McommerceCategory.value_id=$stateParams.value_id,McommerceCategory.category_id=$stateParams.category_id,$scope.value_id=$stateParams.value_id,$scope.use_button_header=!1,Customer.isLoggedIn()&&!$stateParams.category_id&&($scope.use_button_header=!0),$scope.loadContent=function(){McommerceCategory.findAll().then(function(data){$scope.show_search=data.show_search,$scope.collection=data.collection,$scope.collection_is_empty=$scope.collection.length>0,$scope.cover=data.cover,$scope.page_title=data.page_title}).then(function(){$scope.is_loading=!1,Loader.hide()})},$scope.openCart=function(){$scope.is_loading||$state.go("mcommerce-cart-view",{value_id:$scope.value_id})},$scope.openHistory=function(){$scope.is_loading||$state.go("mcommerce-sales-history",{value_id:$scope.value_id})},$scope.use_button_header||($scope.right_button={action:$scope.openCart,icon:"ion-ios-cart"}),$scope.showItem=function(item){$location.path(item.url)},$scope.loadContent()}).controller("MCommerceRedirectController",function($ionicHistory,$scope,$state,$stateParams,HomepageLayout){angular.extend($scope,{value_id:$stateParams.value_id,layout:HomepageLayout}),$state.go("home").then(function(){$scope.layout.properties.options.autoSelectFirst&&$ionicHistory.nextViewOptions({historyRoot:!0,disableAnimate:!1}),$state.go("mcommerce-category-list",{value_id:$scope.value_id})})}),angular.module("starter").controller("MCommerceProductViewController",function($cordovaSocialSharing,Loader,$log,$state,$stateParams,$scope,$translate,Analytics,Application,Dialog,McommerceCategory,McommerceCart,McommerceProduct,$rootScope){McommerceProduct.value_id=$stateParams.value_id,McommerceCart.value_id=$stateParams.value_id,$scope.value_id=$stateParams.value_id,$scope.product_id=$stateParams.product_id,$scope.social_sharing_active=!1,$scope.product_quantity=1,$scope.selected_format={id:null},$scope.list_qty=[1,2,3,4,5,6,7,8,9,10],$scope.loadContent=function(){$scope.is_loading=!0,Loader.show(),McommerceProduct.find($scope.product_id).then(function(data){$scope.product=data.product,Analytics.storeProductOpening($scope.product),$scope.social_sharing_active=$scope.product.social_sharing_active&&$rootScope.isNativeApp,$scope.share=function(){if(!$scope.is_sharing){$scope.is_sharing=!0;var app_name=Application.app_name,link=DOMAIN+"/application/device/downloadapp/app_id/"+Application.app_id,file=$scope.product.picture[0]&&$scope.product.picture[0].url?$scope.product.picture[0].url:"",content=$scope.product.name,message=$translate.instant("Hi. I just found: $1 in the $2 app.").replace("$1",content).replace("$2",app_name);$cordovaSocialSharing.share(message,"",file,link).then(function(result){$log.debug("MCommerce::product.js","social sharing success"),$scope.is_sharing=!1},function(err){$log.debug("MCommerce::product.js",err),$scope.is_sharing=!1})}},$scope.product.formatGroups.length>0&&($scope.selected_format.id=$scope.product.formatGroups[0].id),$scope.page_title=data.page_title}).then(function(){$scope.is_loading=!1,Loader.hide()})},$scope.addProduct=function(){$scope.is_loading=!0,Loader.show();var errors=[],postParameters={product_id:$scope.product_id,category_id:McommerceCategory.category_id,qty:$scope.product_quantity,options:$scope.product.optionsGroups.reduce(function(options,optionsGroup){return optionsGroup.required&&!optionsGroup.selectedOptionId&&errors.push($translate.instant("Option $1 is required.").replace("$1",optionsGroup.title)),(optionsGroup.selectedQuantity<=0||!optionsGroup.selectedQuantity)&&errors.push($translate.instant("Quantity for option $1 is required.").replace("$1",optionsGroup.title)),options[optionsGroup.id]={option_id:optionsGroup.selectedOptionId,qty:optionsGroup.selectedQuantity},options},{}),choices:$scope.product.choicesGroups.reduce(function(choices,choicesGroup){var selected=[];return choicesGroup.options.forEach(function(e,i){e.selected&&selected.push(e.id)}),choicesGroup.required&&!selected.length&&errors.push($translate.instant("Option $1 is required.").replace("$1",choicesGroup.title)),choices[choicesGroup.id]={selected_options:selected},choices},{}),selected_format:$scope.selected_format.id};if(errors.length<=0)McommerceCart.addProduct(postParameters).then(function(data){data.success&&($scope.is_loading=!1,Loader.hide(),$scope.openCart())},function(data){data&&angular.isDefined(data.message)&&Dialog.alert("",data.message,$translate.instant("OK")),$scope.is_loading=!1,$scope.product_quantity=1,$scope.selected_format={id:null},$scope.product.optionsGroups.forEach(function(option){option.selectedOptionId=null,option.selectedQuantity=1}),$scope.product.choicesGroups.forEach(function(choice){choice.options.forEach(function(option){option.selected=!1})}),Loader.hide()});else{var message=errors.join("<br/>");Dialog.alert("",message,"OK"),$scope.is_loading=!1,Loader.hide()}},$scope.openCart=function(){$scope.is_loading||$state.go("mcommerce-cart-view",{value_id:$scope.value_id})},$scope.changeQuantity=function(qty){qty&&($scope.product_quantity=qty)},$scope.right_button={action:$scope.openCart,icon:"ion-ios-cart"},$scope.loadContent()}),angular.module("starter").controller("MCommerceSalesConfirmationViewController",function($ionicPopup,Loader,$location,$rootScope,$scope,$state,$stateParams,$timeout,$translate,$window,Analytics,Application,Customer,Dialog,McommerceCart,McommerceSalesPayment){angular.extend($scope,{is_loading:!0,page_title:$translate.instant("Review"),value_id:$stateParams.value_id}),Loader.show(),McommerceCart.value_id=$stateParams.value_id,McommerceSalesPayment.value_id=$stateParams.value_id,$scope.loadContent=function(){$scope.guest_mode=Customer.guest_mode,McommerceCart.compute().then(function(computation){McommerceCart.find().then(function(data){$scope.cart=data.cart,$scope.cart.discount_message=computation.message,$scope.cart.discount=computation.discount,McommerceSalesPayment.findOnlinePaymentUrl().then(function(onlinePaymentData){$scope.onlinePaymentUrl=onlinePaymentData.url,$scope.form_url=onlinePaymentData.form_url,$scope.right_button={action:$scope.validate,label:$translate.instant("Validate")}}).then(function(){Loader.hide(),computation&&angular.isDefined(computation.message)&&computation.show_message&&Dialog.alert("",computation.message,"OK"),$scope.is_loading=!1})},function(){$scope.is_loading=!1,Loader.hide()})},function(){Loader.hide(),$scope.is_loading=!1})},$scope.validate=function(){if(McommerceSalesPayment.notes=$scope.notes||"",sessionStorage.setItem("mcommerce-notes",$scope.notes||""),$scope.onlinePaymentUrl)if(isNativeApp){var browser=$window.open($scope.onlinePaymentUrl,$rootScope.getTargetForLink(),"location=yes"),nextState="mcommerce-sales-error",stepNext=function(){browser.close(),$state.go(nextState,{value_id:$stateParams.value_id})};browser.addEventListener("loadstart",function(event){switch(!0){case/(mcommerce\/mobile_sales_success)/.test(event.url):nextState="mcommerce-sales-success",stepNext();break;case/(mcommerce\/mobile_sales_cancel)/.test(event.url):nextState="mcommerce-sales-confirmation-cancel",stepNext();break;case/(mcommerce\/mobile_sales_error)/.test(event.url):nextState="mcommerce-sales-error",stepNext()}})}else $window.location=$scope.onlinePaymentUrl;else if($scope.form_url)$location.path($scope.form_url);else{if($scope.is_loading)return;$scope.is_loading=!0,Loader.show(),McommerceSalesPayment.validatePayment().then(function(data){var products=[];angular.forEach($scope.cart.lines,function(value,key){var product=value.product;product.category_id=value.category_id,product.quantity=value.qty,products.push(product)}),Analytics.storeProductSold(products),$state.go("mcommerce-sales-success",{value_id:$stateParams.value_id})},function(data){Dialog.alert("",data.message,"OK")}).then(function(){$scope.is_loading=!1,Loader.hide()})}},$scope.loadContent()}),angular.module("starter").controller("MCommerceSalesConfirmationCancelController",function($state,$stateParams,$translate,Dialog){Dialog.alert("","The payment has been cancelled, something wrong happened? Feel free to contact us.","OK").then(function(){$state.go("mcommerce-sales-confirmation",{value_id:$stateParams.value_id})})}),angular.module("starter").controller("MCommerceSalesCustomerViewController",function(Loader,$state,$stateParams,$scope,$translate,$rootScope,McommerceCart,McommerceSalesCustomer,Customer,Dialog,SB){Customer.onStatusChange("category",[]),$scope.hasguestmode=!1,$scope.customer_login=function(){Customer.display_account_form=!1,Customer.loginModal($scope)},$scope.customer_signup=function(){Customer.display_account_form=!0,Customer.loginModal($scope)},$scope.customer_guestmode=function(){Loader.show();var guestmail="guest"+Date.now()+parseInt(1e3*Math.random(),10)+"@guest.com";Customer.register({civility:"m",firstname:"Guest",lastname:"Guest",email:guestmail,password:parseInt(1e10*Math.random(),10),privacy_policy:!0}).then(function(){$scope.is_logged_in=!0,Customer.guest_mode=!0,$scope.loadContent()}).then(function(){$scope.is_loading=!1,Loader.hide()})},$scope.$on(SB.EVENTS.AUTH.loginSuccess,function(){$scope.is_logged_in=!0,$scope.loadContent()}),$scope.$on(SB.EVENTS.AUTH.logoutSuccess,function(){$scope.is_logged_in=!1}),$scope.is_loading=!0,Loader.show(),$scope.is_logged_in=Customer.isLoggedIn(),McommerceCart.value_id=$stateParams.value_id,McommerceSalesCustomer.value_id=$stateParams.value_id,$scope.value_id=$stateParams.value_id,$scope.page_title=$translate.instant("My information"),$scope.loadContent=function(){McommerceSalesCustomer.hasGuestMode().then(function(dataGuestMode){dataGuestMode.success&&dataGuestMode.activated&&($scope.hasguestmode=!0),McommerceSalesCustomer.find().then(function(data){$scope.customer=data.customer,$scope.customer&&$scope.customer.hasOwnProperty("metadatas")&&$scope.customer.metadatas.birthday&&($scope.customer.metadatas.birthday=new Date($scope.customer.metadatas.birthday)),$scope.settings=data.settings}).then(function(){$scope.is_loading=!1,Loader.hide()})},function(data){data&&angular.isDefined(data.message)&&Dialog.alert("Error",data.message,"OK")}).then(function(){$scope.is_loading=!1,Loader.hide()})},$scope.goToDeliveryPage=function(){$state.go("mcommerce-sales-delivery",{value_id:$stateParams.value_id})},$scope.updateCustomerInfos=function(){$rootScope.loginFeature=!0,$rootScope.loginFeatureBack=!1,$scope.is_loading=!0,Loader.show(),McommerceSalesCustomer.updateCustomerInfos({customer:$scope.customer}).then(function(data){$scope.customer=data.customer,Customer.save($scope.customer).then(function(data){angular.isDefined(data.message),$scope.goToDeliveryPage()},function(data){data&&angular.isDefined(data.message)&&Dialog.alert("Error",data.message,"OK")}).then(function(){$scope.is_loading=!1,Loader.hide()})},function(data){$scope.is_loading=!1,Loader.hide(),data&&angular.isDefined(data.message)&&Dialog.alert("Error",data.message,"OK")})},$scope.right_button={action:$scope.updateCustomerInfos,label:$translate.instant("Next")},$scope.loadContent()}),angular.module("starter").controller("MCommerceSalesDeliveryViewController",function(Loader,$scope,$stateParams,$state,$translate,McommerceCart,McommerceSalesDelivery,Dialog){$scope.page_title=$translate.instant("Delivery"),McommerceCart.value_id=$stateParams.value_id,McommerceSalesDelivery.value_id=$stateParams.value_id,$scope.value_id=$stateParams.value_id,$scope.clients_calculate_change_form_is_visible=!1,$scope.loadContent=function(){$scope.is_loading=!0,Loader.show(),McommerceCart.find().then(function(data){$scope.cart=data.cart,$scope.cart.delivery_method_extra_client_amount=$scope.cart.paid_amount?parseFloat($scope.cart.paid_amount):$scope.cart.total,$scope.cart.delivery_method_extra_amount_due=$scope.cart.delivery_amount_due?parseFloat($scope.cart.delivery_amount_due):0,$scope.calculateAmountDue(),McommerceSalesDelivery.findStore().then(function(data){$scope.clients_calculate_change_form_is_visible=data.clients_calculate_change,$scope.selectedStore=data.store}).then(function(){$scope.is_loading=!1,Loader.hide()})},function(){$scope.is_loading=!1,Loader.hide()})},$scope.selectDeliveryMethod=function(cart,delivery_method){var tmp_total_with_fees=cart.base_total_without_fees+delivery_method.price;cart.total=parseFloat(tmp_total_with_fees==cart.total||cart.deliveryCost?cart.total:tmp_total_with_fees),cart.delivery_method_extra_client_amount=cart.total,cart.deliveryMethodId=delivery_method.id,$scope.clients_calculate_change_form_is_visible="home_delivery"==delivery_method.code&&$scope.selectedStore.clients_calculate_change,$scope.cart.delivery_method_extra_amount_due=0},$scope.calculateAmountDue=function(){var price=parseFloat($scope.cart.delivery_method_extra_client_amount);if(isNaN(price)||price<$scope.cart.total)return isNaN(price)&&($scope.cart.delivery_method_extra_client_amount=""),void($scope.cart.delivery_method_extra_amount_due=null);$scope.cart.delivery_method_extra_amount_due=(price-$scope.cart.total).toFixed(2),$scope.cart.total=$scope.cart.total},$scope.updateDeliveryInfos=function(){if(null==$scope.cart.delivery_method_extra_amount_due&&Dialog.alert("","Remaining due is incorrect.","OK").then(function(){}),$scope.cart.deliveryMethodId||Dialog.alert("","You have to choose a delivery method.","OK").then(function(){}),!$scope.is_loading){$scope.is_loading=!0,Loader.show();var postParameters={delivery_method_id:$scope.cart.deliveryMethodId,paid_amount:$scope.clients_calculate_change_form_is_visible?$scope.cart.delivery_method_extra_client_amount:null,store_id:$scope.selectedStore.id};McommerceSalesDelivery.updateDeliveryInfos(postParameters).then(function(data){$scope.goToPaymentPage()},function(data){data&&angular.isDefined(data.message)&&Dialog.alert("",data.message,"OK")}).then(function(){$scope.is_loading=!1,Loader.hide()})}},$scope.goToPaymentPage=function(){$state.go("mcommerce-sales-payment",{value_id:$stateParams.value_id})},$scope.right_button={action:$scope.updateDeliveryInfos,label:$translate.instant("Next")},$scope.loadContent()}),angular.module("starter").controller("MCommerceSalesErrorViewController",function($scope,$state,$stateParams,$timeout){$scope.value_id=$stateParams.value_id,$timeout(function(){$state.go("mcommerce-redirect",{value_id:$scope.value_id})},4e3)}),angular.module("starter").controller("MCommerceSalesHistoryViewController",function(Loader,$scope,$state,$stateParams,$translate,McommerceSalesCustomer){$scope.value_id=$stateParams.value_id,$scope.page_title=$translate.instant("Order history"),$scope.showLoader=function(){Loader.show()},$scope.orders=[],$scope.offset=0,$scope.can_load_older_posts=!0,McommerceSalesCustomer.value_id=$stateParams.value_id,$scope.loadContent=function(){$scope.showLoader(),McommerceSalesCustomer.getOrderHistory($scope.offset).then(function(data){return data.orders?($scope.orders=$scope.orders.concat(data.orders),$scope.offset+=data.orders.length,data.orders.length<=0&&($scope.can_load_older_posts=!1),!0):($scope.orders=[],!1)}).then(function(refresh){refresh&&$scope.$broadcast("scroll.infiniteScrollComplete"),Loader.hide()})},$scope.loadContent(),$scope.showDetails=function(order_id){$state.go("mcommerce-sales-history-details",{value_id:$scope.value_id,order_id:order_id})},$scope.loadMore=function(){$scope.loadContent()}}).controller("MCommerceSalesHistoryDetailsController",function(Loader,$scope,$stateParams,$translate,McommerceSalesCustomer){$scope.value_id=$stateParams.value_id,$scope.page_title=$translate.instant("Order details"),$scope.order_id=$stateParams.order_id,Loader.show(),McommerceSalesCustomer.value_id=$stateParams.value_id,$scope.loadContent=function(){McommerceSalesCustomer.getOrderDetails($scope.order_id).then(function(data){$scope.order=data.order}).then(function(){Loader.hide()})},$scope.loadContent()}),angular.module("starter").controller("MCommerceSalesPaymentViewController",function(Loader,$scope,$state,$stateParams,$translate,McommerceCart,McommerceSalesPayment,Dialog){$scope.page_title=$translate.instant("Payment"),McommerceCart.value_id=$stateParams.value_id,McommerceSalesPayment.value_id=$stateParams.value_id,$scope.value_id=$stateParams.value_id,$scope.loadContent=function(){Loader.show(),McommerceCart.find().then(function(data){$scope.cart=data.cart,McommerceSalesPayment.findPaymentMethods().then(function(resultMethods){$scope.paymentMethods=resultMethods.paymentMethods,$scope.paymentMethodId=resultMethods.paymentMethods.reduce(function(paymentMethodId,paymentMethod){return $scope.cart.paymentMethodId===paymentMethod.id?paymentMethod.id:paymentMethodId},null),1===$scope.paymentMethods.length&&"free"===$scope.paymentMethods[0].code&&($scope.cart.paymentMethodId=$scope.paymentMethods[0].id,$scope.updatePaymentInfos())}).then(function(){$scope.is_loading=!1,Loader.hide()})},function(){$scope.is_loading=!1,Loader.hide()})},$scope.updatePaymentInfos=function(){if(!$scope.is_loading){$scope.is_loading=!0,Loader.show();var postParameters={payment_method_id:$scope.cart.paymentMethodId};McommerceSalesPayment.updatePaymentInfos(postParameters).then(function(data){$scope.goToConfirmationPage()},function(data){data&&angular.isDefined(data.message)&&Dialog.alert("",data.message,"OK")}).then(function(){$scope.is_loading=!1,Loader.hide()})}},$scope.goToConfirmationPage=function(){$scope.cart.paymentMethodId?$state.go("mcommerce-sales-confirmation",{value_id:$stateParams.value_id}):Dialog.alert("","Please choose a payment method.","OK")},$scope.right_button={action:$scope.updatePaymentInfos,label:$translate.instant("Next")},$scope.loadContent()}),angular.module("starter").controller("MCommerceSalesStoreChoiceController",function(Loader,$scope,$state,$stateParams,$translate,Dialog,McommerceSalesStorechoice){$scope.value_id=$stateParams.value_id,McommerceSalesStorechoice.value_id=$stateParams.value_id,$scope.selected_store={id:null},$scope.loadContent=function(){$scope.is_loading=!0,Loader.show(),McommerceSalesStorechoice.find().then(function(data){$scope.stores=data.stores,$scope.cart_amount=data.cart_amount,$scope.selected_store.id=data.store_id,$scope.selected_store.id&&$scope.chooseStore()}).then(function(){$scope.is_loading=!1,Loader.hide()})},$scope.chooseStore=function(){$scope.selected_store.id&&($scope.min_amount=0,angular.forEach($scope.stores,function(store){store.id==$scope.selected_store.id&&($scope.min_amount=store.min_amount,$scope.error_message=store.error_message)}),$scope.min_amount<=$scope.cart_amount?($scope.is_loading=!0,Loader.show(),McommerceSalesStorechoice.update($scope.selected_store.id).then(function(data){data.store_id&&$scope.showNextButton()}).then(function(){$scope.is_loading=!1,Loader.hide()})):(Dialog.alert("",$scope.error_message,"OK"),$scope.hideNextButton()))},$scope.goToOverview=function(){$scope.is_loading||$state.go("mcommerce-sales-customer",{value_id:$scope.value_id})},$scope.showNextButton=function(){$scope.right_button={action:$scope.goToOverview,label:$translate.instant("Proceed")}},$scope.hideNextButton=function(){$scope.right_button={action:null,label:""}},$scope.loadContent()}),angular.module("starter").controller("MCommerceSalesStripeViewController",function(Loader,$scope,$state,$stateParams,$timeout,$translate,Customer,McommerceStripe,Dialog){if($scope.is_loading=!0,Loader.show(),$scope.value_id=$stateParams.value_id,McommerceStripe.value_id=$stateParams.value_id,$scope.card={},$scope.payment={},$scope.payment.save_card=!1,$scope.payment.use_stored_card=!1,$scope.loadContent=function(){$scope.guest_mode=Customer.guest_mode;var cust_id=null;Customer.isLoggedIn()&&(cust_id=Customer.id),$scope.payment.save_card=!1,McommerceStripe.find(cust_id).then(function(data){Stripe.setPublishableKey(data.publishable_key),$scope.cart_total=data.total,data.card&&data.card.exp_year&&($scope.card=data.card,$scope.payment.use_stored_card=!0)}).then(function(){$scope.is_loading=!1,Loader.hide()})},"undefined"==typeof Stripe){var stripeJS=document.createElement("script");stripeJS.type="text/javascript",stripeJS.src="https://js.stripe.com/v2/",stripeJS.onload=function(){$scope.loadContent()},document.body.appendChild(stripeJS)}else $scope.loadContent();$scope.unloadcard=function(){Dialog.confirm("Confirmation","Do you confirm you want to remove your card?",["Yes","No"]).then(function(result){result&&($scope.is_loading=!0,Loader.show(),McommerceStripe.removeCard(Customer.id).then(function(data){$scope.oldcard=$scope.card,$scope.card={},$scope.payment.use_stored_card=!1}).then(function(){$scope.is_loading=!1,Loader.hide()}))})},$scope.process=function(){$scope.is_loading||($scope.is_loading=!0,Loader.show(),$scope.payment.use_stored_card?_process():Stripe.card.createToken($scope.card,function(status,response){_stripeResponseHandler(status,response)}))};var _stripeResponseHandler=function(status,response){$timeout(function(){response.error?(Dialog.alert("",response.error.message,"OK"),$scope.is_loading=!1,Loader.hide()):($scope.card={token:response.id,last4:response.card.last4,brand:response.card.brand,exp_month:response.card.exp_month,exp_year:response.card.exp_year,exp:0|Math.round(+new Date(new Date(response.card.exp_year,response.card.exp_month,1)-1)/1e3)},_process())})},_process=function(){var data={token:$scope.card.token,use_stored_card:$scope.payment.use_stored_card,save_card:$scope.payment.save_card,customer_id:Customer.id||null};McommerceStripe.process(data).then(function(res){res?$state.go("mcommerce-sales-success",{value_id:$stateParams.value_id}):Dialog.alert("Error","Unexpected error","OK")},function(err){Dialog.alert("Error","Unexpected error","OK")}).then(function(){$scope.is_loading=!1,Loader.hide()})};$scope.right_button={action:$scope.process,label:$translate.instant("Pay")}}),angular.module("starter").controller("MCommerceSalesSuccessViewController",function($scope,$state,$stateParams,$timeout,Customer){$scope.value_id=$stateParams.value_id,Customer.guest_mode&&(Customer.guest_mode=!1,Customer.logout()),$timeout(function(){$state.go("mcommerce-redirect",{value_id:$scope.value_id})},3e3)}),angular.module("starter").factory("McommerceCart",function($pwaRequest,$session){var factory={value_id:null,find:function(){return this.value_id?$pwaRequest.get("mcommerce/mobile_cart/find",{urlParams:{value_id:this.value_id},cache:!1}):$pwaRequest.reject("[McommerceCart::find] missing value_id.")},addProduct:function(form){return this.value_id?$pwaRequest.post("mcommerce/mobile_cart/add",{urlParams:{value_id:this.value_id},data:{form:form}}):$pwaRequest.reject("[McommerceCart::addProduct] missing value_id.")},adddiscount:function(discount_code,use_clean_code){return this.value_id?void 0===discount_code?$pwaRequest.resolve({success:!0}):0!==discount_code.length||use_clean_code?$pwaRequest.post("mcommerce/mobile_cart/adddiscount",{urlParams:{value_id:this.value_id},data:{discount_code:discount_code,customer_uuid:$session.getDeviceUid()}}):$pwaRequest.resolve({success:!0}):use_clean_code?$pwaRequest.reject("[McommerceCart::adddiscount] missing value_id."):$pwaRequest.resolve({success:!1})},addTip:function(cart){return this.value_id?$pwaRequest.post("mcommerce/mobile_cart/addtip",{urlParams:{value_id:this.value_id},data:{tip:cart.tip?cart.tip:0}}):$pwaRequest.reject("[McommerceCart::addTip] missing value_id.")},compute:function(){return this.value_id?$pwaRequest.post("mcommerce/mobile_cart/compute",{urlParams:{value_id:this.value_id,customer_uuid:$session.getDeviceUid()}}):$pwaRequest.reject("[McommerceCart::compute] missing value_id.")},deleteLine:function(line_id){return this.value_id&&line_id?$pwaRequest.get("mcommerce/mobile_cart/delete",{urlParams:{value_id:this.value_id,line_id:line_id}}):$pwaRequest.reject("[McommerceCart::deleteLine] missing value_id or line_id.")},modifyLine:function(line){return this.value_id?$pwaRequest.post("mcommerce/mobile_cart/modify",{data:{line_id:line.id,qty:line.qty,format:line.format}}):$pwaRequest.reject("[McommerceCart::modifyLine] missing value_id.")},useFidelityPoints:function(points){return this.value_id?$pwaRequest.post("mcommerce/mobile_cart/usefidelitypointsforcart",{data:{points:points}}):$pwaRequest.reject("[McommerceCart::useFidelityPoints] missing value_id.")},removeAllDiscount:function(){return this.value_id?$pwaRequest.post("mcommerce/mobile_cart/removealldiscount"):$pwaRequest.reject("[McommerceCart::removeAllDiscount] missing value_id.")}};return factory}),angular.module("starter").factory("McommerceCategory",function($pwaRequest){var factory={value_id:null,category_id:null,findAll:function(offset){return this.value_id?$pwaRequest.get("mcommerce/mobile_category/findall",{urlParams:{value_id:this.value_id,category_id:this.category_id,offset:offset}}).then(function(data){return data.displayed_per_page&&(factory.displayed_per_page=data.displayed_per_page),data}):$pwaRequest.reject("[McommerceCategory::findAll] missing value_id.")}};return factory}),angular.module("starter").factory("McommerceProduct",function($pwaRequest){var factory={value_id:null,find:function(product_id){return this.value_id?$pwaRequest.get("mcommerce/mobile_product/find",{urlParams:{value_id:this.value_id,product_id:product_id}}):$pwaRequest.reject("[McommerceProduct::find] missing value_id.")}};return factory}),angular.module("starter").factory("McommerceSalesCustomer",function($pwaRequest){var factory={value_id:null,updateCustomerInfos:function(form){return this.value_id?$pwaRequest.post("mcommerce/mobile_sales_customer/update",{urlParams:{value_id:this.value_id},data:{form:form,option_value_id:this.value_id}}):$pwaRequest.reject("[McommerceSalesCustomer::updateCustomerInfos] missing value_id.")},find:function(){return this.value_id?$pwaRequest.get("mcommerce/mobile_sales_customer/find",{urlParams:{value_id:this.value_id},cache:!1}):$pwaRequest.reject("[McommerceSalesCustomer::find] missing value_id.")},hasGuestMode:function(){return this.value_id?$pwaRequest.get("mcommerce/mobile_sales_customer/hasguestmode",{urlParams:{value_id:this.value_id},cache:!1}):$pwaRequest.reject("[McommerceSalesCustomer::hasGuestMode] missing value_id.")},getOrderHistory:function(offset){return this.value_id?$pwaRequest.get("mcommerce/mobile_sales_customer/getorders",{urlParams:{value_id:this.value_id,offset:offset},cache:!1}):$pwaRequest.reject("[McommerceSalesCustomer::getOrderHistory] missing value_id.")},getOrderDetails:function(order_id){return this.value_id?$pwaRequest.get("mcommerce/mobile_sales_customer/getorderdetails",{urlParams:{value_id:this.value_id,order_id:order_id},cache:!1}):$pwaRequest.reject("[McommerceSalesCustomer::getOrderDetails] missing value_id.")}};return factory}),angular.module("starter").factory("McommerceSalesDelivery",function($pwaRequest){var factory={value_id:null,findStore:function(){return this.value_id?$pwaRequest.get("mcommerce/mobile_sales_delivery/findstore",{urlParams:{value_id:this.value_id},cache:!1}):$pwaRequest.reject("[McommerceSalesDelivery::findStore] missing value_id.")},updateDeliveryInfos:function(form){return this.value_id?$pwaRequest.post("mcommerce/mobile_sales_delivery/update",{urlParams:{value_id:this.value_id},data:{form:form}}):$pwaRequest.reject("[McommerceSalesDelivery::updateDeliveryInfos] missing value_id.")}};return factory}),angular.module("starter").factory("McommerceSalesPayment",function($pwaRequest,$session){var factory={value_id:null,notes:"",findPaymentMethods:function(){return this.value_id?$pwaRequest.get("mcommerce/mobile_sales_payment/findpaymentmethods",{urlParams:{value_id:this.value_id},cache:!1}):$pwaRequest.reject("[McommerceSalesPayment::findPaymentMethods] missing value_id.")},findOnlinePaymentUrl:function(){return this.value_id?$pwaRequest.get("mcommerce/mobile_sales_payment/findonlinepaymenturl",{urlParams:{value_id:this.value_id},cache:!1}):$pwaRequest.reject("[McommerceSalesPayment::findOnlinePaymentUrl] missing value_id.")},updatePaymentInfos:function(form){return this.value_id?$pwaRequest.post("mcommerce/mobile_sales_payment/update",{urlParams:{value_id:this.value_id},data:{form:form}}):$pwaRequest.reject("[McommerceSalesPayment::updatePaymentInfos] missing value_id.")},validatePayment:function(){return this.value_id?$pwaRequest.post("mcommerce/mobile_sales_payment/validatepayment",{urlParams:{value_id:this.value_id},data:{validate_payment:1,customer_uuid:$session.getDeviceUid(),notes:factory.notes||""}}):$pwaRequest.reject("[McommerceSalesPayment::validatePayment] missing value_id.")}};return factory}),angular.module("starter").factory("McommerceSalesStorechoice",function($pwaRequest){var factory={value_id:null,find:function(){return this.value_id?$pwaRequest.get("mcommerce/mobile_sales_storechoice/find",{urlParams:{value_id:this.value_id},cache:!1}):$pwaRequest.reject("[McommerceSalesStorechoice::find] missing value_id.")},update:function(store_id){return this.value_id?$pwaRequest.post("mcommerce/mobile_sales_storechoice/update",{data:{store_id:store_id}}):$pwaRequest.reject("[McommerceSalesStorechoice::update] missing value_id.")}};return factory}),angular.module("starter").factory("McommerceStripe",function($pwaRequest){var factory={value_id:null,find:function(cust_id){return this.value_id?$pwaRequest.post("mcommerce/mobile_sales_stripe/find",{data:{customer_id:cust_id}}):$pwaRequest.reject("[McommerceStripe::find] missing value_id.")},process:function(data){return this.value_id?$pwaRequest.post("mcommerce/mobile_sales_stripe/process",{data:{value_id:this.value_id,token:data.token,customer_id:data.customer_id,use_stored_card:data.use_stored_card,save_card:data.save_card,notes:sessionStorage.getItem("mcommerce-notes")||""}}):$pwaRequest.reject("[McommerceStripe::process] missing value_id.")},getCard:function(customer_id){return this.value_id?$pwaRequest.post("mcommerce/mobile_sales_stripe/getcard",{data:{value_id:this.value_id,customer_id:customer_id}}):$pwaRequest.reject("[McommerceStripe::getCard] missing value_id.")},removeCard:function(customer_id){return this.value_id?$pwaRequest.post("mcommerce/mobile_sales_stripe/removecard",{data:{value_id:this.value_id,customer_id:customer_id}}):$pwaRequest.reject("[McommerceStripe::removeCard] missing value_id.")}};return factory});