angular.module("starter").controller("PlacesListController",function(Location,$q,$scope,$rootScope,$state,$stateParams,$translate,$timeout,Places,Search){angular.extend($scope,{is_loading:!0,value_id:$stateParams.value_id,position:{longitude:0,latitude:0},settings:null,show_search_bar:!1,search_part_name:"SEARCH",tag:null,filter_search:"",parameters:{value_id:$stateParams.value_id},collection:[],load_more:!1,use_pull_refresh:!0,pull_to_refresh:!1,card_design:!1,module_code:"places"}),Places.setValueId($stateParams.value_id),$scope.setSearchPartName=function(partName){$scope.search_part_name=partName},$scope.findByAroundyou=function(){$scope.search.aroundyou?$scope.search.aroundyou=!1:$scope.search.aroundyou={latitude:$scope.position.latitude,longitude:$scope.position.longitude},$scope.loadPlaces()},$scope.findByTag=function(tag){$scope.search.type=$scope.search.type===tag?"":tag,$scope.loadPlaces()},$scope.getState=function(){return $scope.is_loading?"LOADING":Array.isArray($scope.collection)&&$scope.collection.length>0?"RESULTS":"NO_RESULTS"},$scope.initSearch=function(){$scope.search={text:"",type:"",address:"",aroundyou:!1}},$scope.searchIsEmpty=function(){return""===$scope.search.text&&""===$scope.search.type&&""===$scope.search.address&&!$scope.search.aroundyou},$scope.clear=function(){$scope.loadPlaces(),$scope.setSearchPartName("SEARCH")},Search.setAgent(Places,$scope.value_id),Search.url="places/mobile_list/searchv2",$scope.right_button={icon:"ion-ios-location-outline",action:function(){$scope.goToMap()}};Places.settings().then(function(settings){Location.getLocation().then(function(position){$scope.position.latitude=position.coords.latitude,$scope.position.longitude=position.coords.longitude},function(error){$scope.position.latitude=0,$scope.position.longitude=0}).then(function(){$scope.settings=settings,$scope.position.longitude&&$scope.position.latitude&&!$rootScope.isOffline?$scope.settings.search_aroundyou_show=$scope.settings.search_aroundyou_show:$scope.settings.search_aroundyou_show=!1,$scope.settings.showSearch=!$rootScope.isOffline&&($scope.settings.search_address_show||$scope.settings.search_text_show||$scope.settings.search_type_show||$scope.settings.search_aroundyou_show)})}),$scope.loadContent=function(loadMore){$scope.initSearch();var noGeoLoc=function(){$scope.position={latitude:0,longitude:0},$scope.parameters.latitude=0,$scope.parameters.longitude=0,$scope.loadPlaces(loadMore,!1)};$rootScope.isOffline?noGeoLoc():Location.getLocation().then(function(position){$scope.position={latitude:position.coords.latitude,longitude:position.coords.longitude},$scope.parameters.latitude=position.coords.latitude,$scope.parameters.longitude=position.coords.longitude,$scope.loadPlaces(loadMore,!0)},noGeoLoc)},$scope.loadMore=function(){$scope.loadPlaces(!0)},$scope.loadPlaces=function(loadMore){$scope.is_loading=!0,$scope.parameters.search=$scope.search;var offset=$scope.collection.length;$scope.parameters.offset=offset,offset<=0&&($scope.collection=[],Places.collection=[]);var resolver=null;$scope.searchIsEmpty()||$rootScope.isOffline?resolver=Places.findAll($scope.position,offset):($scope.collection=[],Places.collection=[],resolver=Search.findAll($scope.parameters)),resolver.then(function(data){$scope.page_title=data.page_title,Places.collection=Places.collection.concat(angular.copy(data.places)),$scope.reduce_collection=data.places.reduce(function(collection,place){var item={id:place.id,title:place.title,subtitle:place.subtitle,picture:place.picture,thumbnail:place.thumbnail,url:place.url};return collection.push(item),collection},[]),$scope.collection=$scope.collection.concat($scope.reduce_collection),$scope.load_more=data.places.length>0}).then(function(){loadMore&&$scope.$broadcast("scroll.infiniteScrollComplete"),$scope.is_loading=!1})},$scope.pullToRefresh=function(){$scope.pull_to_refresh=!0,$scope.load_more=!1,Places.findAll($scope.position,0,!0).then(function(data){data.collection&&($scope.page_title=data.page_title,Places.collection=angular.copy(data.places),$scope.reduce_collection=data.places.reduce(function(collection,place){var item={id:place.id,title:place.title,subtitle:place.subtitle,picture:place.picture,thumbnail:place.thumbnail,url:place.url};return collection.push(item),collection},[]),$scope.collection=$scope.collection.concat($scope.reduce_collection)),$scope.load_more=data.places.length>=data.displayed_per_page}).then(function(){$scope.$broadcast("scroll.refreshComplete"),$scope.pull_to_refresh=!1,$timeout(function(){$scope.can_load_older_posts=!!$scope.collection.length},500)})},$scope.goToMap=function(){$rootScope.isNotAvailableOffline()||$state.go("places-list-map",{value_id:$scope.value_id,page_id:$stateParams.page_id})},$scope.showItem=function(item){$state.go("places-view",{value_id:$scope.value_id,page_id:item.id,type:"places"})},$scope.loadContent(!1)}).controller("CmsListMapController",function($scope,$state,$stateParams,$translate,Places){angular.extend($scope,{is_loading:!0,value_id:$stateParams.value_id}),Places.setValueId($stateParams.value_id),$scope.loadContent=function(){Places.findAllMaps().then(function(data){$scope.page_title=data.page_title,$scope.collection=data.places;for(var markers=[],i=0;i<$scope.collection.length;i+=1){var place=$scope.collection[i],marker={config:{id:angular.copy(place.id)},title:place.title+"<br />"+place.address.address+'<br /><i class="ion-android-open"></i>&nbsp;'+$translate.instant("See details")+"</span>",onClick:function(config){$scope.goToPlace(config.id)}};place.address.latitude&&place.address.longitude?(marker.latitude=place.address.latitude,marker.longitude=place.address.longitude):marker.address=place.address.address,place.picture&&(marker.icon={url:place.picture,width:70,height:44}),markers.push(marker)}$scope.map_config={markers:markers,bounds_to_marker:!0}}).finally(function(){$scope.is_loading=!1})},$scope.loadContent(),$scope.goToPlace=function(placeId){$state.go("places-view",{value_id:$scope.value_id,page_id:placeId,type:"places"})}}),angular.module("starter").factory("Places",function($pwaRequest,Cms){var factory={value_id:null,collection:[],extendedOptions:{},setValueId:function(value_id){factory.value_id=value_id},setExtendedOptions:function(options){factory.extendedOptions=options},preFetch:function(){factory.findAll()},findAll:function(position,offset,refresh){if(!this.value_id)return $pwaRequest.reject("[Factory::Places.findAll] missing value_id");var parameters={value_id:this.value_id,offset:offset};return angular.isObject(position)&&(parameters.latitude=position.latitude,parameters.longitude=position.longitude),$pwaRequest.get("places/mobile_list/findall",angular.extend({urlParams:parameters,refresh:refresh},factory.extendedOptions))},findAllMaps:function(refresh){if(!this.value_id)return $pwaRequest.reject("[Factory::Places.findAll] missing value_id");var parameters={value_id:this.value_id,maps:!0};return $pwaRequest.get("places/mobile_list/findall",angular.extend({urlParams:parameters,refresh:refresh},factory.extendedOptions))},find:function(place_id){return this.value_id?$pwaRequest.get("places/mobile_view/find",{urlParams:{value_id:this.value_id,place_id:place_id}}):$pwaRequest.reject("[Factory::Places.find] missing value_id")},getPlace:function(place_id){if(!this.value_id)return $pwaRequest.reject("[Factory::Places.getPlace] missing value_id");var place=_.get(_.filter(factory.collection,function(item){return item.id==place_id})[0],"embed_payload",!1);return place?$pwaRequest.resolve(place):Cms.findAll(place_id)},settings:function(){return this.value_id?$pwaRequest.resolve($pwaRequest.getPayloadForValueId(factory.value_id).settings):$pwaRequest.reject("[Factory::Places.settings] missing value_id")}};return factory});