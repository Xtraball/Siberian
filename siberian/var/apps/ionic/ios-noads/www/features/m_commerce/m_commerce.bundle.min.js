angular.module('starter').controller('MCommerceCartViewController',function($scope,$state,Loader,$stateParams,$translate,$timeout,Dialog,McommerceCart,Customer){angular.extend($scope,{is_loading:!1,value_id:$stateParams.value_id,page_title:$translate.instant('Cart','m_commerce'),points_data:{use_points:!1,nb_points_used:null},nb_stores:null,object:{cart:null},});McommerceCart.value_id=$stateParams.value_id;$scope.loadContent=function(){Loader.show($translate.instant('Updating price','m_commerce'));$scope.is_loading=!0;McommerceCart.compute().then(function(computation){$scope.computation=computation}).then(function(){$scope.computation=angular.isObject($scope.computation)?$scope.computation:{};McommerceCart.find().then(function(data){if(data.cart.tip===0){data.cart.tip=''}
if(angular.isObject($scope.object.cart)&&(!angular.isString(data.cart.discount_code)||data.cart.discount_code.trim().length<1)){data.cart.discount_code=$scope.object.cart.discount_code}
$scope.object.cart=data.cart;$scope.object.cart.discount_message=$scope.computation.message;$scope.object.cart.discount=$scope.computation.discount;$scope.nb_stores=data.nb_stores;if($scope.object.cart.lines.length>0){$scope.right_button={action:$scope.proceed,label:$translate.instant('Proceed','m_commerce')}}}).then(function(){Customer.find().then(function(data){$scope.object.cart.customer_fidelity_points=(data.metadatas&&data.metadatas.fidelity_points)?data.metadatas.fidelity_points.points:null;if(!$scope.points_data.use_points){$scope.points_data.nb_points_used=$scope.object.cart.customer_fidelity_points}
$scope.updateEstimatedDiscount()}).then(function(){Loader.hide();$scope.is_loading=!1})})})};$scope.updateEstimatedDiscount=function(){if($scope.points_data.nb_points_used>0){$scope.object.cart.estimated_fidelity_discount=(Math.round($scope.points_data.nb_points_used*$scope.object.cart.fidelity_rate*100)/100)+' '+$scope.object.cart.currency_code}};$scope.useFidelityChange=function(){if($scope.points_data.use_points){$scope.object.cart.discount_code=null;$scope.updateTipAndDiscount()}};$scope._update=_.debounce(function(){Loader.show($translate.instant('Updating price','m_commerce'));$scope.is_loading=!0;McommerceCart.adddiscount($scope.object.cart.discount_code,!0).then(function(){McommerceCart.addTip($scope.object.cart).then(function(data){if(data.success){if(angular.isDefined(data.message)){Dialog.alert('',data.message,'OK');return}}},function(data){if(data&&angular.isDefined(data.message)){Dialog.alert('',data.message,'OK')}}).then(function(){$scope.loadContent();Loader.hide();$scope.is_loading=!1})},function(data){if(data&&angular.isDefined(data.message)){Dialog.alert('',data.message,'OK')}}).then(function(){Loader.hide();$scope.is_loading=!1})},900);$scope.updateTipAndDiscount=function(){$scope._update()};$scope.proceed=function(){var gotToNext=function(){Loader.hide();if(!$scope.object.cart.valid){$scope.cartIdInvalid()}else if($scope.nb_stores>1){$scope.goToStoreChoice()}else{$scope.goToOverview()}};if($scope.object.cart&&$scope.object.cart.discount_code){Loader.show($translate.instant('Loading...','m_commerce'));McommerceCart.adddiscount($scope.object.cart.discount_code,!0).then(function(data){if(data&&data.success){gotToNext()}else{if(data&&data.message){Dialog.alert('',data.message,'OK')}else{Dialog.alert('','Unexpected Error','OK')}}},function(resp){var data=resp.data;if(data&&angular.isDefined(data.message)){Dialog.alert('',data.message,'OK')}}).then(function(){Loader.hide()})}else if($scope.points_data.use_points){if($scope.points_data.nb_points_used>0){if($scope.points_data.nb_points_used<=$scope.cart.customer_fidelity_points){Loader.show($translate.instant('Loading...','m_commerce'));McommerceCart.useFidelityPoints($scope.points_data.nb_points_used).then(function(data){gotToNext()},function(data){Dialog.alert('',data.message,'OK')}).then(function(){Loader.hide()})}else{Dialog.alert("Sorry","You don't have enough points",'OK')}}}else{Loader.show($translate.instant('Loading...','m_commerce'));McommerceCart.removeAllDiscount().then(function(data){gotToNext()},function(data){Dialog.alert('',data.message,'OK')}).then(function(){Loader.hide()})}};$scope.cartIdInvalid=function(){Dialog.alert('Sorry',$scope.object.cart.valid_message,'OK',3700)};$scope.goToStoreChoice=function(){$state.go('mcommerce-sales-store',{value_id:$scope.value_id})};$scope.goToOverview=function(){if(!$scope.is_loading){$state.go('mcommerce-sales-customer',{value_id:$scope.value_id})}};$scope.goToCategories=function(){$state.go('mcommerce-category-list',{value_id:$scope.value_id})};$scope.removeLine=function(line){Loader.show($translate.instant('Updating price','m_commerce'));$scope.is_loading=!0;McommerceCart.deleteLine(line.id).then(function(data){if(data.success){if(angular.isDefined(data.message)){Dialog.alert('',data.message,'OK');return}
$scope.loadContent()}},function(data){if(data&&angular.isDefined(data.message)){Dialog.alert('',data.message,'OK')}})};$scope.changeQuantity=function(qty,params){Loader.show($translate.instant('Updating price','m_commerce'));$scope.is_loading=!0;let localLine=angular.copy(params.line);localLine.qty=angular.copy(qty);return McommerceCart.modifyLine(localLine).then(function(data){$timeout(function(){$scope.object.cart.formattedSubtotalExclTax=data.cart.formattedSubtotalExclTax;$scope.object.cart.formattedDeliveryCost=data.cart.formattedDeliveryCost;$scope.object.cart.formattedTotalExclTax=data.cart.formattedTotalExclTax;$scope.object.cart.formattedTotalTax=data.cart.formattedTotalTax;$scope.object.cart.formattedTotal=data.cart.formattedTotal;$scope.object.cart.deliveryCost=data.cart.deliveryCost;$scope.object.cart.valid=data.cart.valid});return data},function(data){if(data&&angular.isDefined(data.message)){$scope.message=new Message();$scope.message.isError(!0).setText(data.message).show()}}).then(function(data){let scopeLineIndex=_.findIndex($scope.object.cart.lines,function(line){return line.id==data.line.id});$timeout(function(){$scope.object.cart.lines[scopeLineIndex]=data.line;Loader.hide();$scope.is_loading=!1});return data}).catch(function(){Loader.hide();$scope.is_loading=!1})};$scope.loadContent()});angular.module('starter').controller('MCommerceListController',function(Loader,$location,$scope,$state,$stateParams,McommerceCategory,$translate,McommerceCart,Customer){$scope.is_loading=!0;Loader.show($translate.instant('Loading...','m_commerce'));$scope.factory=McommerceCategory;$scope.collection=[];$scope.collection_is_empty=!0;McommerceCategory.value_id=$stateParams.value_id;McommerceCategory.category_id=$stateParams.category_id;$scope.value_id=$stateParams.value_id;$scope.use_button_header=!1;if(Customer.isLoggedIn()&&!$stateParams.category_id){$scope.use_button_header=!0}
$scope.loadContent=function(){McommerceCategory.findAll().then(function(data){$scope.show_search=data.show_search;$scope.collection=data.collection;$scope.collection_is_empty=$scope.collection.length>0;$scope.cover=data.cover;$scope.page_title=data.page_title}).then(function(){$scope.is_loading=!1;Loader.hide()});McommerceCart.value_id=$stateParams.value_id;McommerceCart.find().then(function(data){try{$scope.cartItems=data.cart.lines.length}catch(e){$scope.cartItems=0}})};$scope.openCart=function(){if(!$scope.is_loading){$state.go('mcommerce-cart-view',{value_id:$scope.value_id})}};$scope.openHistory=function(){if(!$scope.is_loading){$state.go('mcommerce-sales-history',{value_id:$scope.value_id})}};if(!$scope.use_button_header){$scope.right_button={action:$scope.openCart,icon:'ion-ios-cart'}}
$scope.showItem=function(item){$location.path(item.url)};$scope.loadContent()}).controller('MCommerceRedirectController',function($ionicHistory,$scope,$state,$stateParams,HomepageLayout){angular.extend($scope,{value_id:$stateParams.value_id,layout:HomepageLayout});$state.go('home').then(function(){if($scope.layout.properties.options.autoSelectFirst){$ionicHistory.nextViewOptions({historyRoot:!0,disableAnimate:!1})}
$state.go('mcommerce-category-list',{value_id:$scope.value_id})})});angular.module('starter').controller('MCommerceProductViewController',function($cordovaSocialSharing,Loader,$log,$state,$stateParams,$scope,$translate,Analytics,Application,Dialog,McommerceCategory,$timeout,McommerceCart,McommerceProduct,$rootScope){McommerceProduct.value_id=$stateParams.value_id;McommerceCart.value_id=$stateParams.value_id;$scope.value_id=$stateParams.value_id;$scope.product_id=$stateParams.product_id;$scope.social_sharing_active=!1;$scope.product_quantity=1;$scope.selected_format={id:null};$scope.list_qty=[1,2,3,4,5,6,7,8,9,10];$scope.loadContent=function(){$scope.is_loading=!0;Loader.show($translate.instant('Loading...','m_commerce'));McommerceProduct.find($scope.product_id).then(function(data){$scope.product=data.product;Analytics.storeProductOpening($scope.product);$scope.social_sharing_active=($scope.product.social_sharing_active&&$rootScope.isNativeApp);$scope.share=function(){if($scope.is_sharing){return}
$scope.is_sharing=!0;let app_name=Application.app_name;let link=DOMAIN+'/application/device/downloadapp/app_id/'+Application.app_id;let subject='';let file=($scope.product.picture[0]&&$scope.product.picture[0].url)?$scope.product.picture[0].url:'';let content=$scope.product.name;let message=$translate.instant('Hi. I just found: $1 in the $2 app.').replace('$1',content).replace('$2',app_name);$cordovaSocialSharing.share(message,subject,file,link).then(function(result){$log.debug('MCommerce::product.js','social sharing success');$scope.is_sharing=!1},function(err){$log.debug('MCommerce::product.js',err);$scope.is_sharing=!1})};if($scope.product.formatGroups.length>0){$scope.selected_format.id=$scope.product.formatGroups[0].id}
$scope.page_title=data.page_title}).then(function(){$scope.is_loading=!1;Loader.hide()})};$scope.addProduct=function(){$scope.is_loading=!0;Loader.show();let errors=[];let postParameters={'product_id':$scope.product_id,'category_id':McommerceCategory.category_id,'qty':$scope.product_quantity,'options':$scope.product.optionsGroups.reduce(function(options,optionsGroup){if(optionsGroup.required&&!optionsGroup.selectedOptionId){errors.push($translate.instant('Option $1 is required.','m_commerce').replace("$1",optionsGroup.title))}
if(optionsGroup.selectedQuantity<=0||!optionsGroup.selectedQuantity){errors.push($translate.instant('Quantity for option $1 is required.','m_commerce').replace("$1",optionsGroup.title))}
options[optionsGroup.id]={'option_id':optionsGroup.selectedOptionId,'qty':optionsGroup.selectedQuantity};return options},{}),'choices':$scope.product.choicesGroups.reduce(function(choices,choicesGroup){let selected=[];choicesGroup.options.forEach(function(e,i){if(e.selected){selected.push(e.id)}});if(choicesGroup.required&&!selected.length){errors.push($translate.instant('Option $1 is required.','m_commerce').replace("$1",choicesGroup.title))}
choices[choicesGroup.id]={'selected_options':selected};return choices},{}),'selected_format':$scope.selected_format.id};if(errors.length<=0){McommerceCart.addProduct(postParameters).then(function(data){if(data.success){$scope.is_loading=!1;Loader.hide();$scope.openCart()}},function(data){if(data&&angular.isDefined(data.message)){Dialog.alert('',data.message,'OK')}
$scope.is_loading=!1;$scope.product_quantity=1;$scope.selected_format={id:null};$scope.product.optionsGroups.forEach(function(option){option.selectedOptionId=null;option.selectedQuantity=1});$scope.product.choicesGroups.forEach(function(choice){choice.options.forEach(function(option){option.selected=!1})});Loader.hide()})}else{let message=errors.join('<br />');Dialog.alert('',message,'OK');$scope.is_loading=!1;Loader.hide()}};$scope.openCart=function(){if(!$scope.is_loading){$state.go('mcommerce-cart-view',{value_id:$scope.value_id})}};$scope.changeQuantity=function(qty){if(qty){$timeout(function(){$scope.product_quantity=qty})}};$scope.right_button={action:$scope.openCart,icon:'ion-ios-cart'};$scope.loadContent()});angular.module('starter').controller('MCommerceSalesConfirmationViewController',function(Loader,$location,$rootScope,$scope,$state,$stateParams,$timeout,$translate,$window,Analytics,Application,Customer,Dialog,McommerceCart,McommerceSalesPayment){angular.extend($scope,{is_loading:!0,page_title:$translate.instant('Review','m_commerce'),value_id:$stateParams.value_id});Loader.show();McommerceCart.value_id=$stateParams.value_id;McommerceSalesPayment.value_id=$stateParams.value_id;$scope.loadContent=function(){$scope.guest_mode=Customer.guest_mode;McommerceCart.compute().then(function(computation){McommerceCart.find().then(function(data){$scope.cart=data.cart;$scope.cart.discount_message=computation.message;$scope.cart.discount=computation.discount;McommerceSalesPayment.findOnlinePaymentUrl().then(function(onlinePaymentData){$scope.onlinePaymentUrl=onlinePaymentData.url;$scope.form_url=onlinePaymentData.form_url;$scope.right_button={action:$scope.validate,label:$translate.instant('Validate','m_commerce')}}).then(function(){Loader.hide();if(computation&&angular.isDefined(computation.message)&&computation.show_message){Dialog.alert('',computation.message,'OK')}
$scope.is_loading=!1})},function(){$scope.is_loading=!1;Loader.hide()})},function(){Loader.hide();$scope.is_loading=!1})};$scope.validate=function(){McommerceSalesPayment.notes=$scope.notes||'';sessionStorage.setItem('mcommerce-notes',$scope.notes||'');if($scope.onlinePaymentUrl){if(!isNativeApp){$window.location=$scope.onlinePaymentUrl}else{var browser=$window.open($scope.onlinePaymentUrl,$rootScope.getTargetForLink(),'location=yes');var nextState='mcommerce-sales-error';var stepNext=function(){browser.close();$state.go(nextState,{value_id:$stateParams.value_id})};browser.addEventListener('loadstart',function(event){switch(!0){case/(mcommerce\/mobile_sales_success)/.test(event.url):nextState='mcommerce-sales-success';stepNext();break;case/(mcommerce\/mobile_sales_cancel)/.test(event.url):nextState='mcommerce-sales-confirmation-cancel';stepNext();break;case/(mcommerce\/mobile_sales_error)/.test(event.url):nextState='mcommerce-sales-error';stepNext();break}})}}else if($scope.form_url){$location.path($scope.form_url)}else{if($scope.is_loading){return}
$scope.is_loading=!0;Loader.show();McommerceSalesPayment.validatePayment().then(function(data){var products=[];angular.forEach($scope.cart.lines,function(value,key){var product=value.product;product.category_id=value.category_id;product.quantity=value.qty;products.push(product)});Analytics.storeProductSold(products);$state.go('mcommerce-sales-success',{value_id:$stateParams.value_id})},function(data){Dialog.alert('',data.message,'OK')}).then(function(){$scope.is_loading=!1;Loader.hide()})}};$scope.loadContent()});angular.module('starter').controller('MCommerceSalesConfirmationCancelController',function($state,$stateParams,$translate,Dialog){Dialog.alert('','The payment has been cancelled, something wrong happened? Feel free to contact us.','OK').then(function(){$state.go('mcommerce-sales-confirmation',{value_id:$stateParams.value_id})})});angular.module('starter').controller('MCommerceSalesCustomerViewController',function(Loader,$state,$stateParams,$scope,$translate,$rootScope,McommerceCart,McommerceSalesCustomer,Customer,Dialog,Application,SB){$scope.hasguestmode=!1;angular.extend($scope,{dateTime:{format:"MM/DD/YYYY",title:$translate.instant('Date of birth','m_commerce')}});$scope.signupEnabled=function(){return Application.myAccount.settings.enable_registration};$scope.customer_login=function(){Customer.display_account_form=!1;Customer.loginModal($scope)};$scope.customer_signup=function(){Customer.display_account_form=!0;Customer.loginModal($scope)};$scope.customer_guestmode=function(){Loader.show();let currentTs=Date.now();let guestmail='guest'+currentTs+(parseInt(Math.random()*1000,10))+'@guest.com';Customer.register({civility:'m',firstname:'Guest',lastname:'Guest',email:guestmail,password:parseInt(Math.random()*10000000000,10),privacy_policy:!0}).then(function(){$scope.is_logged_in=!0;Customer.guest_mode=!0;$scope.loadContent()}).then(function(){$scope.is_loading=!1;Loader.hide()})};$scope.$on(SB.EVENTS.AUTH.loginSuccess,function(){$scope.is_logged_in=!0;$scope.loadContent()});$scope.$on(SB.EVENTS.AUTH.logoutSuccess,function(){$scope.is_logged_in=!1});$scope.is_loading=!0;Loader.show();$scope.is_logged_in=Customer.isLoggedIn();McommerceCart.value_id=$stateParams.value_id;McommerceSalesCustomer.value_id=$stateParams.value_id;$scope.value_id=$stateParams.value_id;$scope.page_title=$translate.instant('My information','m_commerce');$scope.loadContent=function(){McommerceSalesCustomer.hasGuestMode().then(function(dataGuestMode){if(dataGuestMode.success&&dataGuestMode.activated){$scope.hasguestmode=!0}
McommerceSalesCustomer.find().then(function(data){$scope.customer=data.customer;$scope.settings=data.settings}).then(function(){$scope.is_loading=!1;Loader.hide()})},function(data){if(data&&angular.isDefined(data.message)){Dialog.alert('Error',data.message,'OK')}}).then(function(){$scope.is_loading=!1;Loader.hide()})};$scope.goToDeliveryPage=function(){$state.go('mcommerce-sales-delivery',{value_id:$stateParams.value_id})};$scope.updateCustomerInfos=function(){$rootScope.loginFeature=!0;$rootScope.loginFeatureBack=!1;$scope.is_loading=!0;Loader.show();McommerceSalesCustomer.updateCustomerInfos({customer:$scope.customer}).then(function(data){$scope.customer=data.customer;Customer.save($scope.customer).then(function(data){if(angular.isDefined(data.message)){}
$scope.goToDeliveryPage()},function(data){if(data&&angular.isDefined(data.message)){Dialog.alert('Error',data.message,'OK')}}).then(function(){$scope.is_loading=!1;Loader.hide()})},function(data){$scope.is_loading=!1;Loader.hide();if(data&&angular.isDefined(data.message)){Dialog.alert('Error',data.message,'OK')}})};$scope.right_button={action:$scope.updateCustomerInfos,label:$translate.instant('Next','m_commerce')};$scope.loadContent()});angular.module("starter").controller("MCommerceSalesDeliveryViewController",function(Loader,$scope,$stateParams,$state,$translate,McommerceCart,McommerceSalesDelivery,Dialog,$timeout){$scope.page_title=$translate.instant('Delivery','m_commerce');McommerceCart.value_id=$stateParams.value_id;McommerceSalesDelivery.value_id=$stateParams.value_id;$scope.value_id=$stateParams.value_id;$scope.clients_calculate_change_form_is_visible=!1;$scope.loadContent=function(){$scope.is_loading=!0;Loader.show();McommerceCart.find().then(function(data){$scope.cart=data.cart;$scope.cart.delivery_method_extra_client_amount=$scope.cart.paid_amount?parseFloat($scope.cart.paid_amount):$scope.cart.total;$scope.cart.delivery_method_extra_amount_due=($scope.cart.delivery_amount_due)?parseFloat($scope.cart.delivery_amount_due):0;McommerceSalesDelivery.findStore().then(function(data){$scope.clients_calculate_change_form_is_visible=data.clients_calculate_change;$scope.selectedStore=data.store;$scope.calculateAmountDue()}).then(function(){$scope.is_loading=!1;Loader.hide()})},function(){$scope.is_loading=!1;Loader.hide()})};$scope.selectDeliveryMethod=function(cart,delivery_method){var tmp_total_with_fees=cart.base_total_without_fees+delivery_method.price;cart.total=parseFloat(tmp_total_with_fees!=cart.total&&!cart.deliveryCost?tmp_total_with_fees:cart.total);cart.delivery_method_extra_client_amount=cart.total;cart.deliveryMethodId=delivery_method.id;$scope.clients_calculate_change_form_is_visible=((delivery_method.code==='home_delivery')&&$scope.selectedStore.clients_calculate_change);$scope.cart.delivery_method_extra_amount_due=0;if(delivery_method.code!=='home_delivery'){$scope.updateDeliveryInfos()}};$scope.calculateAmountDue=function(){if(!$scope.clients_calculate_change_form_is_visible){$scope.cart.delivery_method_extra_client_amount=""}else{var price=parseFloat($scope.cart.delivery_method_extra_client_amount);if(isNaN(price)||price<$scope.cart.total){if(isNaN(price)){$scope.cart.delivery_method_extra_client_amount=""}
$scope.cart.delivery_method_extra_amount_due="";return}
if($scope.cart.delivery_method_extra_client_amount<$scope.cart.total){$scope.cart.delivery_method_extra_client_amount=$scope.cart.total}
$scope.cart.delivery_method_extra_amount_due=(price-$scope.cart.total).toFixed(2)}
$timeout(function(){$scope.cart.total=$scope.cart.total})};$scope.updateDeliveryInfos=function(){if($scope.clients_calculate_change_form_is_visible&&$scope.cart.delivery_method_extra_client_amount<$scope.cart.total){Dialog.alert("","The amount must be equal or greater than the order total.","OK");return}
if(!$scope.cart.deliveryMethodId){Dialog.alert("","You must choose a delivery method.","OK");return}
if(!$scope.is_loading){$scope.is_loading=!0;Loader.show();let postParameters={'delivery_method_id':$scope.cart.deliveryMethodId,'paid_amount':$scope.clients_calculate_change_form_is_visible?$scope.cart.delivery_method_extra_client_amount:null,'store_id':$scope.selectedStore.id};McommerceSalesDelivery.updateDeliveryInfos(postParameters).then(function(data){$scope.goToPaymentPage()},function(data){if(data&&angular.isDefined(data.message)){Dialog.alert("",data.message,"OK")}}).then(function(){$scope.is_loading=!1;Loader.hide()})}};$scope.goToPaymentPage=function(){$state.go("mcommerce-sales-payment",{value_id:$stateParams.value_id})};$scope.right_button={action:$scope.updateDeliveryInfos,label:$translate.instant('Next','m_commerce')};$scope.loadContent()});angular.module('starter').controller('MCommerceSalesErrorViewController',function($scope,$state,$stateParams,$timeout){$scope.value_id=$stateParams.value_id;$timeout(function(){$state.go('mcommerce-redirect',{value_id:$scope.value_id})},4000)});angular.module("starter").controller("MCommerceSalesHistoryViewController",function(Loader,$scope,$state,$stateParams,$translate,McommerceSalesCustomer){$scope.value_id=$stateParams.value_id;$scope.page_title=$translate.instant('Order history','m_commerce');$scope.showLoader=function(){Loader.show()};$scope.orders=[];$scope.offset=0;$scope.can_load_older_posts=!0;McommerceSalesCustomer.value_id=$stateParams.value_id;$scope.loadContent=function(){$scope.showLoader();McommerceSalesCustomer.getOrderHistory($scope.offset).then(function(data){if(data.orders){$scope.orders=$scope.orders.concat(data.orders);$scope.offset+=data.orders.length;if(data.orders.length<=0){$scope.can_load_older_posts=!1}
return!0}else{$scope.orders=[];return!1}}).then(function(refresh){if(refresh){$scope.$broadcast('scroll.infiniteScrollComplete')}
Loader.hide()})};$scope.loadContent();$scope.showDetails=function(order_id){$state.go("mcommerce-sales-history-details",{value_id:$scope.value_id,order_id:order_id})};$scope.loadMore=function(){$scope.loadContent()}}).controller("MCommerceSalesHistoryDetailsController",function(Loader,$scope,$stateParams,$translate,McommerceSalesCustomer){$scope.value_id=$stateParams.value_id;$scope.page_title=$translate.instant('Order details','m_commerce');$scope.order_id=$stateParams.order_id;Loader.show();McommerceSalesCustomer.value_id=$stateParams.value_id;$scope.loadContent=function(){McommerceSalesCustomer.getOrderDetails($scope.order_id).then(function(data){$scope.order=data.order}).then(function(){Loader.hide()})};$scope.loadContent()});angular.module('starter').controller('MCommerceSalesPaymentViewController',function(Loader,$scope,$state,$stateParams,$translate,McommerceCart,McommerceSalesPayment,Dialog){$scope.page_title=$translate.instant('Payment','m_commerce');McommerceCart.value_id=$stateParams.value_id;McommerceSalesPayment.value_id=$stateParams.value_id;$scope.value_id=$stateParams.value_id;$scope.loadContent=function(){Loader.show();McommerceCart.find().then(function(data){$scope.cart=data.cart;McommerceSalesPayment.findPaymentMethods().then(function(resultMethods){$scope.paymentMethods=resultMethods.paymentMethods;$scope.paymentMethodId=resultMethods.paymentMethods.reduce(function(paymentMethodId,paymentMethod){return($scope.cart.paymentMethodId===paymentMethod.id)?paymentMethod.id:paymentMethodId},null);if($scope.paymentMethods.length===1&&$scope.paymentMethods[0].code==='free'&&$scope.cart.lines.length>0){$scope.cart.paymentMethodId=$scope.paymentMethods[0].id;$scope.updatePaymentInfos()}}).then(function(){$scope.is_loading=!1;Loader.hide()})},function(){$scope.is_loading=!1;Loader.hide()})};$scope.updatePaymentInfos=function(){if(!$scope.is_loading){$scope.is_loading=!0;Loader.show();var postParameters={'payment_method_id':$scope.cart.paymentMethodId};McommerceSalesPayment.updatePaymentInfos(postParameters).then(function(data){$scope.goToConfirmationPage()},function(data){if(data&&angular.isDefined(data.message)){Dialog.alert('',data.message,'OK')}}).then(function(){$scope.is_loading=!1;Loader.hide()})}};$scope.goToConfirmationPage=function(){if($scope.cart.paymentMethodId){$state.go('mcommerce-sales-confirmation',{value_id:$stateParams.value_id})}else{Dialog.alert('','Please choose a payment method.','OK')}};$scope.right_button={action:$scope.updatePaymentInfos,label:$translate.instant('Next','m_commerce')};$scope.loadContent()});angular.module('starter').controller('MCommerceSalesStoreChoiceController',function(Loader,$scope,$state,$stateParams,$timeout,$translate,Dialog,McommerceSalesStorechoice){$scope.value_id=$stateParams.value_id;McommerceSalesStorechoice.value_id=$stateParams.value_id;$scope.selected_store={id:-1};$scope.loadContent=function(){$scope.is_loading=!0;McommerceSalesStorechoice.find().then(function(data){$scope.stores=data.stores;$scope.cart_amount=data.cart_amount;$timeout(function(){$scope.selected_store.id=data.store_id})}).then(function(){$scope.is_loading=!1})};$scope.chooseStore=function(){if($scope.selected_store.id!==-1){Loader.show($translate.instant('Updating...','m_commerce'));$scope.min_amount=0;angular.forEach($scope.stores,function(store){if(store.id==$scope.selected_store.id){$scope.min_amount=store.min_amount;$scope.error_message=store.error_message}});if($scope.min_amount<=$scope.cart_amount){McommerceSalesStorechoice.update($scope.selected_store.id).then(function(data){Loader.hide();if(data.store_id){$state.go("mcommerce-sales-customer",{value_id:$scope.value_id})}}).then(function(){Loader.hide()})}else{Dialog.alert("",$scope.error_message,"OK",-1,'m_commerce');Loader.hide()}}};$scope.right_button={action:$scope.chooseStore,label:$translate.instant('Proceed','m_commerce')};$scope.loadContent()});angular.module("starter").controller("MCommerceSalesStripeViewController",function(Loader,$scope,$state,$stateParams,$timeout,$translate,Customer,McommerceStripe,Dialog){$scope.is_loading=!0;Loader.show();$scope.value_id=$stateParams.value_id;McommerceStripe.value_id=$stateParams.value_id;$scope.card={};$scope.payment={};$scope.payment.save_card=!1;$scope.payment.use_stored_card=!1;$scope.payment.hasStoredCard=!1;$scope.isProcessing=!1;$scope.cardElement=null;$scope.creditCardBrand=function(brand){var _brand=(brand===undefined)?"default":brand;switch(_brand.toLowerCase()){case "visa":return"./features/m_commerce/assets/templates/images/011-cc-visa.svg";case "mastercard":return"./features/m_commerce/assets/templates/images/012-cc-mastercard.svg";case "american express":return"./features/m_commerce/assets/templates/images/013-cc-amex.png"}
return"./features/m_commerce/assets/templates/images/014-cc.svg"};$scope.loadContent=function(){$scope.guest_mode=Customer.guest_mode;var cust_id=null;if(Customer.isLoggedIn()){cust_id=Customer.id}
$scope.payment.save_card=!1;McommerceStripe.find(cust_id).then(function(data){McommerceStripe.StripeInstance=Stripe(data.publishable_key);$scope.cart_total=data.total;if(data.card&&data.card.exp_year){$scope.card=data.card;$scope.payment.hasStoredCard=!0}}).then(function(){$scope.is_loading=!1;Loader.hide();$timeout(function(){$scope.mountCard()},200)})};$scope.mountCard=function(){var cardElementParent=document.getElementById("mcommerce_card_element");try{cardElementParent.firstChild.remove()}catch(e){}
var elements=McommerceStripe.StripeInstance.elements();var style={base:{color:"#32325d",fontFamily:"'Helvetica Neue', Helvetica, sans-serif",fontSmoothing:"antialiased",fontSize:"16px","::placeholder":{color:"#aab7c4"}},invalid:{color:"#fa755a",iconColor:"#fa755a"}};$scope.cardElement=elements.create("card",{hidePostalCode:!0,style:style});var saveElement=document.getElementById("mcommerce_save_element");var displayError=document.getElementById("mcommerce_card_errors");var displayErrorParent=document.getElementById("mcommerce_card_errors_parent");saveElement.setAttribute("disabled","disabled");$scope.cardElement.removeEventListener("change");$scope.cardElement.addEventListener("change",function(event){if(event.error){displayErrorParent.classList.remove("ng-hide");displayError.textContent=event.error.message;saveElement.setAttribute("disabled","disabled")}else{displayErrorParent.classList.add("ng-hide");displayError.textContent="";saveElement.removeAttribute("disabled")}});$scope.cardElement.mount("#mcommerce_card_element")};$scope.validateCard=function(){$scope.process()};$scope.deleteVault=function(){Dialog.confirm("Confirmation","Do you confirm you want to remove your card?",["Yes","No"],"m_commerce").then(function(result){if(result){$scope.is_loading=!0;Loader.show();McommerceStripe.removeCard(Customer.id).then(function(data){$scope.oldcard=$scope.card;$scope.card={};$scope.payment.use_stored_card=!1;$scope.payment.hasStoredCard=!1}).then(function(){$scope.is_loading=!1;Loader.hide()})}})};$scope.useCard=function(){if(!$scope.isProcessing){$scope.isProcessing=!0;$scope.payment.use_stored_card=!0;$scope.process()}};$scope.process=function(){if(!$scope.is_loading){$scope.is_loading=!0;Loader.show();if($scope.payment.use_stored_card){$scope._process()}else{McommerceStripe.StripeInstance.createToken($scope.cardElement).then(function(result){_stripeResponseHandler(result)})}}};var _stripeResponseHandler=function(result){if(result.error){Dialog.alert("",result.error.message,"OK");$scope.is_loading=!1;$scope.isProcessing=!1;Loader.hide()}else{$scope.card={token:result.token.id,last4:result.token.card.last4,brand:result.token.card.brand,exp_month:result.token.card.exp_month,exp_year:result.token.card.exp_year,exp:Math.round(+(new Date((new Date(result.token.card.exp_year,result.token.card.exp_month,1))-1))/1000)|0};$scope._process()}};$scope._process=function(){var data={"token":$scope.card.token,"use_stored_card":$scope.payment.use_stored_card,"save_card":$scope.payment.save_card,"customer_id":Customer.id||null};McommerceStripe.process(data).then(function(res){if(res){$state.go("mcommerce-sales-success",{value_id:$stateParams.value_id})}else{Dialog.alert("Error","Unexpected error","OK")}},function(err){Dialog.alert("Error","Unexpected error","OK")}).then(function(){$scope.is_loading=!1;$scope.isProcessing=!1;Loader.hide()})};$scope.right_button={action:$scope.process,label:$translate.instant('Pay','m_commerce')};$scope.loadContent()});angular.module('starter').controller('MCommerceSalesSuccessViewController',function($scope,$state,$stateParams,$timeout,Customer){$scope.value_id=$stateParams.value_id;if(Customer.guest_mode){Customer.guest_mode=!1;Customer.logout()}
$timeout(function(){$state.go('mcommerce-redirect',{value_id:$scope.value_id})},3000)});angular.module("starter").factory("McommerceCart",function($pwaRequest,$session){var factory={value_id:null};factory.find=function(){if(!this.value_id){return $pwaRequest.reject("[McommerceCart::find] missing value_id.")}
return $pwaRequest.get("mcommerce/mobile_cart/find",{urlParams:{value_id:this.value_id},cache:!1,refresh:!0})};factory.addProduct=function(form){if(!this.value_id){return $pwaRequest.reject("[McommerceCart::addProduct] missing value_id.")}
return $pwaRequest.post("mcommerce/mobile_cart/add",{urlParams:{value_id:this.value_id},data:{form:form}})};factory.adddiscount=function(discount_code,use_clean_code){if(!this.value_id){return use_clean_code?$pwaRequest.reject('[McommerceCart::adddiscount] missing value_id.'):$pwaRequest.resolve({success:!1})}
if(discount_code===undefined){return $pwaRequest.resolve({success:!0})}
if(discount_code.length===0&&!use_clean_code){return $pwaRequest.resolve({success:!0})}
return $pwaRequest.post('mcommerce/mobile_cart/adddiscount',{urlParams:{value_id:this.value_id},data:{discount_code:discount_code,customer_uuid:$session.getDeviceUid()}})};factory.addTip=function(cart){if(!this.value_id){return $pwaRequest.reject("[McommerceCart::addTip] missing value_id.")}
return $pwaRequest.post("mcommerce/mobile_cart/addtip",{urlParams:{value_id:this.value_id},data:{tip:cart.tip?cart.tip:0}})};factory.compute=function(){if(!this.value_id){return $pwaRequest.reject("[McommerceCart::compute] missing value_id.")}
return $pwaRequest.post("mcommerce/mobile_cart/compute",{urlParams:{value_id:this.value_id,customer_uuid:$session.getDeviceUid()}})};factory.deleteLine=function(line_id){if(!this.value_id||!line_id){return $pwaRequest.reject("[McommerceCart::deleteLine] missing value_id or line_id.")}
return $pwaRequest.get("mcommerce/mobile_cart/delete",{urlParams:{value_id:this.value_id,line_id:line_id},cache:!1,refresh:!0})};factory.modifyLine=function(line){if(!this.value_id){return $pwaRequest.reject("[McommerceCart::modifyLine] missing value_id.")}
return $pwaRequest.post("mcommerce/mobile_cart/modify",{data:{line_id:line.id,qty:line.qty,format:line.format}})};factory.useFidelityPoints=function(points){if(!this.value_id){return $pwaRequest.reject("[McommerceCart::useFidelityPoints] missing value_id.")}
return $pwaRequest.post("mcommerce/mobile_cart/usefidelitypointsforcart",{data:{points:points}})};factory.removeAllDiscount=function(){if(!this.value_id){return $pwaRequest.reject("[McommerceCart::removeAllDiscount] missing value_id.")}
return $pwaRequest.post("mcommerce/mobile_cart/removealldiscount")};return factory});angular.module("starter").factory("McommerceCategory",function($pwaRequest){var factory={value_id:null,category_id:null};factory.findAll=function(offset){if(!this.value_id){return $pwaRequest.reject("[McommerceCategory::findAll] missing value_id.")}
return $pwaRequest.get("mcommerce/mobile_category/findall",{urlParams:{value_id:this.value_id,category_id:this.category_id,offset:offset},cache:!1,refresh:!0}).then(function(data){if(data.displayed_per_page){factory.displayed_per_page=data.displayed_per_page}
return data})};return factory});angular.module("starter").factory("McommerceProduct",function($pwaRequest){var factory={value_id:null};factory.find=function(product_id){if(!this.value_id){return $pwaRequest.reject("[McommerceProduct::find] missing value_id.")}
return $pwaRequest.get("mcommerce/mobile_product/find",{urlParams:{value_id:this.value_id,product_id:product_id},cache:!1,refresh:!0})};return factory});angular.module('starter').factory('McommerceSalesCustomer',function($pwaRequest){var factory={value_id:null};factory.updateCustomerInfos=function(form){if(!this.value_id){return $pwaRequest.reject('[McommerceSalesCustomer::updateCustomerInfos] missing value_id.')}
return $pwaRequest.post('mcommerce/mobile_sales_customer/update',{urlParams:{value_id:this.value_id},data:{form:form,option_value_id:this.value_id}})};factory.find=function(){if(!this.value_id){return $pwaRequest.reject('[McommerceSalesCustomer::find] missing value_id.')}
return $pwaRequest.get('mcommerce/mobile_sales_customer/find',{urlParams:{value_id:this.value_id},cache:!1,refresh:!0})};factory.hasGuestMode=function(){if(!this.value_id){return $pwaRequest.reject('[McommerceSalesCustomer::hasGuestMode] missing value_id.')}
return $pwaRequest.get('mcommerce/mobile_sales_customer/hasguestmode',{urlParams:{value_id:this.value_id},cache:!1,refresh:!0})};factory.getOrderHistory=function(offset){if(!this.value_id){return $pwaRequest.reject('[McommerceSalesCustomer::getOrderHistory] missing value_id.')}
return $pwaRequest.get('mcommerce/mobile_sales_customer/getorders',{urlParams:{value_id:this.value_id,offset:offset},cache:!1,refresh:!0})};factory.getOrderDetails=function(order_id){if(!this.value_id){return $pwaRequest.reject('[McommerceSalesCustomer::getOrderDetails] missing value_id.')}
return $pwaRequest.get('mcommerce/mobile_sales_customer/getorderdetails',{urlParams:{value_id:this.value_id,order_id:order_id},cache:!1,refresh:!0})};return factory});angular.module("starter").factory("McommerceSalesDelivery",function($pwaRequest){var factory={value_id:null};factory.findStore=function(){if(!this.value_id){return $pwaRequest.reject("[McommerceSalesDelivery::findStore] missing value_id.")}
return $pwaRequest.get("mcommerce/mobile_sales_delivery/findstore",{urlParams:{value_id:this.value_id},cache:!1,refresh:!0})};factory.updateDeliveryInfos=function(form){if(!this.value_id){return $pwaRequest.reject("[McommerceSalesDelivery::updateDeliveryInfos] missing value_id.")}
return $pwaRequest.post("mcommerce/mobile_sales_delivery/update",{urlParams:{value_id:this.value_id},data:{form:form}})};return factory});angular.module('starter').factory('McommerceSalesPayment',function($pwaRequest,$session){var factory={value_id:null,notes:''};factory.findPaymentMethods=function(){if(!this.value_id){return $pwaRequest.reject('[McommerceSalesPayment::findPaymentMethods] missing value_id.')}
return $pwaRequest.get('mcommerce/mobile_sales_payment/findpaymentmethods',{urlParams:{value_id:this.value_id},cache:!1,refresh:!0})};factory.findOnlinePaymentUrl=function(){if(!this.value_id){return $pwaRequest.reject('[McommerceSalesPayment::findOnlinePaymentUrl] missing value_id.')}
return $pwaRequest.get('mcommerce/mobile_sales_payment/findonlinepaymenturl',{urlParams:{value_id:this.value_id},cache:!1,refresh:!0})};factory.updatePaymentInfos=function(form){if(!this.value_id){return $pwaRequest.reject('[McommerceSalesPayment::updatePaymentInfos] missing value_id.')}
return $pwaRequest.post('mcommerce/mobile_sales_payment/update',{urlParams:{value_id:this.value_id},data:{form:form}})};factory.validatePayment=function(){if(!this.value_id){return $pwaRequest.reject('[McommerceSalesPayment::validatePayment] missing value_id.')}
var formData={validate_payment:1,customer_uuid:$session.getDeviceUid(),notes:factory.notes||''};if(IS_NATIVE_APP){formData.is_ajax=!0}
return $pwaRequest.post('mcommerce/mobile_sales_payment/validatepayment',{urlParams:{value_id:this.value_id},data:formData})}
return factory});angular.module("starter").factory("McommerceSalesStorechoice",function($pwaRequest){var factory={value_id:null};factory.find=function(){if(!this.value_id){return $pwaRequest.reject("[McommerceSalesStorechoice::find] missing value_id.")}
return $pwaRequest.get("mcommerce/mobile_sales_storechoice/find",{urlParams:{value_id:this.value_id},cache:!1,refresh:!0})};factory.update=function(store_id){if(!this.value_id){return $pwaRequest.reject("[McommerceSalesStorechoice::update] missing value_id.")}
return $pwaRequest.post("mcommerce/mobile_sales_storechoice/update",{data:{store_id:store_id}})};return factory});angular.module("starter").factory("McommerceStripe",function($pwaRequest){var factory={value_id:null,StripeInstance:null};factory.find=function(cust_id){if(!this.value_id){return $pwaRequest.reject("[McommerceStripe::find] missing value_id.")}
return $pwaRequest.post("mcommerce/mobile_sales_stripe/find",{data:{customer_id:cust_id}})};factory.process=function(data){if(!this.value_id){return $pwaRequest.reject("[McommerceStripe::process] missing value_id.")}
return $pwaRequest.post("mcommerce/mobile_sales_stripe/process",{data:{value_id:this.value_id,token:data.token,customer_id:data.customer_id,use_stored_card:data.use_stored_card,save_card:data.save_card,notes:sessionStorage.getItem('mcommerce-notes')||""}})};factory.getCard=function(customer_id){if(!this.value_id){return $pwaRequest.reject("[McommerceStripe::getCard] missing value_id.")}
return $pwaRequest.post("mcommerce/mobile_sales_stripe/getcard",{data:{"value_id":this.value_id,"customer_id":customer_id}})};factory.removeCard=function(customer_id){if(!this.value_id){return $pwaRequest.reject("[McommerceStripe::removeCard] missing value_id.")}
return $pwaRequest.post("mcommerce/mobile_sales_stripe/removecard",{data:{"value_id":this.value_id,"customer_id":customer_id}})};return factory});Features.insertCSS(":root{--safe-area-inset-top:0;--safe-area-inset-right:0;--safe-area-inset-bottom:0;--safe-area-inset-left:0}@supports (padding-top:constant(safe-area-inset-top)){:root{--safe-area-inset-top:constant(safe-area-inset-top);--safe-area-inset-right:constant(safe-area-inset-right);--safe-area-inset-bottom:constant(safe-area-inset-bottom);--safe-area-inset-left:constant(safe-area-inset-left)}}@supports (padding-top:env(safe-area-inset-top)){:root{--safe-area-inset-top:env(safe-area-inset-top);--safe-area-inset-right:env(safe-area-inset-right);--safe-area-inset-bottom:env(safe-area-inset-bottom);--safe-area-inset-left:env(safe-area-inset-left)}}.platform-overview.platform-cordova{--safe-area-inset-top:1.5em;--safe-area-inset-right:0;--safe-area-inset-bottom:.5em;--safe-area-inset-left:0}.module-mcommerce .saved-card{font-weight:700;letter-spacing:0}.module-mcommerce .saved-card .last-star{transform:translateY(3px);display:inline-block}","m_commerce")