angular.module("starter").controller('MarketplaceHomeController',function($http,$rootScope,$scope,$stateParams,Url,$state,MarketPlace,Customer){$scope.$on("connectionStateChange",function(event,args){if(args.isOnline==!0){$scope.loadContent()}});console.log('Anjana Market place-new structure');$scope.is_loading=!0;$scope.value_id=MarketPlace.value_id=$stateParams.value_id;$scope.loadContent=function(){MarketPlace.findAll('stores').success(function(data){$scope.is_loading=!1;$scope.settings=data.settings;$scope.page_title=data.page_title;$rootScope.settings=$scope.settings;$rootScope.page_title=$scope.page_title;$scope.stores=data.store_data;$scope.mcommerce_id=data.mcommerce_id;MarketPlace.mcommerce_id=$scope.mcommerce_id})};$scope.goToStore=function(storeId){$state.go('marketplace-store',{store_id:storeId})};$scope.goToCreateStore=function(mcommerce_id){$state.go('marketplace-save-store',{id:mcommerce_id,type:'mcommerce_id'})};if(!Customer.isLoggedIn()){$rootScope.is_loading=!1;return Customer.loginModal(undefined,function(){$scope.loadContent()})}else{$scope.loadContent()}}).controller('MarketplaceStoreController',function($cordovaCamera,$http,$rootScope,$scope,$stateParams,Url,$state,MarketPlace,Modal){$scope.$on("connectionStateChange",function(event,args){if(args.isOnline==!0){$scope.loadContent()}});console.log('store contro');$scope.is_loading=!0;$scope.store_id=MarketPlace.store_id=$stateParams.store_id;$scope.loadContent=function(){MarketPlace.getStore().success(function(data){$scope.is_loading=!1;$scope.settings=$rootScope.settings;$scope.store_data=data.store_data;$scope.page_title=data.store_data.name})};if($scope.stores&&$scope.stores.length&&$scope.stores.length==1){$scope.is_loading=!1;$scope.settings=$rootScope.settings;$scope.store_data=$scope.stores[0];$scope.page_title=$scope.store_data.name;$scope.store_id=$scope.store_data.store_id}else{$scope.loadContent()}
$scope.openEditStore=function(){$state.go('marketplace-save-store',{id:$scope.store_data.store_id,type:'store_id'})};$scope.manageOrders=function(){$state.go('marketplace-orders',{store_id:$scope.store_data.store_id})};$scope.manageProducts=function(){$state.go('marketplace-products',{store_id:$scope.store_data.store_id})};$scope.showQR=function(){$scope.showUsersFriendsOrFollowersModal(MarketPlace.value_id,$scope.store_data.store_id,$scope.store_data.name)};$scope.showUsersFriendsOrFollowersModal=function(value_id,store_id,store_name){var _localScope=angular.extend($rootScope.$new(!0),{is_loading:!0,value_id:value_id,store_id:store_id,store_name:store_name,close:function(){$scope._showUsersFriendsOrFollowersModal.hide()}});Modal.fromTemplateUrl("./features/marketplace/assets/templates/l1/qr-code.html",{scope:_localScope,animation:"slide-in-right-left"}).then(function(modal){$scope._showUsersFriendsOrFollowersModal=modal;$scope._showUsersFriendsOrFollowersModal.show();return modal})}}).controller('MarketplaceSaveStoreController',function($cordovaCamera,$http,$ionicHistory,$translate,Dialog,$rootScope,$scope,$stateParams,Url,$state,MarketPlace,Picture,Modal){$scope.$on("connectionStateChange",function(event,args){if(args.isOnline==!0){$scope.loadContent()}});$scope.is_loading=!0;$scope.id=$stateParams.id;$scope.type=$stateParams.type;$scope.store_data=[];var factory_new={imageData:null,crop_modal:null};$scope.size='medium';$scope.crop_type='rectangle';$scope.imageDataURI='';$scope.resImageDataURI='';$scope.canvasScalemode='fit';$scope.resBlob={};$scope.urlBlob={};$scope.resImgFormat='image/jpeg';$scope.resImgQuality=1;$scope.selMinSize=100;$scope.selInitSize=[{w:300,h:150}];$scope.resImgSize=[{w:300,h:400},{w:400,h:550}];if($scope.type==='store_id'){MarketPlace.store_id=$scope.id}else{MarketPlace.store_id=null}
console.log('save store='+MarketPlace.store_id);$scope.loadContent=function(){MarketPlace.getStore().success(function(data){$scope.is_loading=!1;$scope.store_data=data.store_data;$scope.taxes=data.taxes;$scope.days=data.days;$scope.settings=$rootScope.settings;if(data.store_data.name){$scope.page_title=data.store_data.name}else{$scope.page_title='Create '+($scope.settings.text_store?$scope.settings.text_store:'Store')}})};$scope.loadContent();$scope.takePicture=function(field){Picture.takePicture().then(function(success){$scope.imageDataURI=success.image;factory_new.openCropModal()})};$scope.addPicture=function(picture){$scope.store_data.icon=picture;$scope.store_data.picture=picture};$scope.removePicture=function(icon){$scope.store_data.icon='';$scope.store_data.picture=''};$scope.addArea=function(){if(!$scope.store_data.cost_and_delivery_area){$scope.store_data.cost_and_delivery_area=[]}
$scope.store_data.cost_and_delivery_area.push({'area':'','cost':'','radius':''})};$scope.removeArea=function(index){$scope.store_data.cost_and_delivery_area.splice(index,1)};$scope.addSchedule=function(){if(!$scope.store_data.scheduler){$scope.store_data.scheduler=[]}
var default_time=("0"+new Date().getHours()).slice(-2)+':'+("0"+new Date().getMinutes()).slice(-2);$scope.store_data.scheduler.push({'day':'Monday','open':default_time,'closed':default_time})};$scope.removeSchedule=function(index){$scope.store_data.scheduler.splice(index,1)};$scope.showPaypalFields=function(method_id){if($scope.store_data.payment_methods[method_id]){if(!$scope.store_data.paypal_checked){$scope.store_data.paypal_checked=[]}
$scope.store_data.paypal_checked.push(method_id)}else{if($scope.store_data.paypal_checked.length){var index=$scope.store_data.paypal_checked.indexOf(method_id);if(index!==-1)$scope.store_data.paypal_checked.splice(index,1);delete $scope.store_data.details_payment_methods[method_id]}}};$scope.isDate=function(date){return(new Date(date)!=="Invalid Date"&&!isNaN(new Date(date)))?!0:!1};$scope.post=function(){MarketPlace.record_id=$scope.id;$scope.store_data.value_id=MarketPlace.value_id;var required_fields={'price':'Shipping / delivery fees','min_amount_for_free_delivery':'Free shipping / delivery starting from',};var errors=[];var is_valid=!0;if($scope.store_data.delivery_methods[3]){angular.forEach(required_fields,function(value,key){if(key==='price'||key==='min_amount_for_free_delivery'){if($scope.store_data.details_delivery_methods[3][key]===''||$scope.store_data.details_delivery_methods[3][key]===null||$scope.store_data.details_delivery_methods[3][key]==='undefined'){is_valid=!1;errors.push(value)}}else{if($scope.store_data[key]===''||$scope.store_data[key]===null||$scope.store_data[key]==='undefined'){is_valid=!1;errors.push(value)}}})}
if(is_valid){$scope.is_loading=!0;var scheduler=$scope.store_data.scheduler;angular.forEach(scheduler,function(value,key){var openDate=$scope.store_data.scheduler[key].open;var closedDate=$scope.store_data.scheduler[key].closed;console.log(openDate+','+closedDate);if($scope.isDate(openDate)){var dt_open=new Date(openDate);$scope.store_data.scheduler[key].open=("0"+dt_open.getHours()).slice(-2)+':'+("0"+dt_open.getMinutes()).slice(-2)}
if($scope.isDate(closedDate)){var dt_closed=new Date(closedDate);$scope.store_data.scheduler[key].closed=("0"+dt_closed.getHours()).slice(-2)+':'+("0"+dt_closed.getMinutes()).slice(-2)}});MarketPlace.post($scope.store_data,'store').success(function(data){$scope.is_loading=!1;if(data.success){console.log('store saved success');$ionicHistory.goBack(-1);Dialog.alert("",data.message,$translate.instant("OK"))}})}else{Dialog.alert("Error",$translate.instant("Changes not saved, please fill required fields in delivary options marked with (*)."),$translate.instant("OK"))}};factory_new.openCropModal=function(){if($rootScope.isNotAvailableOffline()){return!1}
factory_new.imageData={size:$scope.size,type:$scope.crop_type,canvasScalemode:$scope.canvasScalemode,resImgFormat:$scope.resImgFormat,resImgQuality:$scope.resImgQuality,selMinSize:$scope.selMinSize,selInitSize:$scope.selInitSize,resImgSize:$scope.resImgSize,imageDataURI:$scope.imageDataURI,resImageDataURI:$scope.resImageDataURI};var modalScope=$rootScope.$new(!0);modalScope.$on('modal.shown',function(){console.log('modal shown');var saveImage=modalScope.$on('marketplace.saveCroppedImage',function(){$scope.addPicture(factory_new.imageData.resImageDataURI);factory_new.crop_modal.hide()});factory_new.crop_modal_hidden_subscriber=modalScope.$on('modal.hidden',function(){factory_new.crop_modal_hidden_subscriber();saveImage()})});var layout='./features/marketplace/assets/templates/l1/image-crop-modal.html';return Modal.fromTemplateUrl(layout,{scope:angular.extend(modalScope,{imageData:factory_new.imageData}),animation:'slide-in-up'}).then(function(modal){factory_new.crop_modal=modal;factory_new.crop_modal.show();return modal})};$scope.$on("marketplace.closeModal",function(){factory_new.crop_modal.hide();$scope.addPicture(factory_new.imageData.resImageDataURI)})}).controller('MarketplaceOrdersController',function($cordovaCamera,$http,$rootScope,$scope,$stateParams,Url,$state,MarketPlace){$scope.$on("connectionStateChange",function(event,args){if(args.isOnline==!0){$scope.loadContent()}});$scope.is_loading=!0;$scope.store_id=MarketPlace.store_id=$stateParams.store_id;$scope.loadContent=function(){MarketPlace.findAll('orders').success(function(data){$scope.is_loading=!1;$scope.settings=$rootScope.settings;$scope.orders=data.orders;$scope.customer_name=data.customer_name;$scope.page_title=$rootScope.page_title})};$scope.loadContent();$scope.openOrder=function(id){$state.go('marketplace-edit-order',{store_id:$scope.store_id,id:id})}}).controller('MarketplaceEditOrderController',function($ionicHistory,Dialog,$translate,$http,$rootScope,$scope,$stateParams,Url,$state,MarketPlace){$scope.$on("connectionStateChange",function(event,args){if(args.isOnline==!0){$scope.loadContent()}});$scope.is_loading=!0;$scope.order=[];$scope.store_id=MarketPlace.store_id=$stateParams.store_id;MarketPlace.record_id=$stateParams.id;$scope.loadContent=function(){MarketPlace.getOrderOrProduct('order').success(function(data){$scope.is_loading=!1;$scope.order=data.order;$scope.settings=$rootScope.settings;$scope.page_title=($scope.settings.text_orders?$scope.settings.text_orders:'Order')+' - '+$scope.order.number;$scope.order.metadatas.birthday=new Date($scope.order.metadatas.birthday)})};$scope.loadContent();$scope.post=function(){MarketPlace.post($scope.order,'order').success(function(data){$scope.is_loading=!1;if(data.success){console.log('order saved success');$ionicHistory.goBack(-1);Dialog.alert("",data.message,$translate.instant("OK"))}})}}).controller('MarketplaceProductsController',function($http,$rootScope,$scope,$stateParams,Url,$state,MarketPlace){$scope.$on("connectionStateChange",function(event,args){if(args.isOnline==!0){$scope.loadContent()}});$scope.is_loading=!0;$scope.store_id=MarketPlace.store_id=$stateParams.store_id;$scope.loadContent=function(){MarketPlace.findAll('products').success(function(data){$scope.is_loading=!1;$scope.settings=$rootScope.settings;$scope.products=data.products;$scope.page_title=$rootScope.page_title})};$scope.loadContent();$scope.openEditView=function(id){$state.go('marketplace-update-product',{store_id:$scope.store_id,id:id})};$scope.addProduct=function(){$state.go('marketplace-update-product',{store_id:$scope.store_id,id:0})}}).controller('MarketplaceUpdateProductController',function($ionicHistory,Dialog,$translate,$http,$rootScope,$scope,$stateParams,Url,$state,MarketPlace,Picture,Modal){$scope.$on("connectionStateChange",function(event,args){if(args.isOnline==!0){$scope.loadContent()}});$scope.is_loading=!0;$scope.product=[];$scope.store_id=MarketPlace.store_id=$stateParams.store_id;MarketPlace.record_id=$stateParams.id;var factory_new={imageData:null,crop_modal:null};$scope.size='medium';$scope.crop_type='rectangle';$scope.imageDataURI='';$scope.resImageDataURI='';$scope.canvasScalemode='fit';$scope.resBlob={};$scope.urlBlob={};$scope.resImgFormat='image/jpeg';$scope.resImgQuality=1;$scope.selMinSize=100;$scope.selInitSize=[{w:200,h:150}];$scope.resImgSize=[{w:400,h:380},{w:500,h:450}];$scope.loadContent=function(){MarketPlace.getOrderOrProduct('product').success(function(data){$scope.is_loading=!1;$scope.product=data.product;$scope.taxes=data.taxes;$scope.categories=data.categories;$scope.options_list=data.options_list;$scope.choices_list=data.choices_list;$scope.settings=$rootScope.settings;if($scope.product.name){$scope.page_title=$scope.product.name}else{$scope.page_title='Add '+($scope.settings.text_products?$scope.settings.text_products:'Product')}})};$scope.loadContent();$scope.takePicture=function(field){Picture.takePicture().then(function(success){$scope.imageDataURI=success.image;factory_new.openCropModal()})};$scope.addPicture=function(picture){if(!$scope.product.picture_list){$scope.product.picture_list=[]}
if(!$scope.product.pictures){$scope.product.pictures=[]}
$scope.imageDataURI=picture;$scope.product.picture_list.push(picture);$scope.product.pictures.push({'id':0,'url':picture})};$scope.removePicture=function(index,id){console.log(id+'remove='+index);if(id){if(!$scope.product.remove_picture){$scope.product.remove_picture=[]}
$scope.product.remove_picture.push(id)}else{if($scope.product.picture_list){$scope.product.picture_list.splice(index,1)}}
$scope.product.pictures.splice(index,1)};$scope.removeFormat=function(id){console.log(id+'remove format='+id);$scope.product.product_formats[id].is_deleted=1};$scope.post=function(){$scope.product.value_id=MarketPlace.value_id;$scope.product.store_id=MarketPlace.store_id;$scope.product.mcommerce_id=$rootScope.mcommerce_id;MarketPlace.post($scope.product,'product').success(function(data){$scope.is_loading=!1;if(data.success){$ionicHistory.goBack(-1);Dialog.alert("",data.message,$translate.instant("OK"))}})};factory_new.openCropModal=function(){if($rootScope.isNotAvailableOffline()){return!1}
factory_new.imageData={size:$scope.size,type:$scope.crop_type,canvasScalemode:$scope.canvasScalemode,resImgFormat:$scope.resImgFormat,resImgQuality:$scope.resImgQuality,selMinSize:$scope.selMinSize,selInitSize:$scope.selInitSize,resImgSize:$scope.resImgSize,imageDataURI:$scope.imageDataURI,resImageDataURI:$scope.resImageDataURI};var modalScope=$rootScope.$new(!0);modalScope.$on('modal.shown',function(){console.log('modal shown');var saveImage=modalScope.$on('marketplace.saveCroppedImage',function(){$scope.addPicture(factory_new.imageData.resImageDataURI);factory_new.crop_modal.hide()});factory_new.crop_modal_hidden_subscriber=modalScope.$on('modal.hidden',function(){factory_new.crop_modal_hidden_subscriber();saveImage()})});var layout='./features/marketplace/assets/templates/l1/image-crop-modal.html';return Modal.fromTemplateUrl(layout,{scope:angular.extend(modalScope,{imageData:factory_new.imageData}),animation:'slide-in-up'}).then(function(modal){factory_new.crop_modal=modal;factory_new.crop_modal.show();return modal})};$scope.$on("marketplace.closeModal",function(){factory_new.crop_modal.hide();$scope.addPicture(factory_new.imageData.resImageDataURI)})}).controller('MarketplaceQrCodeController',function($scope,$state,$stateParams,$rootScope,$http,Url){$scope.settings=$rootScope.settings;$http({method:'GET',url:Url.get("marketplace/mobile_store/get-qr-setup",{value_id:$scope.value_id,store_id:$scope.store_id}),cache:!1,responseType:'json'}).success(function(data){$scope.qrcode_urls=data.qrcode_urls;$scope.is_loading=!1})}).controller('imageCropModalController',function($scope,$state,$stateParams,$rootScope){$scope.closeModal=function(){$rootScope.$broadcast("marketplace.closeModal")};$scope.saveCroppedImage=function(){$rootScope.$broadcast("marketplace.saveCroppedImage")}});angular.module("starter").factory('MarketPlace',function($rootScope,$http,Url){var factory={};factory.value_id=null;factory.store_id=null;factory.record_id=null;factory.mcommerce_id=null;factory.findAll=function(type){var endpoint;var params;if(type==='stores'){if(!this.value_id)return;endpoint="marketplace/mobile_home/load-stores";params={value_id:this.value_id,mcommerce_id:this.mcommerce_id}}
if(type==='orders'){if(!this.store_id)return;endpoint="marketplace/mobile_order/find-all";params={store_id:this.store_id,value_id:this.value_id,mcommerce_id:this.mcommerce_id}}
if(type==='products'){if(!this.store_id)return;endpoint="marketplace/mobile_product/find-all";params={store_id:this.store_id,value_id:this.value_id,mcommerce_id:this.mcommerce_id}}
return $http({method:'GET',url:Url.get(endpoint,params),cache:!1,responseType:'json'})};factory.getStore=function(){console.log('get store = '+this.store_id);return $http({method:'GET',url:Url.get("marketplace/mobile_store/get-store",{store_id:this.store_id,mcommerce_id:this.mcommerce_id}),cache:!1,responseType:'json'})};factory.getOrderOrProduct=function(type){if(!this.record_id)return;var endpoint="marketplace/mobile_product/find-product";var params={id:this.record_id,value_id:this.value_id,store_id:this.store_id,mcommerce_id:this.mcommerce_id};if(type==='order'){endpoint="marketplace/mobile_order/find-order";params={id:this.record_id,value_id:this.value_id,store_id:this.store_id}}
return $http({method:'GET',url:Url.get(endpoint,params),cache:!1,responseType:'json'})};factory.post=function(form,type){if(!this.record_id)return;var url;if(type==='store'){url="marketplace/mobile_store/save-store"}
if(type==='order'){url="marketplace/mobile_order/save-order"}
if(type==='product'){url="marketplace/mobile_product/save-product"}
var data={form:form};return $http.post(Url.get(url,{id:this.record_id,store_id:this.store_id}),data)};return factory});'use strict';angular.module("starter").factory('cropAreaCircle',['cropArea',function(CropArea){var CropAreaCircle=function(){CropArea.apply(this,arguments);this._boxResizeBaseSize=25;this._boxResizeNormalRatio=1;this._boxResizeHoverRatio=1.2;this._iconMoveNormalRatio=0.9;this._iconMoveHoverRatio=1.2;this._boxResizeNormalSize=this._boxResizeBaseSize*this._boxResizeNormalRatio;this._boxResizeHoverSize=this._boxResizeBaseSize*this._boxResizeHoverRatio;this._posDragStartX=0;this._posDragStartY=0;this._posResizeStartX=0;this._posResizeStartY=0;this._posResizeStartSize=0;this._boxResizeIsHover=!1;this._areaIsHover=!1;this._boxResizeIsDragging=!1;this._areaIsDragging=!1};CropAreaCircle.prototype=new CropArea();CropAreaCircle.prototype.getType=function(){return'circle'};CropAreaCircle.prototype._calcCirclePerimeterCoords=function(angleDegrees){var hSize=this._size.w/2;var angleRadians=angleDegrees*(Math.PI/180),circlePerimeterX=this.getCenterPoint().x+hSize*Math.cos(angleRadians),circlePerimeterY=this.getCenterPoint().y+hSize*Math.sin(angleRadians);return[circlePerimeterX,circlePerimeterY]};CropAreaCircle.prototype._calcResizeIconCenterCoords=function(){return this._calcCirclePerimeterCoords(-45)};CropAreaCircle.prototype._isCoordWithinArea=function(coord){return Math.sqrt((coord[0]-this.getCenterPoint().x)*(coord[0]-this.getCenterPoint().x)+(coord[1]-this.getCenterPoint().y)*(coord[1]-this.getCenterPoint().y))<this._size.w/2};CropAreaCircle.prototype._isCoordWithinBoxResize=function(coord){var resizeIconCenterCoords=this._calcResizeIconCenterCoords();var hSize=this._boxResizeHoverSize/2;return(coord[0]>resizeIconCenterCoords[0]-hSize&&coord[0]<resizeIconCenterCoords[0]+hSize&&coord[1]>resizeIconCenterCoords[1]-hSize&&coord[1]<resizeIconCenterCoords[1]+hSize)};CropAreaCircle.prototype._drawArea=function(ctx,centerCoords,size){ctx.arc(centerCoords.x,centerCoords.y,size.w/2,0,2*Math.PI)};CropAreaCircle.prototype.draw=function(){CropArea.prototype.draw.apply(this,arguments);var center=this.getCenterPoint();this._cropCanvas.drawIconMove([center.x,center.y],this._areaIsHover?this._iconMoveHoverRatio:this._iconMoveNormalRatio);this._cropCanvas.drawIconResizeBoxNESW(this._calcResizeIconCenterCoords(),this._boxResizeBaseSize,this._boxResizeIsHover?this._boxResizeHoverRatio:this._boxResizeNormalRatio)};CropAreaCircle.prototype.setSizeByScale=function(scale){var center=this.getCenterPoint();var size=this.getSize();var newRadius=size.w*scale/2;var northWestPoint={x:center.x-newRadius,y:center.y-newRadius};var southEastPoint={x:center.x+newRadius,y:center.y+newRadius};this.circleOnMove(northWestPoint,southEastPoint);this._events.trigger('area-resize')};CropAreaCircle.prototype.processMouseMove=function(mouseCurX,mouseCurY){var cursor='default';var res=!1;this._boxResizeIsHover=!1;this._areaIsHover=!1;if(this._areaIsDragging){this.setCenterPointOnMove({x:mouseCurX-this._posDragStartX,y:mouseCurY-this._posDragStartY});this._areaIsHover=!0;cursor='move';res=!0;this._events.trigger('area-move')}else if(this._boxResizeIsDragging){cursor='nesw-resize';var iFR,iFX,iFY;iFX=mouseCurX-this._posResizeStartX;iFY=this._posResizeStartY-mouseCurY;if(iFX>iFY){iFR=this._posResizeStartSize.w+iFY*2}else{iFR=this._posResizeStartSize.w+iFX*2}
var newNO={},newSE={};newNO.x=this.getCenterPoint().x-iFR*0.5;newSE.x=this.getCenterPoint().x+iFR*0.5;newNO.y=this.getCenterPoint().y-iFR*0.5;newSE.y=this.getCenterPoint().y+iFR*0.5;this.circleOnMove(newNO,newSE);this._boxResizeIsHover=!0;res=!0;this._events.trigger('area-resize')}else if(this._isCoordWithinBoxResize([mouseCurX,mouseCurY])){cursor='nesw-resize';this._areaIsHover=!1;this._boxResizeIsHover=!0;res=!0}else if(this._isCoordWithinArea([mouseCurX,mouseCurY])){cursor='move';this._areaIsHover=!0;res=!0}
angular.element(this._ctx.canvas).css({'cursor':cursor});return res};CropAreaCircle.prototype.processMouseDown=function(mouseDownX,mouseDownY){if(this._isCoordWithinBoxResize([mouseDownX,mouseDownY])){this._areaIsDragging=!1;this._areaIsHover=!1;this._boxResizeIsDragging=!0;this._boxResizeIsHover=!0;this._posResizeStartX=mouseDownX;this._posResizeStartY=mouseDownY;this._posResizeStartSize=this._size;this._events.trigger('area-resize-start')}else if(this._isCoordWithinArea([mouseDownX,mouseDownY])){this._areaIsDragging=!0;this._areaIsHover=!0;this._boxResizeIsDragging=!1;this._boxResizeIsHover=!1;var center=this.getCenterPoint();this._posDragStartX=mouseDownX-center.x;this._posDragStartY=mouseDownY-center.y;this._events.trigger('area-move-start')}};CropAreaCircle.prototype.processMouseUp=function(){if(this._areaIsDragging){this._areaIsDragging=!1;this._events.trigger('area-move-end')}
if(this._boxResizeIsDragging){this._boxResizeIsDragging=!1;this._events.trigger('area-resize-end')}
this._areaIsHover=!1;this._boxResizeIsHover=!1;this._posDragStartX=0;this._posDragStartY=0};return CropAreaCircle}]);angular.module('starter').factory('cropAreaRectangle',['cropArea',function(CropArea){var CropAreaRectangle=function(){CropArea.apply(this,arguments);this._resizeCtrlBaseRadius=15;this._resizeCtrlNormalRatio=0.6;this._resizeCtrlHoverRatio=0.70;this._iconMoveNormalRatio=0.9;this._iconMoveHoverRatio=1.2;this._resizeCtrlNormalRadius=this._resizeCtrlBaseRadius*this._resizeCtrlNormalRatio;this._resizeCtrlHoverRadius=this._resizeCtrlBaseRadius*this._resizeCtrlHoverRatio;this._posDragStartX=0;this._posDragStartY=0;this._posResizeStartX=0;this._posResizeStartY=0;this._posResizeStartSize={w:0,h:0};this._resizeCtrlIsHover=-1;this._areaIsHover=!1;this._resizeCtrlIsDragging=-1;this._areaIsDragging=!1};CropAreaRectangle.prototype=new CropArea();CropAreaRectangle.prototype.getType=function(){return'rectangle'};CropAreaRectangle.prototype._calcRectangleCorners=function(){var size=this.getSize();var se=this.getSouthEastBound();return[[size.x,size.y],[se.x,size.y],[size.x,se.y],[se.x,se.y]]};CropAreaRectangle.prototype._calcRectangleDimensions=function(){var size=this.getSize();var se=this.getSouthEastBound();return{left:size.x,top:size.y,right:se.x,bottom:se.y}};CropAreaRectangle.prototype._isCoordWithinArea=function(coord){var rectangleDimensions=this._calcRectangleDimensions();return(coord[0]>=rectangleDimensions.left&&coord[0]<=rectangleDimensions.right&&coord[1]>=rectangleDimensions.top&&coord[1]<=rectangleDimensions.bottom)};CropAreaRectangle.prototype._isCoordWithinResizeCtrl=function(coord){var resizeIconsCenterCoords=this._calcRectangleCorners();var res=-1;for(var i=0,len=resizeIconsCenterCoords.length;i<len;i++){var resizeIconCenterCoords=resizeIconsCenterCoords[i];if(coord[0]>resizeIconCenterCoords[0]-this._resizeCtrlHoverRadius&&coord[0]<resizeIconCenterCoords[0]+this._resizeCtrlHoverRadius&&coord[1]>resizeIconCenterCoords[1]-this._resizeCtrlHoverRadius&&coord[1]<resizeIconCenterCoords[1]+this._resizeCtrlHoverRadius){res=i;break}}
return res};CropAreaRectangle.prototype._drawArea=function(ctx,center,size){ctx.rect(size.x,size.y,size.w,size.h)};CropAreaRectangle.prototype.draw=function(){CropArea.prototype.draw.apply(this,arguments);var center=this.getCenterPoint();this._cropCanvas.drawIconMove([center.x,center.y],this._areaIsHover?this._iconMoveHoverRatio:this._iconMoveNormalRatio);var resizeIconsCenterCoords=this._calcRectangleCorners();for(var i=0,len=resizeIconsCenterCoords.length;i<len;i++){var resizeIconCenterCoords=resizeIconsCenterCoords[i];this._cropCanvas.drawIconResizeBoxBase(resizeIconCenterCoords,this._resizeCtrlBaseRadius,this._resizeCtrlIsHover===i?this._resizeCtrlHoverRatio:this._resizeCtrlNormalRatio)}};CropAreaRectangle.prototype.setSizeByScale=function(scale,direction){var center=this.getCenterPoint();var size=this.getSize();var northWestPoint;var southEastPoint;if(this._aspect){var newWidth=size.w*scale;var newHeight=size.h*scale;northWestPoint={x:center.x-(newWidth/2),y:center.y-(newHeight/2)};southEastPoint={x:center.x+(newWidth/2),y:center.y+(newHeight/2)}}else{northWestPoint={x:size.x,y:size.y};southEastPoint={x:size.x+size.w,y:size.y+size.h};switch(direction){case 'up':case 'down':southEastPoint.y=size.y+(size.h*scale);break;case 'left':case 'right':southEastPoint.x=size.x+(size.w*scale);break}}
this.setSizeByCorners(northWestPoint,southEastPoint);this._events.trigger('area-resize')};CropAreaRectangle.prototype.processMouseMove=function(mouseCurX,mouseCurY){var cursor='default';var res=!1;this._resizeCtrlIsHover=-1;this._areaIsHover=!1;if(this._areaIsDragging){this.setCenterPointOnMove({x:mouseCurX-this._posDragStartX,y:mouseCurY-this._posDragStartY});this._areaIsHover=!0;cursor='move';res=!0;this._events.trigger('area-move')}else if(this._resizeCtrlIsDragging>-1){var s=this.getSize();var se=this.getSouthEastBound();var posX=mouseCurX;switch(this._resizeCtrlIsDragging){case 0:if(this._aspect){posX=se.x-((se.y-mouseCurY)*this._aspect)}
this.setSizeByCorners({x:posX,y:mouseCurY},{x:se.x,y:se.y});cursor='nwse-resize';break;case 1:if(this._aspect){posX=s.x+((se.y-mouseCurY)*this._aspect)}
this.setSizeByCorners({x:s.x,y:mouseCurY},{x:posX,y:se.y});cursor='nesw-resize';break;case 2:if(this._aspect){posX=se.x-((mouseCurY-s.y)*this._aspect)}
this.setSizeByCorners({x:posX,y:s.y},{x:se.x,y:mouseCurY});cursor='nesw-resize';break;case 3:if(this._aspect){posX=s.x+((mouseCurY-s.y)*this._aspect)}
this.setSizeByCorners({x:s.x,y:s.y},{x:posX,y:mouseCurY});cursor='nwse-resize';break}
this._resizeCtrlIsHover=this._resizeCtrlIsDragging;res=!0;this._events.trigger('area-resize')}else{var hoveredResizeBox=this._isCoordWithinResizeCtrl([mouseCurX,mouseCurY]);if(hoveredResizeBox>-1){switch(hoveredResizeBox){case 0:cursor='nwse-resize';break;case 1:cursor='nesw-resize';break;case 2:cursor='nesw-resize';break;case 3:cursor='nwse-resize';break}
this._areaIsHover=!1;this._resizeCtrlIsHover=hoveredResizeBox;res=!0}else if(this._isCoordWithinArea([mouseCurX,mouseCurY])){cursor='move';this._areaIsHover=!0;res=!0}}
angular.element(this._ctx.canvas).css({'cursor':cursor});return res};CropAreaRectangle.prototype.processMouseDown=function(mouseDownX,mouseDownY){var isWithinResizeCtrl=this._isCoordWithinResizeCtrl([mouseDownX,mouseDownY]);if(isWithinResizeCtrl>-1){this._areaIsDragging=!1;this._areaIsHover=!1;this._resizeCtrlIsDragging=isWithinResizeCtrl;this._resizeCtrlIsHover=isWithinResizeCtrl;this._posResizeStartX=mouseDownX;this._posResizeStartY=mouseDownY;this._posResizeStartSize=this._size;this._events.trigger('area-resize-start')}else if(this._isCoordWithinArea([mouseDownX,mouseDownY])){this._areaIsDragging=!0;this._areaIsHover=!0;this._resizeCtrlIsDragging=-1;this._resizeCtrlIsHover=-1;var center=this.getCenterPoint();this._posDragStartX=mouseDownX-center.x;this._posDragStartY=mouseDownY-center.y;this._events.trigger('area-move-start')}};CropAreaRectangle.prototype.processMouseUp=function(){if(this._areaIsDragging){this._areaIsDragging=!1;this._events.trigger('area-move-end')}
if(this._resizeCtrlIsDragging>-1){this._resizeCtrlIsDragging=-1;this._events.trigger('area-resize-end')}
this._areaIsHover=!1;this._resizeCtrlIsHover=-1;this._posDragStartX=0;this._posDragStartY=0};return CropAreaRectangle}]);angular.module('starter').factory('cropAreaSquare',['cropArea',function(CropArea){var CropAreaSquare=function(){CropArea.apply(this,arguments);this._resizeCtrlBaseRadius=15;this._resizeCtrlNormalRatio=0.6;this._resizeCtrlHoverRatio=0.70;this._iconMoveNormalRatio=0.9;this._iconMoveHoverRatio=1.2;this._resizeCtrlNormalRadius=this._resizeCtrlBaseRadius*this._resizeCtrlNormalRatio;this._resizeCtrlHoverRadius=this._resizeCtrlBaseRadius*this._resizeCtrlHoverRatio;this._posDragStartX=0;this._posDragStartY=0;this._posResizeStartX=0;this._posResizeStartY=0;this._posResizeStartSize=0;this._resizeCtrlIsHover=-1;this._areaIsHover=!1;this._resizeCtrlIsDragging=-1;this._areaIsDragging=!1};CropAreaSquare.prototype=new CropArea();CropAreaSquare.prototype.getType=function(){return'square'};CropAreaSquare.prototype._calcSquareCorners=function(){var size=this.getSize(),se=this.getSouthEastBound();return[[size.x,size.y],[se.x,size.y],[size.x,se.y],[se.x,se.y]]};CropAreaSquare.prototype._calcSquareDimensions=function(){var size=this.getSize(),se=this.getSouthEastBound();return{left:size.x,top:size.y,right:se.x,bottom:se.y}};CropAreaSquare.prototype._isCoordWithinArea=function(coord){var squareDimensions=this._calcSquareDimensions();return(coord[0]>=squareDimensions.left&&coord[0]<=squareDimensions.right&&coord[1]>=squareDimensions.top&&coord[1]<=squareDimensions.bottom)};CropAreaSquare.prototype._isCoordWithinResizeCtrl=function(coord){var resizeIconsCenterCoords=this._calcSquareCorners();var res=-1;for(var i=0,len=resizeIconsCenterCoords.length;i<len;i++){var resizeIconCenterCoords=resizeIconsCenterCoords[i];if(coord[0]>resizeIconCenterCoords[0]-this._resizeCtrlHoverRadius&&coord[0]<resizeIconCenterCoords[0]+this._resizeCtrlHoverRadius&&coord[1]>resizeIconCenterCoords[1]-this._resizeCtrlHoverRadius&&coord[1]<resizeIconCenterCoords[1]+this._resizeCtrlHoverRadius){res=i;break}}
return res};CropAreaSquare.prototype._drawArea=function(ctx,centerCoords,size){ctx.rect(size.x,size.y,size.w,size.h)};CropAreaSquare.prototype.draw=function(){CropArea.prototype.draw.apply(this,arguments);var center=this.getCenterPoint();this._cropCanvas.drawIconMove([center.x,center.y],this._areaIsHover?this._iconMoveHoverRatio:this._iconMoveNormalRatio);var resizeIconsCenterCoords=this._calcSquareCorners();for(var i=0,len=resizeIconsCenterCoords.length;i<len;i++){var resizeIconCenterCoords=resizeIconsCenterCoords[i];this._cropCanvas.drawIconResizeBoxBase(resizeIconCenterCoords,this._resizeCtrlBaseRadius,this._resizeCtrlIsHover===i?this._resizeCtrlHoverRatio:this._resizeCtrlNormalRatio)}};CropAreaSquare.prototype._clampPoint=function(x,y){var size=this._ctx.canvas.width;if(x<0){y-=Math.abs(x);x=0}
if(y<0){x-=Math.abs(y);y=0}
if(x>size){y-=(size-x);x=size}
if(y>size){x-=(size-y);y=size}
return{x:x,y:y}};CropAreaSquare.prototype.setSizeByScale=function(scale){var center=this.getCenterPoint();var size=this.getSize();var newSize=size.w*scale;if(newSize<this._minSize.w){newSize=this._minSize.w}
var northWestPoint={x:center.x-(newSize/2),y:center.y-(newSize/2)};var southEastPoint={x:center.x+(newSize/2),y:center.y+(newSize/2)};this.setSizeByCorners(northWestPoint,southEastPoint);this._events.trigger('area-resize')};CropAreaSquare.prototype.processMouseMove=function(mouseCurX,mouseCurY){var cursor='default';var res=!1;this._resizeCtrlIsHover=-1;this._areaIsHover=!1;if(this._areaIsDragging){this.setCenterPointOnMove({x:mouseCurX-this._posDragStartX,y:mouseCurY-this._posDragStartY});this._areaIsHover=!0;cursor='move';res=!0;this._events.trigger('area-move')}else if(this._resizeCtrlIsDragging>-1){var xMulti,yMulti;switch(this._resizeCtrlIsDragging){case 0:xMulti=-1;yMulti=-1;cursor='nwse-resize';break;case 1:xMulti=1;yMulti=-1;cursor='nesw-resize';break;case 2:xMulti=-1;yMulti=1;cursor='nesw-resize';break;case 3:xMulti=1;yMulti=1;cursor='nwse-resize';break}
var iFX=(mouseCurX-this._posResizeStartX)*xMulti,iFY=(mouseCurY-this._posResizeStartY)*yMulti,iFR;if(iFX>iFY){iFR=this._posResizeStartSize.w+iFY}else{iFR=this._posResizeStartSize.w+iFX}
var newSize=Math.max(this._minSize.w,iFR),newNO={},newSE={},newSO={},newNE={},s=this.getSize(),se=this.getSouthEastBound();switch(this._resizeCtrlIsDragging){case 0:newNO.x=se.x-newSize;newNO.y=se.y-newSize;newNO=this._clampPoint(newNO.x,newNO.y);this.setSizeByCorners(newNO,{x:se.x,y:se.y});cursor='nwse-resize';break;case 1:newNE.x=s.x+newSize;newNE.y=se.y-newSize;newNE=this._clampPoint(newNE.x,newNE.y);this.setSizeByCorners({x:s.x,y:newNE.y},{x:newNE.x,y:se.y});cursor='nesw-resize';break;case 2:newSO.x=se.x-newSize;newSO.y=s.y+newSize;newSO=this._clampPoint(newSO.x,newSO.y);this.setSizeByCorners({x:newSO.x,y:s.y},{x:se.x,y:newSO.y});cursor='nesw-resize';break;case 3:newSE.x=s.x+newSize;newSE.y=s.y+newSize;newSE=this._clampPoint(newSE.x,newSE.y);this.setSizeByCorners({x:s.x,y:s.y},newSE);cursor='nwse-resize';break}
this._resizeCtrlIsHover=this._resizeCtrlIsDragging;res=!0;this._events.trigger('area-resize')}else{var hoveredResizeBox=this._isCoordWithinResizeCtrl([mouseCurX,mouseCurY]);if(hoveredResizeBox>-1){switch(hoveredResizeBox){case 0:cursor='nwse-resize';break;case 1:cursor='nesw-resize';break;case 2:cursor='nesw-resize';break;case 3:cursor='nwse-resize';break}
this._areaIsHover=!1;this._resizeCtrlIsHover=hoveredResizeBox;res=!0}else if(this._isCoordWithinArea([mouseCurX,mouseCurY])){cursor='move';this._areaIsHover=!0;res=!0}}
angular.element(this._ctx.canvas).css({'cursor':cursor});return res};CropAreaSquare.prototype.processMouseDown=function(mouseDownX,mouseDownY){var isWithinResizeCtrl=this._isCoordWithinResizeCtrl([mouseDownX,mouseDownY]);if(isWithinResizeCtrl>-1){this._areaIsDragging=!1;this._areaIsHover=!1;this._resizeCtrlIsDragging=isWithinResizeCtrl;this._resizeCtrlIsHover=isWithinResizeCtrl;this._posResizeStartX=mouseDownX;this._posResizeStartY=mouseDownY;this._posResizeStartSize=this._size;this._events.trigger('area-resize-start')}else if(this._isCoordWithinArea([mouseDownX,mouseDownY])){this._areaIsDragging=!0;this._areaIsHover=!0;this._resizeCtrlIsDragging=-1;this._resizeCtrlIsHover=-1;var center=this.getCenterPoint();this._posDragStartX=mouseDownX-center.x;this._posDragStartY=mouseDownY-center.y;this._events.trigger('area-move-start')}};CropAreaSquare.prototype.processMouseUp=function(){if(this._areaIsDragging){this._areaIsDragging=!1;this._events.trigger('area-move-end')}
if(this._resizeCtrlIsDragging>-1){this._resizeCtrlIsDragging=-1;this._events.trigger('area-resize-end')}
this._areaIsHover=!1;this._resizeCtrlIsHover=-1;this._posDragStartX=0;this._posDragStartY=0};return CropAreaSquare}]);angular.module('starter').factory('cropArea',['cropCanvas',function(CropCanvas){var CropArea=function(ctx,events){this._ctx=ctx;this._events=events;this._minSize={x:0,y:0,w:80,h:80};this._initSize=undefined;this._initCoords=undefined;this._allowCropResizeOnCorners=!1;this._forceAspectRatio=!1;this._aspect=null;this._disableCrop=!1;this._cropCanvas=new CropCanvas(ctx,this._disableCrop);this._image=new Image();this._size={x:0,y:0,w:150,h:150}};CropArea.prototype.setAllowCropResizeOnCorners=function(bool){this._allowCropResizeOnCorners=bool};CropArea.prototype.getImage=function(){return this._image};CropArea.prototype.setImage=function(image){this._image=image};CropArea.prototype.setForceAspectRatio=function(force){this._forceAspectRatio=force};CropArea.prototype.setAspect=function(aspect){this._aspect=aspect};CropArea.prototype.getAspect=function(){return this._aspect};CropArea.prototype.getCanvasSize=function(){return{w:this._ctx.canvas.width,h:this._ctx.canvas.height}};CropArea.prototype.getSize=function(){return this._size};CropArea.prototype.setSize=function(size){size=this._processSize(size);this._size=this._preventBoundaryCollision(size)};CropArea.prototype.setSizeOnMove=function(size){size=this._processSize(size);if(this._allowCropResizeOnCorners){this._size=this._preventBoundaryCollision(size)}else{this._size=this._allowMouseOutsideCanvas(size)}};CropArea.prototype.circleOnMove=function(northWestCorner,southEastCorner){var size={x:northWestCorner.x,y:northWestCorner.y,w:southEastCorner.x-northWestCorner.x,h:southEastCorner.y-northWestCorner.y};var canvasH=this._ctx.canvas.height,canvasW=this._ctx.canvas.width;if(size.w>canvasW||size.h>canvasH){if(canvasW<canvasH){size.w=canvasW;size.h=canvasW}else{size.w=canvasH;size.h=canvasH}}
if(size.x+size.w>canvasW){size.x=canvasW-size.w}
if(size.y+size.h>canvasH){size.y=canvasH-size.h}
if(size.x<0){size.x=0}
if(size.y<0){size.y=0}
if(this._minSize.w>size.w){size.w=this._minSize.w;size.x=this._size.x}
if(this._minSize.h>size.h){size.h=this._minSize.h;size.y=this._size.y}
this._size=size};CropArea.prototype.setSizeByCorners=function(northWestCorner,southEastCorner){var size={x:northWestCorner.x,y:northWestCorner.y,w:southEastCorner.x-northWestCorner.x,h:southEastCorner.y-northWestCorner.y};this.setSize(size)};CropArea.prototype.getSouthEastBound=function(){return this._southEastBound(this.getSize())};CropArea.prototype.setMinSize=function(size){this._minSize=this._processSize(size);this.setSize(this._minSize)};CropArea.prototype.getMinSize=function(){return this._minSize};CropArea.prototype.getCenterPoint=function(){var s=this.getSize();return{x:s.x+(s.w/2),y:s.y+(s.h/2)}};CropArea.prototype.setCenterPoint=function(point){var s=this.getSize();this.setSize({x:point.x-s.w/2,y:point.y-s.h/2,w:s.w,h:s.h})};CropArea.prototype.setCenterPointOnMove=function(point){var s=this.getSize();this.setSizeOnMove({x:point.x-s.w/2,y:point.y-s.h/2,w:s.w,h:s.h})};CropArea.prototype.setInitSize=function(size){this._initSize=this._processSize(size);this.setSize(this._initSize)};CropArea.prototype.getInitSize=function(){return this._initSize};CropArea.prototype.setInitCoords=function(coords){coords.h=this.getSize().h;coords.w=this.getSize().w;this._initCoords=this._processSize(coords);this.setSize(this._initCoords)};CropArea.prototype.setDisableCrop=function(value){this._disableCrop=value;this._cropCanvas=new CropCanvas(this._ctx,this._disableCrop)};CropArea.prototype.getInitCoords=function(){return this._initCoords};CropArea.prototype.getType=function(){return'circle'};CropArea.prototype._allowMouseOutsideCanvas=function(size){var canvasH=this._ctx.canvas.height,canvasW=this._ctx.canvas.width;var newSize={w:size.w,h:size.h,};if(size.x<0){newSize.x=0}else if(size.x+size.w>canvasW){newSize.x=canvasW-size.w}else{newSize.x=size.x}
if(size.y<0){newSize.y=0}else if(size.y+size.h>canvasH){newSize.y=canvasH-size.h}else{newSize.y=size.y}
return newSize};CropArea.prototype._preventBoundaryCollision=function(size){var canvasH=this._ctx.canvas.height,canvasW=this._ctx.canvas.width;var nw={x:size.x,y:size.y};var se=this._southEastBound(size);if(nw.x<0){nw.x=0}
if(nw.y<0){nw.y=0}
if(se.x>canvasW){se.x=canvasW}
if(se.y>canvasH){se.y=canvasH}
var newSizeWidth=(this._forceAspectRatio)?size.w:se.x-nw.x,newSizeHeight=(this._forceAspectRatio)?size.h:se.y-nw.y;if(newSizeHeight>canvasH){newSizeHeight=canvasH}
if(this._aspect){newSizeWidth=newSizeHeight*this._aspect;if(nw.x+newSizeWidth>canvasW){newSizeWidth=canvasW-nw.x;newSizeHeight=newSizeWidth/this._aspect;if(this._minSize.w>newSizeWidth){newSizeWidth=this._minSize.w}
if(this._minSize.h>newSizeHeight){newSizeHeight=this._minSize.h}
nw.x=canvasW-newSizeWidth}
if(nw.y+newSizeHeight>canvasH){nw.y=canvasH-newSizeHeight}}
if(this._forceAspectRatio){newSizeWidth=newSizeHeight;if(nw.x+newSizeWidth>canvasW){newSizeWidth=canvasW-nw.x;if(newSizeWidth<this._minSize.w){newSizeWidth=this._minSize.w}
newSizeHeight=newSizeWidth}}
var newSize={x:nw.x,y:nw.y,w:newSizeWidth,h:newSizeHeight};if((newSize.w<this._minSize.w)&&!this._forceAspectRatio){newSize.w=this._minSize.w;se=this._southEastBound(newSize);if(se.x>canvasW){se.x=canvasW;nw.x=Math.max(se.x-canvasW,se.x-this._minSize.w);newSize={x:nw.x,y:nw.y,w:se.x-nw.x,h:se.y-nw.y}}}
if((newSize.h<this._minSize.h)&&!this._forceAspectRatio){newSize.h=this._minSize.h;se=this._southEastBound(newSize);if(se.y>canvasH){se.y=canvasH;nw.y=Math.max(se.y-canvasH,se.y-this._minSize.h);newSize={x:nw.x,y:nw.y,w:se.x-nw.x,h:se.y-nw.y}}}
if(this._forceAspectRatio){se=this._southEastBound(newSize);if(se.y>canvasH){newSize.y=canvasH-newSize.h}
if(se.x>canvasW){newSize.x=canvasW-newSize.w}}
return newSize};CropArea.prototype._dontDragOutside=function(){var h=this._ctx.canvas.height,w=this._ctx.canvas.width;if(this._width>w){this._width=w}
if(this._height>h){this._height=h}
if(this._x<this._width/2){this._x=this._width/2}
if(this._x>w-this._width/2){this._x=w-this._width/2}
if(this._y<this._height/2){this._y=this._height/2}
if(this._y>h-this._height/2){this._y=h-this._height/2}};CropArea.prototype._drawArea=function(){};CropArea.prototype._processSize=function(size){if(typeof size==='number'){size={w:size,h:size}}
var width=size.w;var height=size.h;if(this._aspect){if(this.aspect>=1){width=size.h*this._aspect}else{height=size.w/this._aspect}}
return{x:(typeof size.x==='undefined')?this.getSize().x:size.x,y:(typeof size.y==='undefined')?this.getSize().y:size.y,w:width||this._minSize.w,h:height||this._minSize.h}};CropArea.prototype._southEastBound=function(size){return{x:size.x+size.w,y:size.y+size.h}};CropArea.prototype.draw=function(){this._cropCanvas.drawCropArea(this._image,this.getCenterPoint(),this._size,this._drawArea)};CropArea.prototype.processMouseMove=function(){};CropArea.prototype.processMouseDown=function(){};CropArea.prototype.processMouseUp=function(){};return CropArea}]);angular.module('starter').factory('cropCanvas',[function(){var shapeArrowNW=[[-0.5,-2],[-3,-4.5],[-0.5,-7],[-7,-7],[-7,-0.5],[-4.5,-3],[-2,-0.5]];var shapeArrowNE=[[0.5,-2],[3,-4.5],[0.5,-7],[7,-7],[7,-0.5],[4.5,-3],[2,-0.5]];var shapeArrowSW=[[-0.5,2],[-3,4.5],[-0.5,7],[-7,7],[-7,0.5],[-4.5,3],[-2,0.5]];var shapeArrowSE=[[0.5,2],[3,4.5],[0.5,7],[7,7],[7,0.5],[4.5,3],[2,0.5]];var shapeArrowN=[[-1.5,-2.5],[-1.5,-6],[-5,-6],[0,-11],[5,-6],[1.5,-6],[1.5,-2.5]];var shapeArrowW=[[-2.5,-1.5],[-6,-1.5],[-6,-5],[-11,0],[-6,5],[-6,1.5],[-2.5,1.5]];var shapeArrowS=[[-1.5,2.5],[-1.5,6],[-5,6],[0,11],[5,6],[1.5,6],[1.5,2.5]];var shapeArrowE=[[2.5,-1.5],[6,-1.5],[6,-5],[11,0],[6,5],[6,1.5],[2.5,1.5]];var colors={areaOutline:'#fff',resizeBoxStroke:'#bababa',resizeBoxFill:'#444',resizeBoxArrowFill:'#fff',resizeCircleStroke:'#bababa',resizeCircleFill:'#444',moveIconFill:'#fff'};var cropper={strokeWidth:1};return function(ctx,disable){var calcPoint=function(point,offset,scale){return[scale*point[0]+offset[0],scale*point[1]+offset[1]]};var drawFilledPolygon=function(shape,fillStyle,centerCoords,scale){if(disable){return}
ctx.save();ctx.fillStyle=fillStyle;ctx.beginPath();var pc,pc0=calcPoint(shape[0],centerCoords,scale);ctx.moveTo(pc0[0],pc0[1]);for(var p in shape){if(p>0){pc=calcPoint(shape[p],centerCoords,scale);ctx.lineTo(pc[0],pc[1])}}
ctx.lineTo(pc0[0],pc0[1]);ctx.fill();ctx.closePath();ctx.restore()};this.drawIconMove=function(centerCoords,scale){if(disable){return}
drawFilledPolygon(shapeArrowN,colors.moveIconFill,centerCoords,scale);drawFilledPolygon(shapeArrowW,colors.moveIconFill,centerCoords,scale);drawFilledPolygon(shapeArrowS,colors.moveIconFill,centerCoords,scale);drawFilledPolygon(shapeArrowE,colors.moveIconFill,centerCoords,scale)};this.drawIconResizeCircle=function(centerCoords,circleRadius,scale){if(disable){return}
var scaledCircleRadius=circleRadius*scale;ctx.save();ctx.strokeStyle=colors.resizeCircleStroke;ctx.lineWidth=cropper.strokeWidth;ctx.fillStyle=colors.resizeCircleFill;ctx.beginPath();ctx.arc(centerCoords[0],centerCoords[1],scaledCircleRadius,0,2*Math.PI);ctx.fill();ctx.stroke();ctx.closePath();ctx.restore()};this.drawIconResizeBoxBase=function(centerCoords,boxSize,scale){if(disable){return}
var scaledBoxSize=boxSize*scale;ctx.save();ctx.strokeStyle=colors.resizeBoxStroke;ctx.lineWidth=cropper.strokeWidth;ctx.fillStyle=colors.resizeBoxFill;ctx.fillRect(centerCoords[0]-scaledBoxSize/2,centerCoords[1]-scaledBoxSize/2,scaledBoxSize,scaledBoxSize);ctx.strokeRect(centerCoords[0]-scaledBoxSize/2,centerCoords[1]-scaledBoxSize/2,scaledBoxSize,scaledBoxSize);ctx.restore()};this.drawIconResizeBoxNESW=function(centerCoords,boxSize,scale){if(disable){return}
this.drawIconResizeBoxBase(centerCoords,boxSize,scale);drawFilledPolygon(shapeArrowNE,colors.resizeBoxArrowFill,centerCoords,scale);drawFilledPolygon(shapeArrowSW,colors.resizeBoxArrowFill,centerCoords,scale)};this.drawIconResizeBoxNWSE=function(centerCoords,boxSize,scale){if(disable){return}
this.drawIconResizeBoxBase(centerCoords,boxSize,scale);drawFilledPolygon(shapeArrowNW,colors.resizeBoxArrowFill,centerCoords,scale);drawFilledPolygon(shapeArrowSE,colors.resizeBoxArrowFill,centerCoords,scale)};this.drawCropArea=function(image,centerCoords,size,fnDrawClipPath){if(disable){return}
var xRatio=Math.abs(image.width/ctx.canvas.width),yRatio=Math.abs(image.height/ctx.canvas.height),xLeft=Math.abs(centerCoords.x-size.w/2),yTop=Math.abs(centerCoords.y-size.h/2);ctx.save();ctx.strokeStyle=colors.areaOutline;ctx.lineWidth=cropper.strokeWidth;ctx.setLineDash([5,5]);ctx.beginPath();fnDrawClipPath(ctx,centerCoords,size);ctx.stroke();ctx.clip();if(size.w>0){ctx.drawImage(image,xLeft*xRatio,yTop*yRatio,Math.abs(size.w*xRatio),Math.abs(size.h*yRatio),xLeft,yTop,Math.abs(size.w),Math.abs(size.h))}
ctx.beginPath();fnDrawClipPath(ctx,centerCoords,size);ctx.stroke();ctx.clip();ctx.restore()}}}]);angular.module('starter').service('cropEXIF',[function(){var debug=!1;var ExifTags=this.Tags={0x9000:'ExifVersion',0xA000:'FlashpixVersion',0xA001:'ColorSpace',0xA002:'PixelXDimension',0xA003:'PixelYDimension',0x9101:'ComponentsConfiguration',0x9102:'CompressedBitsPerPixel',0x927C:'MakerNote',0x9286:'UserComment',0xA004:'RelatedSoundFile',0x9003:'DateTimeOriginal',0x9004:'DateTimeDigitized',0x9290:'SubsecTime',0x9291:'SubsecTimeOriginal',0x9292:'SubsecTimeDigitized',0x829A:'ExposureTime',0x829D:'FNumber',0x8822:'ExposureProgram',0x8824:'SpectralSensitivity',0x8827:'ISOSpeedRatings',0x8828:'OECF',0x9201:'ShutterSpeedValue',0x9202:'ApertureValue',0x9203:'BrightnessValue',0x9204:'ExposureBias',0x9205:'MaxApertureValue',0x9206:'SubjectDistance',0x9207:'MeteringMode',0x9208:'LightSource',0x9209:'Flash',0x9214:'SubjectArea',0x920A:'FocalLength',0xA20B:'FlashEnergy',0xA20C:'SpatialFrequencyResponse',0xA20E:'FocalPlaneXResolution',0xA20F:'FocalPlaneYResolution',0xA210:'FocalPlaneResolutionUnit',0xA214:'SubjectLocation',0xA215:'ExposureIndex',0xA217:'SensingMethod',0xA300:'FileSource',0xA301:'SceneType',0xA302:'CFAPattern',0xA401:'CustomRendered',0xA402:'ExposureMode',0xA403:'WhiteBalance',0xA404:'DigitalZoomRation',0xA405:'FocalLengthIn35mmFilm',0xA406:'SceneCaptureType',0xA407:'GainControl',0xA408:'Contrast',0xA409:'Saturation',0xA40A:'Sharpness',0xA40B:'DeviceSettingDescription',0xA40C:'SubjectDistanceRange',0xA005:'InteroperabilityIFDPointer',0xA420:'ImageUniqueID'};var TiffTags=this.TiffTags={0x0100:'ImageWidth',0x0101:'ImageHeight',0x8769:'ExifIFDPointer',0x8825:'GPSInfoIFDPointer',0xA005:'InteroperabilityIFDPointer',0x0102:'BitsPerSample',0x0103:'Compression',0x0106:'PhotometricInterpretation',0x0112:'Orientation',0x0115:'SamplesPerPixel',0x011C:'PlanarConfiguration',0x0212:'YCbCrSubSampling',0x0213:'YCbCrPositioning',0x011A:'XResolution',0x011B:'YResolution',0x0128:'ResolutionUnit',0x0111:'StripOffsets',0x0116:'RowsPerStrip',0x0117:'StripByteCounts',0x0201:'JPEGInterchangeFormat',0x0202:'JPEGInterchangeFormatLength',0x012D:'TransferFunction',0x013E:'WhitePoint',0x013F:'PrimaryChromaticities',0x0211:'YCbCrCoefficients',0x0214:'ReferenceBlackWhite',0x0132:'DateTime',0x010E:'ImageDescription',0x010F:'Make',0x0110:'Model',0x0131:'Software',0x013B:'Artist',0x8298:'Copyright'};var GPSTags=this.GPSTags={0x0000:'GPSVersionID',0x0001:'GPSLatitudeRef',0x0002:'GPSLatitude',0x0003:'GPSLongitudeRef',0x0004:'GPSLongitude',0x0005:'GPSAltitudeRef',0x0006:'GPSAltitude',0x0007:'GPSTimeStamp',0x0008:'GPSSatellites',0x0009:'GPSStatus',0x000A:'GPSMeasureMode',0x000B:'GPSDOP',0x000C:'GPSSpeedRef',0x000D:'GPSSpeed',0x000E:'GPSTrackRef',0x000F:'GPSTrack',0x0010:'GPSImgDirectionRef',0x0011:'GPSImgDirection',0x0012:'GPSMapDatum',0x0013:'GPSDestLatitudeRef',0x0014:'GPSDestLatitude',0x0015:'GPSDestLongitudeRef',0x0016:'GPSDestLongitude',0x0017:'GPSDestBearingRef',0x0018:'GPSDestBearing',0x0019:'GPSDestDistanceRef',0x001A:'GPSDestDistance',0x001B:'GPSProcessingMethod',0x001C:'GPSAreaInformation',0x001D:'GPSDateStamp',0x001E:'GPSDifferential'};var StringValues=this.StringValues={ExposureProgram:{0:'Not defined',1:'Manual',2:'Normal program',3:'Aperture priority',4:'Shutter priority',5:'Creative program',6:'Action program',7:'Portrait mode',8:'Landscape mode'},MeteringMode:{0:'Unknown',1:'Average',2:'CenterWeightedAverage',3:'Spot',4:'MultiSpot',5:'Pattern',6:'Partial',255:'Other'},LightSource:{0:'Unknown',1:'Daylight',2:'Fluorescent',3:'Tungsten (incandescent light)',4:'Flash',9:'Fine weather',10:'Cloudy weather',11:'Shade',12:'Daylight fluorescent (D 5700 - 7100K)',13:'Day white fluorescent (N 4600 - 5400K)',14:'Cool white fluorescent (W 3900 - 4500K)',15:'White fluorescent (WW 3200 - 3700K)',17:'Standard light A',18:'Standard light B',19:'Standard light C',20:'D55',21:'D65',22:'D75',23:'D50',24:'ISO studio tungsten',255:'Other'},Flash:{0x0000:'Flash did not fire',0x0001:'Flash fired',0x0005:'Strobe return light not detected',0x0007:'Strobe return light detected',0x0009:'Flash fired, compulsory flash mode',0x000D:'Flash fired, compulsory flash mode, return light not detected',0x000F:'Flash fired, compulsory flash mode, return light detected',0x0010:'Flash did not fire, compulsory flash mode',0x0018:'Flash did not fire, auto mode',0x0019:'Flash fired, auto mode',0x001D:'Flash fired, auto mode, return light not detected',0x001F:'Flash fired, auto mode, return light detected',0x0020:'No flash function',0x0041:'Flash fired, red-eye reduction mode',0x0045:'Flash fired, red-eye reduction mode, return light not detected',0x0047:'Flash fired, red-eye reduction mode, return light detected',0x0049:'Flash fired, compulsory flash mode, red-eye reduction mode',0x004D:'Flash fired, compulsory flash mode, red-eye reduction mode, return light not detected',0x004F:'Flash fired, compulsory flash mode, red-eye reduction mode, return light detected',0x0059:'Flash fired, auto mode, red-eye reduction mode',0x005D:'Flash fired, auto mode, return light not detected, red-eye reduction mode',0x005F:'Flash fired, auto mode, return light detected, red-eye reduction mode'},SensingMethod:{1:'Not defined',2:'One-chip color area sensor',3:'Two-chip color area sensor',4:'Three-chip color area sensor',5:'Color sequential area sensor',7:'Trilinear sensor',8:'Color sequential linear sensor'},SceneCaptureType:{0:'Standard',1:'Landscape',2:'Portrait',3:'Night scene'},SceneType:{1:'Directly photographed'},CustomRendered:{0:'Normal process',1:'Custom process'},WhiteBalance:{0:'Auto white balance',1:'Manual white balance'},GainControl:{0:'None',1:'Low gain up',2:'High gain up',3:'Low gain down',4:'High gain down'},Contrast:{0:'Normal',1:'Soft',2:'Hard'},Saturation:{0:'Normal',1:'Low saturation',2:'High saturation'},Sharpness:{0:'Normal',1:'Soft',2:'Hard'},SubjectDistanceRange:{0:'Unknown',1:'Macro',2:'Close view',3:'Distant view'},FileSource:{3:'DSC'},Components:{0:'',1:'Y',2:'Cb',3:'Cr',4:'R',5:'G',6:'B'}};function addEvent(element,event,handler){if(element.addEventListener){element.addEventListener(event,handler,!1)}else if(element.attachEvent){element.attachEvent('on'+event,handler)}}
function imageHasData(img){return!!(img.exifdata)}
function base64ToArrayBuffer(base64,contentType){contentType=contentType||base64.match(/^data\:([^\;]+)\;base64,/mi)[1]||'';base64=base64.replace(/^data\:([^\;]+)\;base64,/gmi,'');var binary=atob(base64);var len=binary.length;var buffer=new ArrayBuffer(len);var view=new Uint8Array(buffer);for(var i=0;i<len;i++){view[i]=binary.charCodeAt(i)}
return buffer}
function objectURLToBlob(url,callback){var http=new XMLHttpRequest();http.open('GET',url,!0);http.responseType='blob';http.onload=function(e){if(this.status===200||this.status===0){callback(this.response)}};http.send()}
function getImageData(img,callback){function handleBinaryFile(binFile){var data=findEXIFinJPEG(binFile);var iptcdata=findIPTCinJPEG(binFile);img.exifdata=data||{};img.iptcdata=iptcdata||{};if(callback){callback.call(img)}}
var fileReader=new FileReader();if(img.src){if(/^data\:/i.test(img.src)){var arrayBuffer=base64ToArrayBuffer(img.src);handleBinaryFile(arrayBuffer)}else if(/^blob\:/i.test(img.src)){fileReader.onload=function(e){handleBinaryFile(e.target.result)};objectURLToBlob(img.src,function(blob){fileReader.readAsArrayBuffer(blob)})}
var http=new XMLHttpRequest();http.onload=function(){if(this.status===200||this.status===0){handleBinaryFile(http.response)}else{throw 'Could not load image'}
http=null};http.open('GET',img.src,!0);http.responseType='arraybuffer';try{http.send(null)}catch(e){}}else if(window.FileReader&&(img instanceof window.Blob||img instanceof window.File)){fileReader.onload=function(e){if(debug){console.log('Got file of length '+e.target.result.byteLength)}
handleBinaryFile(e.target.result)};fileReader.readAsArrayBuffer(img)}}
function findEXIFinJPEG(file){var dataView=new DataView(file);if(debug){console.log('Got file of length '+file.byteLength)}
if((dataView.getUint8(0)!==0xFF)||(dataView.getUint8(1)!==0xD8)){if(debug){console.log('Not a valid JPEG')}
return!1}
var offset=2,length=file.byteLength,marker;while(offset<length){if(dataView.getUint8(offset)!==0xFF){if(debug){console.log('Not a valid marker at offset '+offset+', found: '+dataView.getUint8(offset))}
return!1}
marker=dataView.getUint8(offset+1);if(debug){console.log(marker)}
if(marker===225){if(debug){console.log('Found 0xFFE1 marker')}
return readEXIFData(dataView,offset+4,dataView.getUint16(offset+2)-2)}else{offset+=2+dataView.getUint16(offset+2)}}}
function findIPTCinJPEG(file){var dataView=new DataView(file);if(debug){console.log('Got file of length '+file.byteLength)}
if((dataView.getUint8(0)!==0xFF)||(dataView.getUint8(1)!==0xD8)){if(debug){console.log('Not a valid JPEG')}
return!1}
var offset=2,length=file.byteLength;var isFieldSegmentStart=function(dataView,offset){return(dataView.getUint8(offset)===0x38&&dataView.getUint8(offset+1)===0x42&&dataView.getUint8(offset+2)===0x49&&dataView.getUint8(offset+3)===0x4D&&dataView.getUint8(offset+4)===0x04&&dataView.getUint8(offset+5)===0x04)};while(offset<length){if(isFieldSegmentStart(dataView,offset)){var nameHeaderLength=dataView.getUint8(offset+7);if(nameHeaderLength%2!==0){nameHeaderLength+=1}
if(nameHeaderLength===0){nameHeaderLength=4}
var startOffset=offset+8+nameHeaderLength;var sectionLength=dataView.getUint16(offset+6+nameHeaderLength);return readIPTCData(file,startOffset,sectionLength)}
offset++}}
var IptcFieldMap={0x78:'caption',0x6E:'credit',0x19:'keywords',0x37:'dateCreated',0x50:'byline',0x55:'bylineTitle',0x7A:'captionWriter',0x69:'headline',0x74:'copyright',0x0F:'category'};function readIPTCData(file,startOffset,sectionLength){var dataView=new DataView(file);var data={};var fieldValue,fieldName,dataSize,segmentType,segmentSize;var segmentStartPos=startOffset;while(segmentStartPos<startOffset+sectionLength){if(dataView.getUint8(segmentStartPos)===0x1C&&dataView.getUint8(segmentStartPos+1)===0x02){segmentType=dataView.getUint8(segmentStartPos+2);if(segmentType in IptcFieldMap){dataSize=dataView.getInt16(segmentStartPos+3);segmentSize=dataSize+5;fieldName=IptcFieldMap[segmentType];fieldValue=getStringFromDB(dataView,segmentStartPos+5,dataSize);if(data.hasOwnProperty(fieldName)){if(data[fieldName]instanceof Array){data[fieldName].push(fieldValue)}else{data[fieldName]=[data[fieldName],fieldValue]}}else{data[fieldName]=fieldValue}}}
segmentStartPos++}
return data}
function readTags(file,tiffStart,dirStart,strings,bigEnd){var entries=file.getUint16(dirStart,!bigEnd),tags={},entryOffset,tag,i;for(i=0;i<entries;i++){entryOffset=dirStart+i*12+2;tag=strings[file.getUint16(entryOffset,!bigEnd)];if(!tag&&debug){console.log('Unknown tag: '+file.getUint16(entryOffset,!bigEnd))}
tags[tag]=readTagValue(file,entryOffset,tiffStart,dirStart,bigEnd)}
return tags}
function readTagValue(file,entryOffset,tiffStart,dirStart,bigEnd){var type=file.getUint16(entryOffset+2,!bigEnd),numValues=file.getUint32(entryOffset+4,!bigEnd),valueOffset=file.getUint32(entryOffset+8,!bigEnd)+tiffStart,offset,vals,val,n,numerator,denominator;switch(type){case 1:case 7:if(numValues===1){return file.getUint8(entryOffset+8,!bigEnd)}
offset=numValues>4?valueOffset:(entryOffset+8);vals=[];for(n=0;n<numValues;n++){vals[n]=file.getUint8(offset+n)}
return vals;case 2:offset=numValues>4?valueOffset:(entryOffset+8);return getStringFromDB(file,offset,numValues-1);case 3:if(numValues===1){return file.getUint16(entryOffset+8,!bigEnd)}
offset=numValues>2?valueOffset:(entryOffset+8);vals=[];for(n=0;n<numValues;n++){vals[n]=file.getUint16(offset+2*n,!bigEnd)}
return vals;case 4:if(numValues===1){return file.getUint32(entryOffset+8,!bigEnd)}
vals=[];for(n=0;n<numValues;n++){vals[n]=file.getUint32(valueOffset+4*n,!bigEnd)}
return vals;case 5:if(numValues===1){numerator=file.getUint32(valueOffset,!bigEnd);denominator=file.getUint32(valueOffset+4,!bigEnd);val={};val.numerator=numerator;val.denominator=denominator;return val}
vals=[];for(n=0;n<numValues;n++){numerator=file.getUint32(valueOffset+8*n,!bigEnd);denominator=file.getUint32(valueOffset+4+8*n,!bigEnd);vals[n]={};vals[n].numerator=numerator;vals[n].denominator=denominator}
return vals;case 9:if(numValues===1){return file.getInt32(entryOffset+8,!bigEnd)}
vals=[];for(n=0;n<numValues;n++){vals[n]=file.getInt32(valueOffset+4*n,!bigEnd)}
return vals;case 10:if(numValues===1){return file.getInt32(valueOffset,!bigEnd)/file.getInt32(valueOffset+4,!bigEnd)}
vals=[];for(n=0;n<numValues;n++){vals[n]=file.getInt32(valueOffset+8*n,!bigEnd)/file.getInt32(valueOffset+4+8*n,!bigEnd)}
return vals}}
function getStringFromDB(buffer,start,length){var outstr='';for(var n=start;n<start+length;n++){outstr+=String.fromCharCode(buffer.getUint8(n))}
return outstr}
function readEXIFData(file,start){if(getStringFromDB(file,start,4)!=='Exif'){if(debug){console.log('Not valid EXIF data! '+getStringFromDB(file,start,4))}
return!1}
var bigEnd,tags,tag,exifData,gpsData,tiffOffset=start+6;if(file.getUint16(tiffOffset)===0x4949){bigEnd=!1}else if(file.getUint16(tiffOffset)===0x4D4D){bigEnd=!0}else{if(debug){console.log('Not valid TIFF data! (no 0x4949 or 0x4D4D)')}
return!1}
if(file.getUint16(tiffOffset+2,!bigEnd)!==0x002A){if(debug){console.log('Not valid TIFF data! (no 0x002A)')}
return!1}
var firstIFDOffset=file.getUint32(tiffOffset+4,!bigEnd);if(firstIFDOffset<0x00000008){if(debug){console.log('Not valid TIFF data! (First offset less than 8)',file.getUint32(tiffOffset+4,!bigEnd))}
return!1}
tags=readTags(file,tiffOffset,tiffOffset+firstIFDOffset,TiffTags,bigEnd);if(tags.ExifIFDPointer){exifData=readTags(file,tiffOffset,tiffOffset+tags.ExifIFDPointer,ExifTags,bigEnd);for(tag in exifData){switch(tag){case 'LightSource':case 'Flash':case 'MeteringMode':case 'ExposureProgram':case 'SensingMethod':case 'SceneCaptureType':case 'SceneType':case 'CustomRendered':case 'WhiteBalance':case 'GainControl':case 'Contrast':case 'Saturation':case 'Sharpness':case 'SubjectDistanceRange':case 'FileSource':exifData[tag]=StringValues[tag][exifData[tag]];break;case 'ExifVersion':case 'FlashpixVersion':exifData[tag]=String.fromCharCode(exifData[tag][0],exifData[tag][1],exifData[tag][2],exifData[tag][3]);break;case 'ComponentsConfiguration':exifData[tag]=StringValues.Components[exifData[tag][0]]+StringValues.Components[exifData[tag][1]]+StringValues.Components[exifData[tag][2]]+StringValues.Components[exifData[tag][3]];break}
tags[tag]=exifData[tag]}}
if(tags.GPSInfoIFDPointer){gpsData=readTags(file,tiffOffset,tiffOffset+tags.GPSInfoIFDPointer,GPSTags,bigEnd);for(tag in gpsData){switch(tag){case 'GPSVersionID':gpsData[tag]=gpsData[tag][0]+'.'+gpsData[tag][1]+'.'+gpsData[tag][2]+'.'+gpsData[tag][3];break}
tags[tag]=gpsData[tag]}}
return tags}
this.getData=function(img,callback){if((img instanceof Image||img instanceof HTMLImageElement)&&!img.complete){return!1}
if(!imageHasData(img)){getImageData(img,callback)}else{if(callback){callback.call(img)}}
return!0};this.getTag=function(img,tag){if(!imageHasData(img)){return}
return img.exifdata[tag]};this.getAllTags=function(img){if(!imageHasData(img)){return{}}
var a,data=img.exifdata,tags={};for(a in data){if(data.hasOwnProperty(a)){tags[a]=data[a]}}
return tags};this.pretty=function(img){if(!imageHasData(img)){return''}
var a,data=img.exifdata,strPretty='';for(a in data){if(data.hasOwnProperty(a)){if(typeof data[a]==='object'){if(data[a]instanceof Number){strPretty+=a+' : '+data[a]+' ['+data[a].numerator+'/'+data[a].denominator+']\r\n'}else{strPretty+=a+' : ['+data[a].length+' values]\r\n'}}else{strPretty+=a+' : '+data[a]+'\r\n'}}}
return strPretty};this.readFromBinaryFile=function(file){return findEXIFinJPEG(file)}}]);angular.module('starter').factory('cropHost',['$document','$q','cropAreaCircle','cropAreaSquare','cropAreaRectangle','cropEXIF',function($document,$q,CropAreaCircle,CropAreaSquare,CropAreaRectangle,cropEXIF){var colorPaletteLength=8;var getElementOffset=function(elem){var box=elem.getBoundingClientRect();var body=document.body;var docElem=document.documentElement;var scrollTop=window.pageYOffset||docElem.scrollTop||body.scrollTop;var scrollLeft=window.pageXOffset||docElem.scrollLeft||body.scrollLeft;var clientTop=docElem.clientTop||body.clientTop||0;var clientLeft=docElem.clientLeft||body.clientLeft||0;var top=box.top+scrollTop-clientTop;var left=box.left+scrollLeft-clientLeft;return{top:Math.round(top),left:Math.round(left)}};return function(elCanvas,opts,events){var ctx=null,image=null,theArea=null,initMax=null,isAspectRatio=null,self=this,minCanvasDims=[100,100],maxCanvasDims=[300,300],scalemode=null,resImgSizeArray=[],resImgSize={w:200,h:200},areaMinRelativeSize=null,resImgFormat='image/png',resImgQuality=null,keys={up:38,down:40,left:37,right:39},forceAspectRatio=!1;function drawScene(){ctx.clearRect(0,0,ctx.canvas.width,ctx.canvas.height);if(image!==null){ctx.drawImage(image,0,0,ctx.canvas.width,ctx.canvas.height);ctx.save();if(!theArea._disableCrop){ctx.fillStyle='rgba(0, 0, 0, 0.65)';ctx.fillRect(0,0,ctx.canvas.width,ctx.canvas.height);ctx.restore()}
theArea.draw()}}
this.setInitMax=function(bool){initMax=bool};this.setAllowCropResizeOnCorners=function(bool){theArea.setAllowCropResizeOnCorners(bool)};this.setDisableCrop=function(value){theArea.setDisableCrop(value);drawScene()};var focusOnCanvas=function(){elCanvas[0].focus()};function fitCanvasDims(width,height){var imageRatio=width/height;var canvasDims=[width,height];var margins={left:0,top:0};if(canvasDims[0]>maxCanvasDims[0]){canvasDims[0]=maxCanvasDims[0];canvasDims[1]=canvasDims[0]/imageRatio;margins.top=(maxCanvasDims[1]-canvasDims[1])/2}else if(canvasDims[1]>maxCanvasDims[1]){canvasDims[1]=maxCanvasDims[1];canvasDims[0]=canvasDims[1]*imageRatio;margins.left=(maxCanvasDims[0]-canvasDims[0])/2}else{margins.top=(maxCanvasDims[1]-canvasDims[1])/2;margins.left=(maxCanvasDims[0]-canvasDims[0])/2}
return{dims:canvasDims,margins:margins,}}
var resetCropHost=function(){var canvasDims=[0,0];if(image!==null){focusOnCanvas();theArea.setImage(image);if(scalemode==='fit'){var results=fitCanvasDims(image.width,image.height);canvasDims=results.dims;var margins=results.margins;elCanvas.css({'margin-left':margins.left+'px','margin-top':margins.top+'px'})}else{var imageDims=[image.width,image.height],imageRatio=image.width/image.height;canvasDims=imageDims;if(canvasDims[0]>maxCanvasDims[0]){canvasDims[0]=maxCanvasDims[0];canvasDims[1]=canvasDims[0]/imageRatio}else if(canvasDims[0]<minCanvasDims[0]){canvasDims[0]=minCanvasDims[0];canvasDims[1]=canvasDims[0]/imageRatio}
if(scalemode==='fixed-height'&&canvasDims[1]>maxCanvasDims[1]){canvasDims[1]=maxCanvasDims[1];canvasDims[0]=canvasDims[1]*imageRatio}else if(canvasDims[1]<minCanvasDims[1]){canvasDims[1]=minCanvasDims[1];canvasDims[0]=canvasDims[1]*imageRatio}}
elCanvas.prop('width',canvasDims[0]).prop('height',canvasDims[1]);if(scalemode==='fixed-height'){elCanvas.css({'margin-left':-canvasDims[0]/2+'px','margin-top':-canvasDims[1]/2+'px'})}
var cw=ctx.canvas.width;var ch=ctx.canvas.height;var areaType=self.getAreaType();if((areaType==='circle')||(areaType==='square')){if(ch<cw){cw=ch}
ch=cw}else if(areaType==='rectangle'&&isAspectRatio){var aspectRatio=theArea.getAspect();if(cw/ch>aspectRatio){cw=aspectRatio*ch}else{ch=aspectRatio*cw}}
if(initMax){theArea.setSize({w:cw,h:ch})}else if(undefined!==theArea.getInitSize()){theArea.setSize({w:Math.min(theArea.getInitSize().w,cw/2),h:Math.min(theArea.getInitSize().h,ch/2)})}else{theArea.setSize({w:Math.min(200,cw/2),h:Math.min(200,ch/2)})}
if(theArea.getInitCoords()){if(self.areaInitIsRelativeToImage){var ratio=image.width/canvasDims[0];theArea.setSize({w:theArea.getInitSize().w/ratio,h:theArea.getInitSize().h/ratio,x:theArea.getInitCoords().x/ratio,y:theArea.getInitCoords().y/ratio})}else{theArea.setSize({w:theArea.getSize().w,h:theArea.getSize().h,x:theArea.getInitCoords().x,y:theArea.getInitCoords().y})}}else{theArea.setCenterPoint({x:ctx.canvas.width/2,y:ctx.canvas.height/2})}}else{elCanvas.prop('width',0).prop('height',0).css({'margin-top':0})}
drawScene()};var getChangedTouches=function(event){if(angular.isDefined(event.changedTouches)){return event.changedTouches}else{return event.originalEvent.changedTouches}};var onMouseMove=function(e){if(theArea._disableCrop){return}
if(image!==null){var offset=getElementOffset(ctx.canvas),pageX,pageY;if(e.type==='touchmove'){pageX=getChangedTouches(e)[0].pageX;pageY=getChangedTouches(e)[0].pageY}else{pageX=e.pageX;pageY=e.pageY}
theArea.processMouseMove(pageX-offset.left,pageY-offset.top);drawScene()}};var onMouseDown=function(e){e.preventDefault();if(theArea._disableCrop){return}
if(!opts.allowPropagation){e.stopPropagation()}
if(image!==null){focusOnCanvas();var offset=getElementOffset(ctx.canvas),pageX,pageY;if(e.type==='touchstart'){pageX=getChangedTouches(e)[0].pageX;pageY=getChangedTouches(e)[0].pageY}else{pageX=e.pageX;pageY=e.pageY}
theArea.processMouseDown(pageX-offset.left,pageY-offset.top);drawScene()}};var onMouseUp=function(e){if(theArea._disableCrop){return}
if(image!==null){var offset=getElementOffset(ctx.canvas),pageX,pageY;if(e.type==='touchend'){pageX=getChangedTouches(e)[0].pageX;pageY=getChangedTouches(e)[0].pageY}else{pageX=e.pageX;pageY=e.pageY}
theArea.processMouseUp(pageX-offset.left,pageY-offset.top);drawScene()}};var getDirectionByKey=function(key){return Object.keys(keys).reduce(function(result,direction){return key===keys[direction]?direction:result},null)};var resizeCropAreaByDirection=function(direction){if(theArea._disableCrop){return}
var scale;switch(direction){case 'up':case 'left':scale=0.95;break;case 'down':case 'right':scale=1.05;break;default:return}
theArea.setSizeByScale(scale,direction);drawScene()};var moveCropArea=function(direction){if(theArea._disableCrop){return}
var center=theArea.getCenterPoint();var step=5;var point={x:center.x,y:center.y};switch(direction){case 'up':point.y-=step;break;case 'down':point.y+=step;break;case 'left':point.x-=step;break;case 'right':point.x+=step;break;default:return}
theArea.setCenterPointOnMove(point);drawScene()};var onKeyDown=function(e){if(theArea._disableCrop){return}
if(image!==null&&opts.disableKeyboardAccess!==!0){var key=e.which;switch(key){case keys.up:case keys.down:case keys.left:case keys.right:e.preventDefault();e.stopPropagation();var direction=getDirectionByKey(key);if(e.shiftKey){resizeCropAreaByDirection(direction)}else{moveCropArea(direction)}
break;default:return}}};var renderTempCanvas=function(ris,center){var temp_ctx,temp_canvas;temp_canvas=angular.element('<canvas></canvas>')[0];temp_ctx=temp_canvas.getContext('2d');temp_canvas.width=ris.w;temp_canvas.height=ris.h;if(image!==null){var x=(center.x-theArea.getSize().w/2)*(image.width/ctx.canvas.width),y=(center.y-theArea.getSize().h/2)*(image.height/ctx.canvas.height),areaWidth=theArea.getSize().w*(image.width/ctx.canvas.width),areaHeight=theArea.getSize().h*(image.height/ctx.canvas.height);if(forceAspectRatio){temp_ctx.drawImage(image,x,y,areaWidth,areaHeight,0,0,ris.w,ris.h)}else{var aspectRatio=areaWidth/areaHeight;var resultHeight,resultWidth;if(aspectRatio>1){resultWidth=ris.w;resultHeight=resultWidth/aspectRatio}else{resultHeight=ris.h;resultWidth=resultHeight*aspectRatio}
temp_canvas.width=resultWidth;temp_canvas.height=resultHeight;temp_ctx.drawImage(image,x,y,areaWidth,areaHeight,0,0,Math.round(resultWidth),Math.round(resultHeight))}}
return temp_canvas};var renderImageToDataURL=function(getResultImageSize){var temp_canvas,retObj={dataURI:null,imageData:null};temp_canvas=renderTempCanvas(getResultImageSize,theArea.getCenterPoint());if(image!==null){if(resImgQuality!==null){retObj.dataURI=temp_canvas.toDataURL(resImgFormat,resImgQuality)}else{retObj.dataURI=temp_canvas.toDataURL(resImgFormat)}}
return retObj};this.getResultImage=function(){if(resImgSizeArray.length===0){return renderImageToDataURL(this.getResultImageSize())}
var arrayResultImages=[];for(var i=0;i<resImgSizeArray.length;i++){arrayResultImages.push({dataURI:renderImageToDataURL(resImgSizeArray[i]).dataURI,w:resImgSizeArray[i].w,h:resImgSizeArray[i].h})}
return arrayResultImages};this.getResultImageDataBlob=function(){var temp_canvas,_p=$q.defer();temp_canvas=renderTempCanvas(this.getResultImageSize(),theArea.getCenterPoint());if(resImgQuality!==null){temp_canvas.toBlob(function(blob){_p.resolve(blob)},resImgFormat,resImgQuality)}else{temp_canvas.toBlob(function(blob){_p.resolve(blob)},resImgFormat)}
return _p.promise};this.getAreaCoords=function(){return theArea.getSize()};this.getArea=function(){return theArea};this.setNewImageSource=function(imageSource){image=null;resetCropHost();if(imageSource){var newImage=new Image();newImage.onload=function(){events.trigger('load-done');cropEXIF.getData(newImage,function(){var orientation=cropEXIF.getTag(newImage,'Orientation');if([3,6,8].indexOf(orientation)>-1){var canvas=document.createElement('canvas'),ctx=canvas.getContext('2d'),cw=newImage.width,ch=newImage.height,cx=0,cy=0,deg=0,rw=0,rh=0;rw=cw;rh=ch;switch(orientation){case 3:cx=-newImage.width;cy=-newImage.height;deg=180;break;case 6:cw=newImage.height;ch=newImage.width;cy=-newImage.height;rw=ch;rh=cw;deg=90;break;case 8:cw=newImage.height;ch=newImage.width;cx=-newImage.width;rw=ch;rh=cw;deg=270;break}
var maxWorH=1000;if(cw>maxWorH||ch>maxWorH){var p=0;if(cw>maxWorH){p=(maxWorH)/cw;cw=maxWorH;ch=p*ch}else if(ch>maxWorH){p=(maxWorH)/ch;ch=maxWorH;cw=p*cw}
cy=p*cy;cx=p*cx;rw=p*rw;rh=p*rh}
canvas.width=cw;canvas.height=ch;ctx.rotate(deg*Math.PI/180);ctx.drawImage(newImage,cx,cy,rw,rh);image=new Image();image.onload=function(){resetCropHost();events.trigger('image-updated')};image.src=canvas.toDataURL(resImgFormat)}else{image=newImage;events.trigger('image-updated')}
resetCropHost()})};newImage.onerror=function(){events.trigger('load-error')};events.trigger('load-start');if(imageSource instanceof window.Blob){newImage.src=URL.createObjectURL(imageSource)}else{if(imageSource.substring(0,4).toLowerCase()==='http'||imageSource.substring(0,2)==='//'){newImage.crossOrigin='anonymous'}
newImage.src=imageSource}}};this.setMaxDimensions=function(width,height){maxCanvasDims=[width,height];if(image!==null){var curWidth=ctx.canvas.width,curHeight=ctx.canvas.height;var canvasDims=[0,0];if(scalemode==='fit'){var results=fitCanvasDims(image.width,image.height);canvasDims=results.dims;var margins=results.margins;elCanvas.css({'margin-left':margins.left+'px','margin-top':margins.top+'px'})}else{var imageDims=[image.width,image.height],imageRatio=image.width/image.height;canvasDims=imageDims;if(canvasDims[0]>maxCanvasDims[0]){canvasDims[0]=maxCanvasDims[0];canvasDims[1]=canvasDims[0]/imageRatio}else if(canvasDims[0]<minCanvasDims[0]){canvasDims[0]=minCanvasDims[0];canvasDims[1]=canvasDims[0]/imageRatio}
if(scalemode==='fixed-height'&&canvasDims[1]>maxCanvasDims[1]){canvasDims[1]=maxCanvasDims[1];canvasDims[0]=canvasDims[1]*imageRatio}else if(canvasDims[1]<minCanvasDims[1]){canvasDims[1]=minCanvasDims[1];canvasDims[0]=canvasDims[1]*imageRatio}}
elCanvas.prop('width',canvasDims[0]).prop('height',canvasDims[1]);if(scalemode==='fixed-height'){elCanvas.css({'margin-left':-canvasDims[0]/2+'px','margin-top':-canvasDims[1]/2+'px'})}
var ratioNewCurWidth=curWidth?ctx.canvas.width/curWidth:0,ratioNewCurHeight=curHeight?ctx.canvas.height/curHeight:0,ratioMin=Math.min(ratioNewCurWidth,ratioNewCurHeight);var center=theArea.getCenterPoint();theArea.setSize({w:theArea.getSize().w*ratioMin,h:theArea.getSize().h*ratioMin});theArea.setCenterPoint({x:center.x*ratioNewCurWidth,y:center.y*ratioNewCurHeight})}else{elCanvas.prop('width',0).prop('height',0).css({'margin-top':0})}
drawScene()};this.setAreaMinSize=function(size){if(angular.isUndefined(size)){return}else if(typeof size==='number'||typeof size==='string'){size={w:parseInt(parseInt(size),10),h:parseInt(parseInt(size),10)}}else{size={w:parseInt(size.w,10),h:parseInt(size.h,10)}}
if(!isNaN(size.w)&&!isNaN(size.h)){theArea.setMinSize(size);drawScene()}};this.setAreaMinRelativeSize=function(size){if(image===null||angular.isUndefined(size)){return}
var canvasSize=theArea.getCanvasSize();if(typeof size==='number'||typeof size==='string'){areaMinRelativeSize={w:size,h:size};size={w:canvasSize.w/(image.width/parseInt(parseInt(size),10)),h:canvasSize.h/(image.height/parseInt(parseInt(size),10))}}else{areaMinRelativeSize=size;size={w:canvasSize.w/(image.width/parseInt(parseInt(size.w),10)),h:canvasSize.h/(image.height/parseInt(parseInt(size.h),10))}}
if(!isNaN(size.w)&&!isNaN(size.h)){theArea.setMinSize(size);drawScene()}};this.setAreaInitSize=function(size){if(angular.isUndefined(size)){return}else if(typeof size==='number'||typeof size==='string'){size={w:parseInt(parseInt(size),10),h:parseInt(parseInt(size),10)}}else{size={w:parseInt(size.w,10),h:parseInt(size.h,10)}}
if(!isNaN(size.w)&&!isNaN(size.h)){theArea.setInitSize(size);drawScene()}};this.setAreaInitCoords=function(coords){if(angular.isUndefined(coords)){return}else{coords={x:parseInt(coords.x,10),y:parseInt(coords.y,10)}}
if(!isNaN(coords.x)&&!isNaN(coords.y)){theArea.setInitCoords(coords);drawScene()}};this.setMaxCanvasDimensions=function(maxCanvasDimensions){if(!angular.isUndefined(maxCanvasDimensions)){var newMaxCanvasDims=[];if(typeof maxCanvasDimensions==='number'||typeof maxCanvasDimensions==='string'){newMaxCanvasDims=[parseInt(parseInt(maxCanvasDimensions),10),parseInt(parseInt(maxCanvasDimensions),10)]}else{newMaxCanvasDims=[parseInt(maxCanvasDimensions.w,10),parseInt(maxCanvasDimensions.h,10)]}
if((!isNaN(newMaxCanvasDims[0])&&newMaxCanvasDims[0]>0&&newMaxCanvasDims[0]>minCanvasDims[0])&&(!isNaN(newMaxCanvasDims[1])&&newMaxCanvasDims[1]>0&&newMaxCanvasDims[1]>minCanvasDims[1])){maxCanvasDims=newMaxCanvasDims}}};this.setMinCanvasDimensions=function(minCanvasDimensions){if(!angular.isUndefined(minCanvasDimensions)){var newMinCanvasDims=[];if(typeof minCanvasDimensions==='number'||typeof minCanvasDimensions==='string'){newMinCanvasDims=[parseInt(parseInt(minCanvasDimensions),10),parseInt(parseInt(minCanvasDimensions),10)]}else{newMinCanvasDims=[parseInt(minCanvasDimensions.w,10),parseInt(minCanvasDimensions.h,10)]}
if((!isNaN(newMinCanvasDims[0])&&newMinCanvasDims[0]>=0)&&(!isNaN(newMinCanvasDims[1])&&newMinCanvasDims[1]>=0)){minCanvasDims=newMinCanvasDims}}};this.setScalemode=function(value){scalemode=value};this.getScalemode=function(){return scalemode};this.getResultImageSize=function(){if(resImgSize==='selection'){return theArea.getSize()}
if(resImgSize==='max'){var zoom=1;if(image&&ctx&&ctx.canvas){zoom=image.width/ctx.canvas.width}
var size={w:zoom*theArea.getSize().w,h:zoom*theArea.getSize().h};if(areaMinRelativeSize){if(size.w<areaMinRelativeSize.w){size.w=areaMinRelativeSize.w}
if(size.h<areaMinRelativeSize.h){size.h=areaMinRelativeSize.h}}
return size}
return resImgSize};this.setResultImageSize=function(size){if(angular.isArray(size)){resImgSizeArray=size.slice();size={w:parseInt(size[0].w,10),h:parseInt(size[0].h,10)};return}
if(angular.isUndefined(size)){return}
if(angular.isString(size)){resImgSize=size;return}
if(angular.isNumber(size)){size=parseInt(size,10);size={w:size,h:size}}
size={w:parseInt(size.w,10),h:parseInt(size.h,10)};if(!isNaN(size.w)&&!isNaN(size.h)){resImgSize=size;drawScene()}};this.setResultImageFormat=function(format){resImgFormat=format};this.setResultImageQuality=function(quality){quality=parseFloat(quality);if(!isNaN(quality)&&quality>=0&&quality<=1){resImgQuality=quality}};this.getAreaType=function(){return theArea.getType()};this.setAreaType=function(type){var center=theArea.getCenterPoint();var curSize=theArea.getSize(),curMinSize=theArea.getMinSize(),curX=center.x,curY=center.y;var AreaClass=CropAreaCircle;if(type==='square'){AreaClass=CropAreaSquare}else if(type==='rectangle'){AreaClass=CropAreaRectangle}
theArea=new AreaClass(ctx,events);theArea.setMinSize(curMinSize);theArea.setSize(curSize);if(type==='square'||type==='circle'){forceAspectRatio=!0;theArea.setForceAspectRatio(!0)}else{forceAspectRatio=!1;theArea.setForceAspectRatio(!1)}
theArea.setCenterPoint({x:curX,y:curY});if(image!==null){theArea.setImage(image)}
drawScene()};this.setPaletteColorLength=function(lg){colorPaletteLength=lg};this.setAspect=function(aspect){isAspectRatio=!0;theArea.setAspect(aspect);var minSize=theArea.getMinSize();minSize.w=minSize.h*aspect;theArea.setMinSize(minSize);var size=theArea.getSize();size.w=size.h*aspect;theArea.setSize(size)};ctx=elCanvas[0].getContext('2d');theArea=new CropAreaCircle(ctx,events);$document.on('mousemove',onMouseMove);elCanvas.on('mousedown',onMouseDown);$document.on('mouseup',onMouseUp);$document.on('touchmove',onMouseMove);elCanvas.on('touchstart',onMouseDown);$document.on('touchend',onMouseUp);elCanvas.prop('tabindex','0');elCanvas.on('keydown',onKeyDown);this.destroy=function(){$document.off('mousemove',onMouseMove);elCanvas.off('mousedown',onMouseDown);$document.off('mouseup',onMouseUp);$document.off('touchmove',onMouseMove);elCanvas.off('touchstart',onMouseDown);$document.off('touchend',onMouseUp);elCanvas.off('keydown',onKeyDown);elCanvas.remove()}}}]);angular.module('starter').factory('cropPubSub',[function(){return function(){var events={};this.on=function(names,handler){names.split(' ').forEach(function(name){if(!events[name]){events[name]=[]}
events[name].push(handler)});return this};this.trigger=function(name,args){angular.forEach(events[name],function(handler){handler.call(null,args)});return this}}}]);angular.module('starter').directive('uiCropper',['$timeout','cropHost','cropPubSub',function($timeout,CropHost,CropPubSub){return{restrict:'E',scope:{image:'=',resultImage:'=',resultArrayImage:'=?',resultBlob:'=?',urlBlob:'=?',chargement:'=?',cropject:'=?',maxCanvasDimensions:'=?',minCanvasDimensions:'=?',canvasScalemode:'@?',changeOnFly:'=?',disableKeyboardAccess:'=?',allowPropagation:'=?',liveView:'=?',initMaxArea:'=?',areaCoords:'=?',areaType:'@',areaMinSize:'=?',areaInitSize:'=?',areaInitCoords:'=?',areaInitIsRelativeToImage:'=?',areaMinRelativeSize:'=?',resultImageSize:'=?',resultImageFormat:'@',resultImageQuality:'=?',aspectRatio:'=?',allowCropResizeOnCorners:'=?',dominantColor:'=?',paletteColor:'=?',paletteColorLength:'=?',disableCrop:'=?',onChange:'&',onLoadBegin:'&',onLoadDone:'&',onLoadError:'&'},template:'<canvas></canvas>',controller:['$scope',function($scope){$scope.events=new CropPubSub()}],link:function(scope,element){var events=scope.events;var cropHost=new CropHost(element.find('canvas'),{disableKeyboardAccess:scope.disableKeyboardAccess,allowPropagation:scope.allowPropagation},events);if(scope.canvasScalemode){cropHost.setScalemode(scope.canvasScalemode)}else{cropHost.setScalemode('fixed-height')}
element.addClass(cropHost.getScalemode());var storedResultImage;var updateAreaCoords=function(scope){scope.areaCoords=cropHost.getAreaCoords()};var updateResultImage=function(scope,force,callback){if(scope.image!==''&&(!scope.liveView.block||force)){var resultImageObj=cropHost.getResultImage();var resultImage;if(angular.isArray(resultImageObj)){resultImage=resultImageObj[0].dataURI;scope.resultArrayImage=resultImageObj}else{resultImage=resultImageObj.dataURI}
var urlCreator=window.URL||window.webkitURL;if(storedResultImage!==resultImage){storedResultImage=resultImage;scope.resultImage=resultImage;if(scope.liveView.callback){scope.liveView.callback(resultImage)}
if(callback){callback(resultImage)}
cropHost.getResultImageDataBlob().then(function(blob){scope.resultBlob=blob;scope.urlBlob=blob?urlCreator.createObjectURL(blob):null});if(scope.resultImage){}
updateAreaCoords(scope);scope.onChange({$dataURI:scope.resultImage})}}};if(scope.liveView&&typeof scope.liveView.block==='boolean'){scope.liveView.render=function(callback){updateResultImage(scope,!0,callback)}}else{scope.liveView={block:!1}}
var updateCropject=function(scope){var areaCoords=cropHost.getAreaCoords();var dimRatio={x:cropHost.getArea().getImage().width/cropHost.getArea().getCanvasSize().w,y:cropHost.getArea().getImage().height/cropHost.getArea().getCanvasSize().h};scope.cropject={canvasSize:cropHost.getArea().getCanvasSize(),areaCoords:areaCoords,cropWidth:areaCoords.w,cropHeight:areaCoords.h,cropTop:areaCoords.y,cropLeft:areaCoords.x,cropImageWidth:Math.round(areaCoords.w*dimRatio.x),cropImageHeight:Math.round(areaCoords.h*dimRatio.y),cropImageTop:Math.round(areaCoords.y*dimRatio.y),cropImageLeft:Math.round(areaCoords.x*dimRatio.x)}};var fnSafeApply=function(fn){return function(){$timeout(function(){scope.$apply(function(scope){fn(scope)})})}};var printLoadMsg=function(){var language=window.navigator.userLanguage||window.navigator.language;switch(language){case 'nl':case 'nl_NL':return'Aan het laden';case 'fr':case 'fr-FR':return'Chargement';case 'es':case 'es-ES':return'Cargando';case 'ca':case 'ca-ES':return'Crrega';case 'de':case 'de-DE':return'Laden';case 'pt':case 'pt-BR':return'Carregando';default:return'Loading'}};if(!scope.chargement){scope.chargement=printLoadMsg()}
var displayLoading=function(){element.append('<div class="loading"><span>'+scope.chargement+'...</span></div>')};events.on('load-start',fnSafeApply(function(scope){scope.onLoadBegin({})})).on('load-done',fnSafeApply(function(scope){var children=element.children();angular.forEach(children,function(child){if(angular.element(child).hasClass('loading')){angular.element(child).remove()}});updateCropject(scope);scope.onLoadDone({})})).on('load-error',fnSafeApply(function(scope){scope.onLoadError({})})).on('area-move area-resize',fnSafeApply(function(scope){if(scope.changeOnFly===!0){updateResultImage(scope)}
updateCropject(scope)})).on('image-updated',fnSafeApply(function(scope){cropHost.setAreaMinRelativeSize(scope.areaMinRelativeSize)})).on('area-move-end area-resize-end image-updated',fnSafeApply(function(scope){updateResultImage(scope);updateCropject(scope)}));scope.$watch('image',function(newVal){var area=cropHost.getArea();if(area){cropHost.getArea()._size={x:0,y:0,w:0,h:0}}
if(newVal){displayLoading()}
if(scope.timeout!==null){$timeout.cancel(scope.timeout)}
scope.timeout=$timeout(function(){scope.timeout=null;cropHost.setInitMax(scope.initMaxArea);cropHost.setNewImageSource(scope.image)},100)});scope.$watch('areaType',function(){cropHost.setAreaType(scope.areaType);updateResultImage(scope)});scope.$watch('areaMinSize',function(){cropHost.setAreaMinSize(scope.areaMinSize);updateResultImage(scope)});scope.$watch('areaMinRelativeSize',function(){if(scope.image!==''){cropHost.setAreaMinRelativeSize(scope.areaMinRelativeSize);updateResultImage(scope)}});scope.$watch('areaInitSize',function(){cropHost.setAreaInitSize(scope.areaInitSize);updateResultImage(scope)});scope.$watch('areaInitCoords',function(){cropHost.setAreaInitCoords(scope.areaInitCoords);cropHost.areaInitIsRelativeToImage=scope.areaInitIsRelativeToImage;updateResultImage(scope)});scope.$watch('maxCanvasDimensions',function(){cropHost.setMaxCanvasDimensions(scope.maxCanvasDimensions)});scope.$watch('minCanvasDimensions',function(){cropHost.setMinCanvasDimensions(scope.minCanvasDimensions)});scope.$watch('resultImageFormat',function(){cropHost.setResultImageFormat(scope.resultImageFormat);updateResultImage(scope)});scope.$watch('resultImageQuality',function(){cropHost.setResultImageQuality(scope.resultImageQuality);updateResultImage(scope)});scope.$watch('resultImageSize',function(){cropHost.setResultImageSize(scope.resultImageSize);updateResultImage(scope)});scope.$watch('paletteColorLength',function(){cropHost.setPaletteColorLength(scope.paletteColorLength)});scope.$watch('aspectRatio',function(){if(typeof scope.aspectRatio==='string'&&scope.aspectRatio!==''){scope.aspectRatio=parseFloat(scope.aspectRatio)}
if(scope.aspectRatio){cropHost.setAspect(scope.aspectRatio)}});scope.$watch('allowCropResizeOnCorners',function(){if(scope.allowCropResizeOnCorners){cropHost.setAllowCropResizeOnCorners(scope.allowCropResizeOnCorners)}});scope.$watch('disableCrop',function(){cropHost.setDisableCrop(scope.disableCrop)});scope.$watch(function(){if(cropHost.getScalemode()==='fit'){return[element[0].clientWidth,element[0].clientHeight]}
if(cropHost.getScalemode()==='fixed-height'){return[element[0].clientWidth,element[0].clientHeight]}
if(cropHost.getScalemode()==='full-width'){return element[0].clientWidth}},function(value){if(cropHost.getScalemode()==='fit'){cropHost.setMaxDimensions(value[0],value[1]);updateResultImage(scope)}
if(cropHost.getScalemode()==='fixed-height'){if(value[0]>0&&value[1]>0){cropHost.setMaxDimensions(value[0],value[1]);updateResultImage(scope)}}
if(cropHost.getScalemode()==='full-width'){if(value>0){cropHost.setMaxDimensions(value)}}},!0);scope.$on('$destroy',function(){cropHost.destroy()})}}}]);Features.insertCSS(":root{--safe-area-inset-top:0;--safe-area-inset-right:0;--safe-area-inset-bottom:0;--safe-area-inset-left:0}@supports (padding-top:constant(safe-area-inset-top)){:root{--safe-area-inset-top:constant(safe-area-inset-top);--safe-area-inset-right:constant(safe-area-inset-right);--safe-area-inset-bottom:constant(safe-area-inset-bottom);--safe-area-inset-left:constant(safe-area-inset-left)}}@supports (padding-top:env(safe-area-inset-top)){:root{--safe-area-inset-top:env(safe-area-inset-top);--safe-area-inset-right:env(safe-area-inset-right);--safe-area-inset-bottom:env(safe-area-inset-bottom);--safe-area-inset-left:env(safe-area-inset-left)}}.platform-overview.platform-cordova{--safe-area-inset-top:1.5em;--safe-area-inset-right:0;--safe-area-inset-bottom:.5em;--safe-area-inset-left:0}.module-marketplace.marketplace-list-l1 .item.card{margin-top:0;margin-bottom:6px}.module-marketplace.marketplace-list-l1 .bar-subheader .button-bar>.button img{filter:grayscale(100%)}.module-marketplace.marketplace-list-l1 .bar-subheader .button-bar>.button img.fw-icon-header{height:24px;margin-top:8px}.module-marketplace.marketplace-list-l1 .bar-subheader .button-bar>.button i{filter:grayscale(100%)}.module-marketplace.marketplace-list-l1 .bar-subheader .button-bar>.button i.icon:before{font-size:24px}.module-marketplace.marketplace-list-l1 .bar-subheader .button-bar>.button:first-child{border-radius:0}.module-marketplace.marketplace-list-l1 .bar-subheader .button-bar>.button:last-child{border-radius:0}.module-marketplace.marketplace-list-l1 .bar-subheader .button-bar>.button:active img,.module-marketplace.marketplace-list-l1 .bar-subheader .button-bar>.button.fw-icon-selected img,.module-marketplace.marketplace-list-l1 .bar-subheader .button-bar>.button:active i,.module-marketplace.marketplace-list-l1 .bar-subheader .button-bar>.button.fw-icon-selected i{filter:grayscale(0)}.module-marketplace.marketplace-list-l1 .item .post-body{padding-top:10px;padding-bottom:10px}.module-marketplace.marketplace-list-l1 .item .post-body h2{padding:0 0 10px 0;font-weight:700}.module-marketplace.marketplace-list-l1 .item .post-body p{overflow:initial;text-overflow:initial;white-space:initial}.module-marketplace.marketplace-list-l1 .item .post-body p.subtitle{padding:8px 0}.module-marketplace.marketplace-list-l1 .item .post-author.item-avatar{padding-left:50px;min-height:50px}.module-marketplace.marketplace-list-l1 .item .post-author h2{font-weight:700;line-height:16px;height:16px;margin-top:3px}.module-marketplace.marketplace-list-l1 .item .post-author h2 i.icon{margin:0 0 0 12px;font-size:20px}.module-marketplace.marketplace-list-l1 .item .post-author h2 i.icon.icon-pin{transform:rotate(20deg)}.module-marketplace.marketplace-list-l1 .item .post-author .post-date{font-size:11px}.module-marketplace.marketplace-list-l1 .item .post-image{margin:0 -16px 0 -16px}.module-marketplace.marketplace-list-l1 .item .post-image img{display:block}.module-marketplace.marketplace-list-l1 .item .post-likes{padding-top:4px;padding-bottom:4px}.module-marketplace.marketplace-list-l1 .item .post-likes span{font-size:14px}.module-marketplace.marketplace-list-l1 .item .actions{padding-top:7px;padding-bottom:6px;font-weight:700}.module-marketplace.marketplace-list-l1 .item .post-likes~.post-actions{border-top:1px solid rgba(68,68,68,.2)}.module-marketplace.marketplace-list-l1 .item .actions{border-top:1px solid rgba(68,68,68,.2)}.module-marketplace.marketplace-list-l1 .item.card .post-likes~.actions{border-top:1px solid rgba(68,68,68,.2)}.module-marketplace.marketplace-list-l1 .item.card .actions{border-top:1px solid rgba(68,68,68,.2);text-align:left}.module-marketplace.fanwall-comment-l1 .item-comment .comment-date~.comment-image{margin-top:10px}.module-marketplace.fanwall-comment-l1 .item-comment .comment-author.item-avatar{padding-top:5px;padding-left:50px;min-height:50px}.module-marketplace.fanwall-comment-l1 .item-comment .comment-author i.icon{font-size:16px}.module-marketplace.fanwall-comment-l1 .item-comment .comment-author h2{font-weight:700;font-size:13px;line-height:15px}.module-marketplace.fanwall-comment-l1 .item-comment .comment-author p.comment-date{font-size:11px;line-height:11px}.module-marketplace.fanwall-comment-l1 .item-comment .comment-author p.comment-text{margin-top:10px;white-space:initial}.module-marketplace.fanwall-comment-l1 .item-comment .comment-author p.comment-text *{white-space:initial}.module-marketplace.fanwall-comment-l1 .item-comment .comment-image img{max-width:100%;max-height:140px;padding:3px;border:1px solid #c4c4c4;border-radius:6px}.module-marketplace.fanwall-comment-l1 .item-comment.card{margin-bottom:0;margin-top:12px}.module-marketplace.fanwall-comment-l1 .item-comment.card .comment-image img{border:1px solid #c4c4c4}.module-marketplace.fanwall-comment-l1 .item-comment.card .comment-author.item-avatar{padding-top:15px;padding-left:50px;padding-bottom:10px;min-height:50px}.module-marketplace.fanwall-comment-l1 .comment-footer .item-input-inset{width:100%}.module-marketplace.fanwall-comment-l1 .comment-footer .picture-badge{font-size:10px;padding:0 6px 0 5px;margin-left:-17px}.module-marketplace.fanwall-comment-l1 .comment-footer textarea{resize:none;margin:0;height:32px;width:100%;padding:8px 33px 7px 16px;border-radius:50px}.module-marketplace.fanwall-comment-l1 .comment-footer .clear-comment{font-size:26px;position:absolute;right:54px;opacity:.6}.module-marketplace.fanwall-new-l1 .post-button{position:fixed;bottom:0;z-index:100;margin:0!important}.module-marketplace.fanwall-new-l1 .post-author.item-avatar{padding-left:72px;min-height:50px}.module-marketplace.fanwall-new-l1 .post-author h2{font-weight:700;line-height:15px}.module-marketplace.fanwall-new-l1 .post-author h2 i.icon{margin:0 0 0 12px}.module-marketplace.fanwall-new-l1 .post-author h2 i.icon.icon-pin{transform:rotate(30deg)}.module-marketplace.fanwall-new-l1 .post-author .post-location{font-size:11px}.module-marketplace.fanwall-new-l1 .new-post-items .item{margin-top:12px;padding-top:15px;padding-bottom:15px;padding-right:15px}.module-marketplace.fanwall-new-l1 .new-post-items .item .new-post-author{margin-top:4px}.module-marketplace.fanwall-new-l1 .new-post-items .item label{width:100%}.module-marketplace.fanwall-new-l1 .new-post-items .item textarea{resize:none}.module-marketplace.fanwall-new-l1 .new-post-items .item.item-avatar{padding-left:72px;min-height:72px}.module-marketplace.fanwall-new-l1 .new-post-items .item.card{margin-top:0;margin-bottom:6px}.module-marketplace.fanwall-new-l1 .new-post-items .item.card:first-of-type{margin-top:12px!important}.module-marketplace.fanwall-new-l1 .remove-image-list,.module-marketplace.fanwall-new-l1 .remove-image-card{position:absolute;right:6px;top:6px}.module-marketplace.fanwall-new-l1 .remove-image-list i.icon,.module-marketplace.fanwall-new-l1 .remove-image-card i.icon{font-size:26px}.module-marketplace .fanwall-gallery{justify-content:flex-start;display:flex;flex-direction:row;flex-flow:row wrap}.module-marketplace .fanwall-gallery .gallery-item{background-position:center center;background-repeat:no-repeat;background-size:cover}.module-marketplace .fanwall-gallery .gallery-item img{width:100%}.module-marketplace .fanwall-gallery .gallery-item:nth-child(3n+1){width:32%;margin-top:2%}.module-marketplace .fanwall-gallery .gallery-item:nth-child(3n+2){width:32%;margin-left:2%;margin-right:2%;margin-top:2%}.module-marketplace .fanwall-gallery .gallery-item:nth-child(3n+3){width:32%;margin-top:2%}@media screen and (orientation:portrait){.module-marketplace .fanwall-map .info-window{width:100vw;position:absolute;bottom:0;padding:0 2vw}}@media screen and (orientation:landscape){.module-marketplace .fanwall-map .info-window{width:50vw;position:absolute;bottom:0;left:0;padding:0 2vw}}#baguetteBox-overlay{user-select:all;pointer-events:all}.fanwall-location-action:before{font-size:26px!important}.module-marketplace h3{padding:10px 10px;border-bottom:1px solid rgba(68,68,68,.2)}.module-marketplace .store-name{min-height:150px;padding:30px 0}.module-marketplace .store-name img{height:40px!important;left:12px;max-width:40px;max-height:40px;width:100%;height:100%;border-radius:50%}.module-marketplace .store-name h2{text-align:center}.module-marketplace .list .item-divider{margin-top:15px}.module-marketplace .item-custom .checkbox-custom{border:none!important}.module-marketplace .text-format{float:left;width:46%}.module-marketplace .numbered{float:left;margin-top:20px;font-weight:700;width:20px}.module-marketplace .remove-image-card.badge{padding:3px 6px!important}","marketplace")