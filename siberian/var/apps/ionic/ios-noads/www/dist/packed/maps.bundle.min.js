angular.module("starter").controller("MapsController",function($log,$window,$scope,$stateParams,Modal,Maps,GoogleMaps){angular.extend($scope,{is_loading:!0,value_id:$stateParams.value_id,error:!1,show_directions:!1,travel_mode:"DRIVING",show_instructions:!1,origin:{address:null,latitude:null,longitude:null},destination:{},card_design:!1}),Maps.setValueId($stateParams.value_id),$scope.disableTap=function(input_id){var container=angular.element(document.getElementsByClassName("pac-container"));container.attr("data-tap-disabled","true"),container.on("click",function(){$log.debug(input_id),document.getElementById(input_id).blur()})},$scope.loadContent=function(){Maps.find().then(function(data){if($scope.is_loading=!1,$scope.page_title=data.page_title,$scope.icon_url=data.icon_url,data.collection.latitude&&data.collection.longitude){switch($scope.destination={latitude:data.collection.latitude,longitude:data.collection.longitude,address:data.collection.address},data.collection.unit){case"km":$scope.unit_system=google.maps.UnitSystem.METRIC;break;default:$scope.unit_system=google.maps.UnitSystem.IMPERIAL}$scope.map||($scope.map=GoogleMaps.createMap("google-maps"),GoogleMaps.setPanelId("panel")),$scope.getRoute(null)}else $scope.is_loading=!1,$scope.error=!0})},$scope.getRoute=function(origin){$scope.is_loading=!0,$scope.error=!1;var params={mode:$scope.travel_mode,unitSystem:$scope.unit_system};GoogleMaps.calculateRoute(origin,$scope.destination,params).then(function(route){GoogleMaps.addRoute(route),route.routes[0]&&(route.routes[0].legs[0].duration.text&&($scope.duration=route.routes[0].legs[0].duration.text),route.routes[0].legs[0].distance.text&&($scope.distance=route.routes[0].legs[0].distance.text)),$scope.origin.latitude=route.request.origin.lat(),$scope.origin.longitude=route.request.origin.lng(),$scope.is_loading=!1},function(err){if("gps_disabled"===err){var bounds=GoogleMaps.getBoundsFromPoints([$scope.destination,$scope.destination.address]);GoogleMaps.setCenter(bounds),$scope.destination.title=$scope.destination.address,GoogleMaps.addMarker([$scope.destination])}else $scope.error=!0,$scope.err_message=err;$scope.is_loading=!1})},$scope.openPanel=function(){$scope.map&&Modal.fromTemplateUrl("maps-info.html",{scope:$scope}).then(function(modal){$scope.panel=modal,$scope.panel_content=document.getElementById("panel").outerHTML,$scope.panel.show()})},$scope.closePanel=function(){$scope.panel.remove()},$scope.changeTravelMode=function(mode){if($scope.travel_mode!==mode){switch(mode){case"WALKING":$scope.travel_mode=google.maps.TravelMode.WALKING;break;case"DRIVING":$scope.travel_mode=google.maps.TravelMode.DRIVING;break;case"TRANSIT":$scope.travel_mode=google.maps.TravelMode.TRANSIT}$scope.is_loading=!0,$scope.getRoute($scope.origin)}},$scope.changeItinerary=function(){$scope.origin.address?$scope.getRoute($scope.origin):$scope.getRoute(null)},GoogleMaps.addCallback($scope.loadContent)}),angular.module("starter").factory("Maps",function($pwaRequest){var factory={value_id:null,setValueId:function(value_id){factory.value_id=value_id},find:function(){this.value_id||$pwaRequest.reject("[Factory::Maps.find] missing value_id");var payload=$pwaRequest.getPayloadForValueId(factory.value_id);return!1!==payload?$pwaRequest.resolve(payload):$pwaRequest.get("maps/mobile_view/find",{urlParams:{value_id:this.value_id}})}};return factory});