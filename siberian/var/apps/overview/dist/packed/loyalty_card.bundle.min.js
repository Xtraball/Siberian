angular.module("starter").controller("LoyaltyViewController",function(Codescan,Modal,$rootScope,$scope,$state,$stateParams,$timeout,$translate,$window,Application,Customer,Dialog,LoyaltyCard,Url,SB,Tc,Pages,Loader){angular.extend($scope,{is_loading:!1,value_id:$stateParams.value_id,is_logged_in:Customer.isLoggedIn(),is_card:!0,card_design:!1}),$scope.$on(SB.EVENTS.AUTH.loginSuccess,function(){$scope.is_logged_in=!0,$scope.loadContent(!0)}),$scope.$on(SB.EVENTS.AUTH.logoutSuccess,function(){$scope.is_logged_in=!1,$scope.loadContent(!0)}),LoyaltyCard.setValueId($stateParams.value_id),$scope.unlock_by_qrcode=!0,$scope.pad={password:"",points:[],number_of_points:0,add:function(nbr){return this.password.length<4&&(this.password+=nbr,4===this.password.length&&$scope.validate()),this},remove:function(){return this.password=this.password.substr(0,this.password.length-1),this}},$scope.loadContent=function(refresh){Loader.show(),$scope.is_loading=!0;var localRefresh=!1;$rootScope.isOnline&&(localRefresh=!0),LoyaltyCard.findAll(localRefresh).then(function(data){return $scope.promotions=data.promotions,$scope.card=data.card,$scope.pictos=data.picto_urls,$scope.card_is_locked=data.card_is_locked,$scope.points=data.points,$scope.page_title=data.page_title,$scope.tc_id=data.tc_id,$scope.is_card=!1!==$scope.card.id,data}).then(function(data){Loader.hide(),$scope.is_loading=!1,Tc.find(data.tc_id)})},$scope.openPad=function(card){if(Customer.isLoggedIn()){$scope.pad.modal={},$scope.pad.password="",$scope.pad.points=[],$scope.pad.buttons=[],$scope.pad.mode_qrcode=!1;for(var i=1;i<10;i++)$scope.pad.buttons.push(i);$scope.pad.buttons.push(0),$scope.pad.card=card,$scope.pad.number_of_points=1,$scope.page_title=$scope.pad_title,""!==$scope.page_title&&void 0!==$scope.page_title||($scope.page_title="Enter password");var remaining=card.max_number_of_points-card.number_of_points,points=[];for(i=0;i<=remaining-1;i+=1)points[i]=i+1;(isNaN(remaining)||0===remaining)&&($scope.page_title="Use this coupon"),$scope.pad.points=points,Modal.fromTemplateUrl("templates/loyalty-card/l1/pad.html",{scope:$scope}).then(function(modal){$scope.pad.modal=modal,$scope.pad.modal.show()})}else Customer.loginModal($scope)},$scope.closePad=function(){$scope.pad.modal.hide()},$scope.$on("$destroy",function(){$scope.pad.modal&&$scope.pad.modal.hide()}),$scope.validate=function(){$scope.is_loading=!0,LoyaltyCard.validate($scope.pad).then(function(data){data&&data.message&&Dialog.alert("Success",data.message,"OK",-1).then(function(){if(data.close_pad?$scope.closePad():$scope.pad.password="",data.number_of_points)$scope.card.number_of_points=data.number_of_points;else if(data.promotion_id_to_remove)for(var i in $scope.promotions)$scope.promotions[i].id==data.promotion_id_to_remove&&$scope.promotions.splice(i,1);return data.customer_card_id&&($scope.card.id=data.customer_card_id),!0}).then(function(){Pages.refresh(),$scope.loadContent(!0)})},function(data){data&&data.message&&Dialog.alert("Error",data.message,"OK",-1).then(function(){data.close_pad?($scope.closePad(),data.card_is_locked&&($scope.card_is_locked=!0)):$scope.pad.password=""}),data.customer_card_id&&($scope.card.id=data.customer_card_id)}).then(function(){$scope.is_loading=!1})},$scope.login=function(){Customer.loginModal($scope)},$scope.openScanCamera=function(){Codescan.scanPassword().then(function(rawText){$scope.pad.password=rawText.replace("sendback:",""),$scope.pad.mode_qrcode=!0,$scope.validate()},function(error){Dialog.alert("Error","Something went wrong while reading the QRCode.","OK",-1,"loyalty_card")})},$scope.isOverview&&($window.prepareDummy=function(){$timeout(function(){$scope.card={id:-1,is_visible:!0},$scope.points=[]})},$window.setAttributeToDummy=function(attribute,value){$timeout(function(){$scope.card[attribute]=value})},$window.setNumberOfPoints=function(nbr){$timeout(function(){for(var points=[],i=0;i<nbr;i++)points.push({is_validated:!1,image_url:$scope.pictos.normal_url});$scope.card.max_number_of_points=nbr,$scope.points=points})},$scope.$on("$destroy",function(){$window.prepareDummy=null,$window.setAttributeToDummy=null,$window.setNumberOfPoints=null})),$scope.showTc=function(){$state.go("tc-view",{tc_id:$scope.tc_id})},$scope.loadContent()}),angular.module("starter").factory("LoyaltyCard",function($pwaRequest){var factory={value_id:null,extendedOptions:{},setValueId:function(value_id){factory.value_id=value_id},setExtendedOptions:function(options){factory.extendedOptions=options},findAll:function(refresh){if(!this.value_id)return $pwaRequest.reject("[Factory::LoyaltyCard.findAll] missing value_id");var payload=$pwaRequest.getPayloadForValueId(factory.value_id);return!1!==payload?$pwaRequest.resolve(payload):$pwaRequest.get("loyaltycard/mobile_view/findall",angular.extend({urlParams:{value_id:this.value_id},refresh:refresh},factory.extendedOptions))},validate:function(pad){return this.value_id?$pwaRequest.post("loyaltycard/mobile_view/validate",{urlParams:{value_id:this.value_id},data:{customer_card_id:pad.card.id,number_of_points:pad.number_of_points,password:pad.password,mode_qrcode:pad.mode_qrcode},cache:!1}):$pwaRequest.reject("[Factory::LoyaltyCard.validate] missing value_id")}};return factory});